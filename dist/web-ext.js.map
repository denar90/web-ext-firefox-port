{"version":3,"sources":["webpack:///webpack/bootstrap","webpack:///./node_modules/@babel/runtime/helpers/defineProperty.js","webpack:///./node_modules/@babel/runtime/helpers/objectSpread.js","webpack:///./node_modules/@cliqz-oss/firefox-client/index.js","webpack:///./node_modules/@cliqz-oss/firefox-client/lib/browser.js","webpack:///./node_modules/@cliqz-oss/firefox-client/lib/client-methods.js","webpack:///./node_modules/@cliqz-oss/firefox-client/lib/client.js","webpack:///./node_modules/@cliqz-oss/firefox-client/lib/console.js","webpack:///./node_modules/@cliqz-oss/firefox-client/lib/device.js","webpack:///./node_modules/@cliqz-oss/firefox-client/lib/dom.js","webpack:///./node_modules/@cliqz-oss/firefox-client/lib/domnode.js","webpack:///./node_modules/@cliqz-oss/firefox-client/lib/extend.js","webpack:///./node_modules/@cliqz-oss/firefox-client/lib/jsobject.js","webpack:///./node_modules/@cliqz-oss/firefox-client/lib/memory.js","webpack:///./node_modules/@cliqz-oss/firefox-client/lib/network.js","webpack:///./node_modules/@cliqz-oss/firefox-client/lib/simulator.js","webpack:///./node_modules/@cliqz-oss/firefox-client/lib/stylesheets.js","webpack:///./node_modules/@cliqz-oss/firefox-client/lib/tab.js","webpack:///./node_modules/@cliqz-oss/firefox-client/lib/webapps.js","webpack:///./node_modules/@cliqz-oss/node-firefox-connect/index.js","webpack:///./src/cmd/build.js","webpack:///./src/cmd/docs.js","webpack:///./src/cmd/index.js","webpack:///./src/cmd/lint.js","webpack:///./src/cmd/run.js","webpack:///./src/cmd/sign.js","webpack:///./src/config.js","webpack:///./src/errors.js","webpack:///./src/extension-runners/firefox-android.js","webpack:///./src/extension-runners/firefox-desktop.js","webpack:///./src/extension-runners/index.js","webpack:///./src/firefox/index.js","webpack:///./src/firefox/preferences.js","webpack:///./src/firefox/remote.js","webpack:///./src/main.js","webpack:///./src/program.js","webpack:///./src/util/adb.js","webpack:///./src/util/artifacts.js","webpack:///./src/util/desktop-notifier.js","webpack:///./src/util/file-exists.js","webpack:///./src/util/file-filter.js","webpack:///./src/util/is-directory.js","webpack:///./src/util/logger.js","webpack:///./src/util/manifest.js","webpack:///./src/util/stdin.js","webpack:///./src/util/temp-dir.js","webpack:///./src/util/updates.js","webpack:///./src/util/zip-dir.js","webpack:///./src/watcher.js","webpack:///external \"adbkit\"","webpack:///external \"addons-linter\"","webpack:///external \"bunyan\"","webpack:///external \"camelcase\"","webpack:///external \"child_process\"","webpack:///external \"colors\"","webpack:///external \"debounce\"","webpack:///external \"decamelize\"","webpack:///external \"es6-error\"","webpack:///external \"es6-promise\"","webpack:///external \"es6-promisify\"","webpack:///external \"event-to-promise\"","webpack:///external \"events\"","webpack:///external \"firefox-profile\"","webpack:///external \"fs\"","webpack:///external \"fx-runner\"","webpack:///external \"git-rev-sync\"","webpack:///external \"js-select\"","webpack:///external \"mkdirp\"","webpack:///external \"multimatch\"","webpack:///external \"mz\"","webpack:///external \"net\"","webpack:///external \"node-notifier\"","webpack:///external \"opn\"","webpack:///external \"os\"","webpack:///external \"parse-json\"","webpack:///external \"path\"","webpack:///external \"readline\"","webpack:///external \"require-uncached\"","webpack:///external \"sign-addon\"","webpack:///external \"strip-json-comments\"","webpack:///external \"tmp\"","webpack:///external \"update-notifier\"","webpack:///external \"watchpack\"","webpack:///external \"yargs\"","webpack:///external \"zip-dir\""],"names":["log","createLogger","__filename","safeFileName","name","toLowerCase","replace","getDefaultLocalizedName","messageFile","manifestData","messageData","messageContents","extensionName","fs","readFile","encoding","error","UsageError","parseJSON","stripJsonComments","match","messageName","message","Promise","resolve","defaultPackageCreator","sourceDir","fileFilter","artifactsDir","overwriteDest","showReadyMessage","eventToPromise","defaultEventToPromise","id","getManifestId","debug","getValidatedManifest","buffer","zipDir","filter","args","wantFile","default_locale","path","join","packageName","version","extensionPath","stream","createWriteStream","flags","write","end","isErrorWithCode","info","build","asNeeded","ignoreFiles","createFileFilter","defaultFileFilterCreator","onSourceChange","defaultSourceWatcher","packageCreator","rebuildAsNeeded","createPackage","prepareArtifactsDir","result","onChange","catch","stack","shouldWatchFile","url","docs","params","openUrl","opn","reject","options","default","runCommand","require","lint","run","sign","boring","metadata","output","pretty","selfHosted","verbose","warningsAsErrors","createLinter","defaultLinterCreator","shouldExitProgram","linter","config","logLevel","Boolean","shouldScanFile","fileName","_","runAsBinary","browserConsole","pref","firefox","firefoxProfile","firefoxPort","keepProfileChanges","noInput","noReload","preInstall","startUrl","target","adbBin","adbHost","adbPort","adbDevice","firefoxApk","buildExtension","defaultBuildExtension","desktopNotifications","defaultDesktopNotifications","firefoxApp","defaultFirefoxApp","firefoxClient","defaultFirefoxClient","reloadStrategy","defaultReloadStrategy","MultiExtensionRunner","DefaultMultiExtensionRunner","defaultGetValidatedManifest","customPrefs","runners","commonRunnerParams","extensions","length","includes","firefoxDesktopRunnerParams","firefoxBinary","profilePath","firefoxDesktopRunner","createExtensionRunner","push","firefoxAndroidRunnerParams","buildSourceDir","extensionSourceDir","tmpArtifactsDir","firefoxAndroidRunner","extensionRunner","defaultAsyncFsReadFile","bind","extensionIdFile","apiKey","apiProxy","apiSecret","apiUrlPrefix","timeout","channel","defaultBuilder","preValidatedManifest","signAddon","defaultAddonSigner","withTempDir","tmpDir","buildResult","idFromSourceDir","all","getIdFromSourceDir","manifestId","warn","signingResult","xpiPath","downloadDir","saveIdToSourceDir","success","WebExtError","asyncFsReadFile","filePath","content","lines","toString","split","line","trim","startsWith","writeFile","applyConfigToArgv","argv","argvFromCLI","configObject","configFileName","newArgv","option","Object","keys","camelCase","Array","isArray","decamelizedOptName","decamelize","type","undefined","expectedType","optionType","defaultValue","wasValueSetOnCLI","coerce","loadJSConfigFile","resolvedFilePath","requireUncached","endsWith","webExt","discoverConfigFiles","getHomeDir","os","homedir","magicConfigName","possibleConfigs","process","cwd","configs","map","resolvedFileName","fileExists","existingConfigs","forEach","f","ExtendableError","constructor","InvalidManifest","RemoteTempInstallNotSupported","MultiExtensionsReloadError","errorsMap","errors","msg","String","errorsBySourceDir","onlyInstancesOf","predicate","errorHandler","onlyErrorsWithCode","codeWanted","throwError","indexOf","code","errno","FirefoxAndroidExtensionRunner","cleanupCallbacks","Set","adbExtensionsPathBySourceDir","Map","reloadableExtensions","printIgnoredParamsWarnings","ADBUtils","DefaultADBUtils","adbUtils","adbDevicesDiscoveryAndSelect","apkPackagesDiscoveryAndSelect","adbCheckRuntimePermissions","adbForceStopSelectedPackage","adbPrepareProfileDir","adbStartSelectedPackage","buildAndPushExtensions","adbDiscoveryAndForwardRDPUnixSocket","rdpInstallExtensions","getName","reloadAllExtensions","runnerName","reloadErrors","res","reloadExtensionBySourceDir","reloadError","Error","set","size","addonId","get","buildAndPushExtension","remoteFirefox","reloadAddon","registerCleanup","fn","add","exit","selectedAdbDevice","selectedArtifactsDir","exiting","clearArtifactsDir","getDeviceProfileDir","devices","discoverDevices","devicesMsg","dev","foundDevices","device","JSON","stringify","packages","discoverInstalledFirefoxAPKs","pkgsListMsg","pkgs","pkg","selectedFirefoxApk","filteredPackages","pkgsList","amForceStopAPK","androidVersion","getAndroidVersionNumber","Number","isNaN","ensureRequiredAPKRuntimePermissions","profile","createProfile","app","getOrCreateArtifactsDir","deviceProfileDir","runShellCommand","pushFile","profileDir","startFirefoxAPK","extFileName","basename","adbExtensionPath","firefoxAndroidTimeout","stdin","unixSocketDiscoveryRetryInterval","unixSocketDiscoveryMaxTime","handleCtrlC","str","key","ctrl","setUserAbortDiscovery","isTTY","readline","emitKeypressEvents","setRawMode","on","selectedRDPSocketFile","discoverRDPUnixSocket","maxDiscoveryTime","retryInterval","removeListener","tcpPort","chooseLocalTcpPort","forwardSocketSpec","substr","setupForward","selectedTCPPort","srv","net","createServer","listen","freeTcpPort","address","port","close","client","extension","installTemporaryAddon","then","installResult","addon","FirefoxDesktopExtensionRunner","setupProfileDir","startFirefoxInstance","runningInfo","kill","useProfile","copyProfile","installExtension","asProxy","runCleanup","cleanupCb","debuggerPort","stderr","EventEmitter","stdout","binaryArgs","urls","extensionRunners","promises","runner","reloadPromise","results","handleReloadResults","cleanupCallback","title","defaultWatcherCreator","reloadExtension","file","createWatcher","allowInput","watcher","watchedSourceDir","pause","keypressUsageInfo","userExit","keyPressed","once","pid","defaultAsyncFsStat","stat","defaultFirefoxEnv","XPCOM_DEBUG_BREAK","NS_TRACE_MALLOC_DISABLE_STACKS","defaultRemotePortFinder","portToTry","REMOTE_PORT","retriesLeft","connectToFirefox","defaultFirefoxConnector","disconnect","fxRunner","defaultFxRunner","findRemotePort","remotePort","env","binary","data","DEFAULT_PROFILES_NAMES","isDefaultProfile","profilePathOrName","ProfileFinder","FirefoxProfile","Finder","fsStat","baseProfileDir","locateUserDirectory","profilesIniPath","finder","readProfiles","promisify","normalizedProfileDirPath","normalize","sep","profiles","Name","Default","profileFullPath","IsRelative","Path","configureProfile","getPrefs","defaultPrefGetter","prefs","setPreference","customPrefsStr","custom","updatePreferences","defaultCreateProfileFinder","userDirectoryPath","FxProfile","getPath","profileName","hasProfileName","profileDef","configureThisProfile","isFirefoxDefaultProfile","createProfileFinder","isForbiddenProfile","destinationDirectory","getProfilePath","profileIsDirPath","isDirectory","profileDirectory","copyFromUserProfile","defaultUserProfileCopier","copy","copyByName","dirExists","asyncFsStat","extensionsDir","mkdir","isDir","destPath","writeStream","nodeFs","readStream","createReadStream","pipe","nonOverridablePreferences","prefsCommon","prefsFennec","prefsFirefox","common","fennec","appPrefs","coerceCLICustomPreference","cliPrefs","prefsAry","value","slice","test","parseInt","RemoteFirefox","checkedForAddonReloading","addonRequest","request","makeRequest","to","actor","response","addonPath","tabsResponse","addonsActor","installResponse","getInstalledAddon","addons","a","checkForAddonReloading","requestTypes","supportedRequestTypes","Date","toTimeString","connect","connectWithMaxRetries","maxRetries","establishConnection","lastError","retries","setTimeout","util","logger","main","cmd","envPrefix","Program","absolutePackageDir","yargsInstance","yargs","verboseEnabled","parserConfiguration","strict","commands","command","description","executor","commandOptions","yargsForCmd","demandCommand","exitProcess","setGlobalOptions","global","demandOption","enableVerboseMode","logStream","makeVerbose","execute","checkForUpdates","defaultUpdateChecker","systemProcess","defaultLogStream","getVersion","defaultVersionGetter","defaultApplyConfigToArgv","defaultConfigDiscovery","defaultLoadJSConfigFile","globalEnv","WEBEXT_BUILD_ENV","adjustedArgv","configFiles","configDiscovery","noConfigDiscovery","discoveredConfigs","niceFileList","packageData","readFileSync","parse","git","branch","long","defaultCommands","runOptions","program","usage","help","alias","describe","requiresArg","demand","choices","wrapADBCall","asyncFn","adb","defaultADB","adbClient","createClient","bin","host","artifactsDirMap","userAbortDiscovery","deviceId","shell","readAll","listDevices","pmList","androidVersionNumber","apk","permissions","permissionsMap","perm","pmDumpLogs","now","testDirOut","delete","localPath","devicePath","transfer","startActivity","wait","action","component","extras","rdpUnixSockets","discoveryStartedAt","pop","remote","local","forward","defaultAsyncMkdirp","mkdirp","defaultAsyncFsAccess","access","asyncMkdirp","asyncFsAccess","stats","W_OK","accessErr","mkdirErr","defaultLog","showDesktopNotification","icon","notifier","defaultNotifier","notify","err","fileIsReadable","constants","R_OK","isFile","isSubPath","src","relate","relative","FileFilter","baseIgnoredPatterns","filesToIgnore","addToIgnoreList","resolveWithSourceDir","resolvedPath","files","charAt","resolvedFile","matches","multimatch","ConsoleStream","isCapturing","capturedMessages","format","level","prefix","nameFromLevel","packet","localProcess","thisLevel","bunyan","TRACE","INFO","startCapturing","stopCapturing","flushCapturedLogs","consoleStream","filename","createBunyanLog","defaultLogCreator","streams","manifestFile","manifestContents","applications","gecko","rawMode","makePromise","TempDir","create","successHandler","_path","_removeTempDir","createTempDir","tmp","dir","multiArgs","unsafeCleanup","tmpPath","removeTempDir","remove","promiseResult","updateNotifier","defaultUpdateNotifier","updateCheckInterval","zipDirModule","Watchpack","executeImmediately","debounce","proxyFileChanges","watch"],"mappings":";;;AAAA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;;;AAGA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA,kDAA0C,gCAAgC;AAC1E;AACA;;AAEA;AACA;AACA;AACA,gEAAwD,kBAAkB;AAC1E;AACA,yDAAiD,cAAc;AAC/D;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,iDAAyC,iCAAiC;AAC1E,wHAAgH,mBAAmB,EAAE;AACrI;AACA;;AAEA;AACA;AACA;AACA,mCAA2B,0BAA0B,EAAE;AACvD,yCAAiC,eAAe;AAChD;AACA;AACA;;AAEA;AACA,8DAAsD,+DAA+D;;AAErH;AACA;;;AAGA;AACA;;;;;;;;;;;;AClFA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,KAAK;AACL,GAAG;AACH;AACA;;AAEA;AACA;;AAEA,iC;;;;;;;;;;;ACfA,qBAAqB,mBAAO,CAAC,iFAAkB;;AAE/C;AACA,iBAAiB,sBAAsB;AACvC;AACA;;AAEA;AACA;AACA;AACA,OAAO;AACP;;AAEA;AACA;AACA,KAAK;AACL;;AAEA;AACA;;AAEA,+B;;;;;;;;;;;ACrBA,iBAAiB,mBAAO,CAAC,8EAAe,E;;;;;;;;;;;ACAxC,aAAa,mBAAO,CAAC,wEAAU;AAC/B,oBAAoB,mBAAO,CAAC,wFAAkB;AAC9C,aAAa,mBAAO,CAAC,wEAAU;AAC/B,UAAU,mBAAO,CAAC,kEAAO;AACzB,cAAc,mBAAO,CAAC,0EAAW;AACjC,aAAa,mBAAO,CAAC,wEAAU;AAC/B,oBAAoB,mBAAO,CAAC,8EAAa;;AAEzC;AACA;;AAEA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA,KAAK;AACL,GAAG;;AAEH;AACA;AACA,GAAG;;AAEH;AACA;AACA,GAAG;;AAEH;AACA;AACA,GAAG;;AAEH;AACA;AACA,GAAG;;AAEH;AACA;AACA;AACA;AACA,KAAK;AACL,GAAG;;AAEH;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,SAAS;AACT;AACA;AACA,KAAK;AACL,GAAG;;AAEH;AACA;AACA;AACA;AACA;AACA;AACA;AACA,KAAK;AACL,GAAG;;AAEH;AACA;AACA;AACA;AACA;AACA;AACA;AACA,KAAK;AACL,GAAG;;AAEH;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,KAAK;AACL;AACA,CAAC;;;;;;;;;;;;AC1HD,aAAa,mBAAO,CAAC,sBAAQ;AAC7B,aAAa,mBAAO,CAAC,wEAAU;;AAE/B;AACA;;AAEA;AACA;AACA;AACA;AACA,cAAc,OAAO;AACrB;AACA,cAAc,OAAO;AACrB;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA,KAAK;AACL,GAAG;;AAEH;AACA;AACA;AACA,cAAc,OAAO;AACrB;AACA,cAAc,OAAO;AACrB;AACA,cAAc,SAAS;AACvB;AACA;AACA,cAAc,SAAS;AACvB;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA,KAAK;AACL,GAAG;;AAEH;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,iBAAiB,mBAAO,CAAC,4EAAY;AACrC;AACA;AACA;AACA;AACA;AACA,GAAG;;AAEH;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,CAAC;;AAED,+B;;;;;;;;;;;AClHA,UAAU,mBAAO,CAAC,gBAAK;AACvB,aAAa,mBAAO,CAAC,sBAAQ;AAC7B,aAAa,mBAAO,CAAC,wEAAU;;AAE/B,aAAa,mBAAO,CAAC,sBAAQ;;AAE7B;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA,KAAK;;AAEL;AACA;AACA;AACA;AACA;AACA,GAAG;;AAEH;AACA;AACA;AACA;AACA,GAAG;;AAEH;AACA;AACA;AACA;AACA;AACA,aAAa,OAAO;AACpB;AACA,aAAa,SAAS;AACtB;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA,gCAAgC;AAChC;AACA,qDAAqD;AACrD;AACA,GAAG;;AAEH;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA,KAAK;AACL,GAAG;;AAEH;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA,GAAG;;AAEH;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,GAAG;;AAEH;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,GAAG;;AAEH;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA,GAAG;;AAEH;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;;AAEA;AACA;AACA;AACA,KAAK;AACL;AACA;AACA;AACA;;AAEA;AACA,GAAG;;AAEH;AACA;AACA;AACA;AACA,GAAG;;AAEH;AACA;AACA;AACA,GAAG;;AAEH;AACA;AACA;AACA,GAAG;;AAEH;AACA;AACA;AACA;AACA;AACA,CAAC;;;;;;;;;;;;ACtPD,aAAa,mBAAO,CAAC,4BAAW;AAChC,aAAa,mBAAO,CAAC,wEAAU;AAC/B,oBAAoB,mBAAO,CAAC,wFAAkB;AAC9C,eAAe,mBAAO,CAAC,4EAAY;;AAEnC;;AAEA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA,oCAAoC,wBAAwB;AAC5D,GAAG;;AAEH;AACA;AACA;AACA;AACA;AACA,mCAAmC,wBAAwB;AAC3D,GAAG;;AAEH;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA,GAAG;;AAEH;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,GAAG;;AAEH;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,KAAK;AACL,GAAG;;AAEH;AACA;AACA;AACA;AACA;AACA;AACA,GAAG;;AAEH;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,gCAAgC,aAAa;AAC7C;AACA;AACA,KAAK;AACL,GAAG;;AAEH;AACA;AACA;AACA,CAAC;;;;;;;;;;;;AC1GD,aAAa,mBAAO,CAAC,wEAAU;AAC/B,oBAAoB,mBAAO,CAAC,wFAAkB;;AAE9C;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA,KAAK;AACL,GAAG;AACH;AACA;AACA;AACA;AACA;;AAEA;AACA,KAAK;AACL;AACA,CAAC;;;;;;;;;;;;AC5BD,aAAa,mBAAO,CAAC,wEAAU;AAC/B,oBAAoB,mBAAO,CAAC,wFAAkB;AAC9C,WAAW,mBAAO,CAAC,0EAAW;;AAE9B;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA,KAAK;AACL,GAAG;;AAEH;AACA;AACA;AACA;AACA,KAAK;AACL,GAAG;;AAEH;AACA;AACA;;AAEA;AACA,KAAK;AACL,GAAG;;AAEH;AACA;AACA;;AAEA;AACA,KAAK;AACL,GAAG;;AAEH;AACA,sCAAsC,mBAAmB;AACzD;AACA,GAAG;;AAEH;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA,GAAG;;AAEH;AACA,yCAAyC,+BAA+B;AACxE,GAAG;;AAEH;AACA;AACA;AACA,KAAK;AACL,GAAG;;AAEH;AACA;AACA;AACA;AACA;AACA;AACA;AACA,KAAK;AACL,GAAG;;AAEH;AACA;AACA;;AAEA;AACA,KAAK;AACL,GAAG;;AAEH;AACA;AACA;AACA;AACA;AACA;AACA;AACA,KAAK;AACL;AACA,CAAC;;AAED;AACA;;AAEA;AACA;;AAEA,2CAA2C;;AAE3C;AACA;AACA;;AAEA,0CAA0C;;;;;;;;;;;;AChH1C,aAAa,mBAAO,CAAC,wEAAU;AAC/B,oBAAoB,mBAAO,CAAC,wFAAkB;;AAE9C;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA,GAAG;;AAEH;AACA;AACA;AACA,GAAG;AACH;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,GAAG;;AAEH;AACA;AACA;AACA;AACA,KAAK;AACL,sCAAsC,sBAAsB;AAC5D,GAAG;;AAEH;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,KAAK;AACL,GAAG;;AAEH;AACA;AACA,GAAG;;AAEH;AACA;AACA,GAAG;;AAEH;AACA;AACA,GAAG;;AAEH;AACA;AACA,GAAG;;AAEH;AACA;AACA,GAAG;;AAEH;AACA,uCAAuC,qBAAqB;AAC5D;AACA,GAAG;;AAEH;AACA,0CAA0C,qBAAqB;AAC/D;AACA,GAAG;;AAEH;AACA;AACA,GAAG;;AAEH;AACA;AACA;AACA,KAAK;AACL,GAAG;;AAEH;AACA;AACA;AACA,KAAK;AACL,GAAG;;AAEH;AACA;AACA;AACA,KAAK;AACL,GAAG;;AAEH;AACA;AACA,GAAG;;AAEH;AACA;AACA,GAAG;;AAEH;AACA;AACA;AACA;AACA;AACA,GAAG;;AAEH;AACA;AACA;AACA,KAAK;AACL,GAAG;;AAEH;AACA;AACA,GAAG;;AAEH;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA,CAAC;;AAED;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,2BAA2B,yBAAyB;AACpD;AACA,GAAG;;AAEH;AACA;AACA;AACA;AACA,KAAK;AACL;AACA,CAAC;;;;;;;;;;;;AC5KD;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA,GAAG,IAAI;AACP,C;;;;;;;;;;;ACXA,aAAa,mBAAO,CAAC,4BAAW;AAChC,aAAa,mBAAO,CAAC,wEAAU;AAC/B,oBAAoB,mBAAO,CAAC,wFAAkB;;AAE9C;;AAEA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA,GAAG;;AAEH;AACA;AACA,GAAG;;AAEH;AACA;AACA,GAAG;;AAEH;AACA;AACA;AACA,KAAK;AACL,GAAG;;AAEH;AACA,8BAA8B,aAAa;AAC3C;AACA,KAAK;AACL,GAAG;;AAEH;AACA;AACA;AACA,KAAK;AACL,GAAG;;AAEH;AACA;AACA;AACA,KAAK;AACL,GAAG;;AAEH;AACA;AACA;AACA;AACA;;AAEA;AACA,KAAK;AACL,GAAG;;AAEH;AACA;AACA;AACA;AACA;AACA;AACA;AACA,GAAG;;AAEH;AACA;AACA;AACA;AACA;AACA;AACA,GAAG;;AAEH;AACA;AACA;AACA,GAAG;;AAEH;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,CAAC,C;;;;;;;;;;;AC1FD,aAAa,mBAAO,CAAC,wEAAU;AAC/B,oBAAoB,mBAAO,CAAC,wFAAkB;;AAE9C;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA,KAAK;AACL;AACA,CAAC;;;;;;;;;;;;ACfD,aAAa,mBAAO,CAAC,wEAAU;AAC/B,oBAAoB,mBAAO,CAAC,wFAAkB;;AAE9C;;AAEA;AACA;;AAEA;AACA;;AAEA;AACA;;AAEA;AACA,oCAAoC,wBAAwB;AAC5D,GAAG;;AAEH;AACA,mCAAmC,wBAAwB;AAC3D,GAAG;;AAEH;AACA;;AAEA;AACA,GAAG;;AAEH;AACA,qCAAqC,mBAAmB;AACxD;AACA,KAAK;AACL;AACA,CAAC;;AAED;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA,GAAG;;AAEH;AACA;AACA,GAAG;;AAEH;AACA;AACA,GAAG;;AAEH;AACA;AACA,GAAG;;AAEH;AACA;AACA,GAAG;;AAEH;AACA;AACA,GAAG;;AAEH;AACA;AACA,GAAG;;AAEH;AACA;AACA,GAAG;;AAEH;AACA;AACA,GAAG;;AAEH;AACA;AACA,GAAG;;AAEH;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA,CAAC;;;;;;;;;;;;;;;;ACpGD,aAAa,mBAAO,CAAC,wEAAU;AAC/B,oBAAoB,mBAAO,CAAC,wFAAkB;AAC9C,UAAU,mBAAO,CAAC,kEAAO;;AAEzB;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,KAAK;AACL;AACA,CAAC;;;;;;;;;;;;ACrBD,aAAa,mBAAO,CAAC,wEAAU;AAC/B,oBAAoB,mBAAO,CAAC,wFAAkB;;AAE9C;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA,OAAO;AACP,KAAK;AACL,GAAG;;AAEH;AACA,mCAAmC,aAAa;AAChD;AACA,KAAK;AACL;AACA,CAAC;;AAED;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA,GAAG;;AAEH;AACA;AACA,GAAG;;AAEH;AACA;AACA,GAAG;;AAEH;AACA;AACA;AACA,GAAG;;AAEH;AACA;AACA;;AAEA;AACA;AACA,KAAK;AACL,GAAG;;AAEH;AACA;AACA;AACA;AACA;AACA;AACA;AACA,OAAO;AACP,KAAK;AACL,GAAG;;AAEH;AACA;AACA;AACA;AACA,OAAO;AACP,KAAK;AACL,GAAG;;AAEH;AACA,4BAA4B,+BAA+B;AAC3D,GAAG;;AAEH;AACA;AACA;AACA,CAAC;;AAED;AACA;AACA;;AAEA;AACA;AACA,GAAG;AACH;AACA;AACA;AACA;AACA,GAAG;;AAEH;AACA;AACA;AACA,CAAC;;AAED;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA,GAAG;;AAEH;AACA;AACA;AACA,CAAC;;;;;;;;;;;;ACxHD,aAAa,mBAAO,CAAC,wEAAU;AAC/B,oBAAoB,mBAAO,CAAC,wFAAkB;AAC9C,cAAc,mBAAO,CAAC,0EAAW;AACjC,aAAa,mBAAO,CAAC,wEAAU;AAC/B,UAAU,mBAAO,CAAC,kEAAO;AACzB,cAAc,mBAAO,CAAC,0EAAW;AACjC,kBAAkB,mBAAO,CAAC,kFAAe;;AAEzC;;AAEA;AACA;;AAEA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA,GAAG;;AAEH;AACA;AACA;AACA;AACA;AACA,GAAG;;AAEH;AACA;AACA;AACA;AACA;AACA,GAAG;;AAEH;AACA;AACA;AACA;AACA;AACA,GAAG;;AAEH;AACA;AACA;AACA;AACA;AACA,GAAG;;AAEH;AACA;AACA;AACA;AACA;AACA,GAAG;;AAEH;AACA;AACA,oCAAoC,iBAAiB;AACrD;AACA;AACA;;AAEA,6BAA6B,qCAAqC;AAClE;AACA,GAAG;;AAEH;AACA;AACA,GAAG;;AAEH;AACA;AACA,GAAG;;AAEH;AACA;AACA,GAAG;;AAEH;AACA,gCAAgC,WAAW;AAC3C;AACA,CAAC;;;;;;;;;;;;ACtFD,aAAa,mBAAO,CAAC,wEAAU;AAC/B,oBAAoB,mBAAO,CAAC,wFAAkB;AAC9C,UAAU,mBAAO,CAAC,kEAAO;AACzB,SAAS,mBAAO,CAAC,cAAI;AACrB,YAAY,mBAAO,CAAC,oCAAe;;AAEnC;;AAEA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA,GAAG;AACH;AACA;AACA,GAAG;AACH;AACA,4BAA4B,yBAAyB;AACrD,GAAG;AACH;AACA,2BAA2B,yBAAyB;AACpD,GAAG;AACH;AACA;AACA;AACA;AACA;AACA;AACA;AACA,KAAK;AACL,GAAG;AACH;AACA;AACA;AACA;AACA;AACA;AACA;AACA,KAAK;AACL,GAAG;AACH;AACA,iCAAiC,yBAAyB;AAC1D;AACA;AACA;AACA;AACA;AACA;AACA,KAAK;AACL,GAAG;AACH;AACA;AACA;AACA,OAAO;AACP;AACA,oCAAoC;AACpC;AACA;AACA;AACA;AACA;AACA;AACA,OAAO;AACP,GAAG;AACH;AACA;AACA;AACA;AACA;AACA;AACA,OAAO;AACP,KAAK;AACL;AACA;AACA;AACA;AACA;AACA;AACA;AACA,WAAW,OAAO;AAClB;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,SAAS;AACT;AACA;AACA,OAAO;AACP;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,SAAS;AACT;AACA;AACA,OAAO;AACP;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA,qDAAqD;AACrD;AACA,GAAG;AACH;AACA;AACA,+BAA+B,4BAA4B;AAC3D;AACA;AACA;AACA;AACA;AACA;AACA;AACA,SAAS;AACT,KAAK;AACL,GAAG;AACH;AACA;AACA;AACA;AACA,gFAAgF,gBAAgB;AAChG;AACA;AACA;AACA;AACA,qGAAqG,gBAAgB;AACrH;AACA;AACA;AACA;AACA,+BAA+B,aAAa;AAC5C;AACA;AACA;AACA;AACA;AACA;AACA,SAAS;AACT;AACA;AACA,GAAG;AACH;AACA,+BAA+B,yBAAyB;AACxD;AACA,CAAC;;;;;;;;;;;;;ACzKY;;AAEb;AACA;AACA,cAAc,mBAAO,CAAC,gCAAa;AACnC,oBAAoB,mBAAO,CAAC,oFAA2B;;AAEvD;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA,KAAK;;AAEL;AACA;AACA,GAAG;AACH;;;;;;;;;;;;;ACtBA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;CAKA;;AAKA,MAAMA,GAAG,GAAGC,kEAAY,CAACC,UAAD,CAAxB;AAGO,SAAS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","file":"web-ext.js","sourcesContent":[" \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, { enumerable: true, get: getter });\n \t\t}\n \t};\n\n \t// define __esModule on exports\n \t__webpack_require__.r = function(exports) {\n \t\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n \t\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n \t\t}\n \t\tObject.defineProperty(exports, '__esModule', { value: true });\n \t};\n\n \t// create a fake namespace object\n \t// mode & 1: value is a module id, require it\n \t// mode & 2: merge all properties of value into the ns\n \t// mode & 4: return value when already ns object\n \t// mode & 8|1: behave like require\n \t__webpack_require__.t = function(value, mode) {\n \t\tif(mode & 1) value = __webpack_require__(value);\n \t\tif(mode & 8) return value;\n \t\tif((mode & 4) && typeof value === 'object' && value && value.__esModule) return value;\n \t\tvar ns = Object.create(null);\n \t\t__webpack_require__.r(ns);\n \t\tObject.defineProperty(ns, 'default', { enumerable: true, value: value });\n \t\tif(mode & 2 && typeof value != 'string') for(var key in value) __webpack_require__.d(ns, key, function(key) { return value[key]; }.bind(null, key));\n \t\treturn ns;\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"\";\n\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = \"./src/main.js\");\n","function _defineProperty(obj, key, value) {\n  if (key in obj) {\n    Object.defineProperty(obj, key, {\n      value: value,\n      enumerable: true,\n      configurable: true,\n      writable: true\n    });\n  } else {\n    obj[key] = value;\n  }\n\n  return obj;\n}\n\nmodule.exports = _defineProperty;","var defineProperty = require(\"./defineProperty\");\n\nfunction _objectSpread(target) {\n  for (var i = 1; i < arguments.length; i++) {\n    var source = arguments[i] != null ? arguments[i] : {};\n    var ownKeys = Object.keys(source);\n\n    if (typeof Object.getOwnPropertySymbols === 'function') {\n      ownKeys = ownKeys.concat(Object.getOwnPropertySymbols(source).filter(function (sym) {\n        return Object.getOwnPropertyDescriptor(source, sym).enumerable;\n      }));\n    }\n\n    ownKeys.forEach(function (key) {\n      defineProperty(target, key, source[key]);\n    });\n  }\n\n  return target;\n}\n\nmodule.exports = _objectSpread;","module.exports = require(\"./lib/browser\");","var extend = require(\"./extend\"),\n    ClientMethods = require(\"./client-methods\"),\n    Client = require(\"./client\"),\n    Tab = require(\"./tab\"),\n    Webapps = require(\"./webapps\"),\n    Device = require(\"./device\"),\n    SimulatorApps = require(\"./simulator\");\n\nconst DEFAULT_PORT = 6000;\nconst DEFAULT_HOST = \"localhost\";\n\nmodule.exports = FirefoxClient;\n\nfunction FirefoxClient(options) {\n  var client = new Client(options);\n  var actor = 'root';\n\n  client.on(\"error\", this.onError.bind(this));\n  client.on(\"end\", this.onEnd.bind(this));\n  client.on(\"timeout\", this.onTimeout.bind(this));\n\n  this.initialize(client, actor);\n}\n\nFirefoxClient.prototype = extend(ClientMethods, {\n  connect: function(port, host, cb) {\n    if (typeof port == \"function\") {\n      // (cb)\n      cb = port;\n      port = DEFAULT_PORT;\n      host = DEFAULT_HOST;\n\n    }\n    if (typeof host == \"function\") {\n      // (port, cb)\n      cb = host;\n      host = DEFAULT_HOST;\n    }\n    // (port, host, cb)\n\n    this.client.connect(port, host, cb);\n\n    this.client.expectReply(this.actor, function(packet) {\n      // root message\n    });\n  },\n\n  disconnect: function() {\n    this.client.disconnect();\n  },\n\n  onError: function(error) {\n    this.emit(\"error\", error);\n  },\n\n  onEnd: function() {\n    this.emit(\"end\");\n  },\n\n  onTimeout: function() {\n    this.emit(\"timeout\");\n  },\n\n  selectedTab: function(cb) {\n    this.request(\"listTabs\", function(resp) {\n      var tab = resp.tabs[resp.selected];\n      return new Tab(this.client, tab);\n    }.bind(this), cb);\n  },\n\n  listTabs: function(cb) {\n    this.request(\"listTabs\", function(err, resp) {\n      if (err) {\n        return cb(err);\n      }\n\n      if (resp.simulatorWebappsActor) {\n        // the server is the Firefox OS Simulator, return apps as \"tabs\"\n        var apps = new SimulatorApps(this.client, resp.simulatorWebappsActor);\n        apps.listApps(cb);\n      }\n      else {\n        var tabs = resp.tabs.map(function(tab) {\n          return new Tab(this.client, tab);\n        }.bind(this));\n        cb(null, tabs);\n      }\n    }.bind(this));\n  },\n\n  getWebapps: function(cb) {\n    this.request(\"listTabs\", (function(err, resp) {\n      if (err) {\n        return cb(err);\n      }\n      var webapps = new Webapps(this.client, resp);\n      cb(null, webapps);\n    }).bind(this));\n  },\n\n  getDevice: function(cb) {\n    this.request(\"listTabs\", (function(err, resp) {\n      if (err) {\n        return cb(err);\n      }\n      var device = new Device(this.client, resp);\n      cb(null, device);\n    }).bind(this));\n  },\n\n  getRoot: function(cb) {\n    this.request(\"listTabs\", (function(err, resp) {\n      if (err) {\n        return cb(err);\n      }\n      if (!resp.consoleActor) {\n        return cb(\"No root actor being available.\");\n      }\n      var root = new Tab(this.client, resp);\n      cb(null, root);\n    }).bind(this));\n  }\n})\n","var events = require(\"events\"),\n    extend = require(\"./extend\");\n\n// to be instantiated later - to avoid circular dep resolution\nvar JSObject;\n\nvar ClientMethods = extend(events.EventEmitter.prototype, {\n  /**\n   * Intialize this client object.\n   *\n   * @param  {object} client\n   *         Client to send requests on.\n   * @param  {string} actor\n   *         Actor id to set as 'from' field on requests\n   */\n  initialize: function(client, actor) {\n    this.client = client;\n    this.actor = actor;\n\n    this.client.on('message', function(message) {\n      if (message.from == this.actor) {\n        this.emit(message.type, message);\n      }\n    }.bind(this));\n  },\n\n  /**\n   * Make request to our actor on the server.\n   *\n   * @param  {string}   type\n   *         Method name of the request\n   * @param  {object}   message\n   *         Optional extra properties (arguments to method)\n   * @param  {Function}   transform\n   *         Optional tranform for response object. Takes response object\n   *         and returns object to send on.\n   * @param  {Function} callback\n   *         Callback to call with (maybe transformed) response\n   */\n  request: function(type, message, transform, callback) {\n    if (typeof message == \"function\") {\n      if (typeof transform == \"function\") {\n        // (type, trans, cb)\n        callback = transform;\n        transform = message;\n      }\n      else {\n        // (type, cb)\n        callback = message;\n      }\n      message = {};\n    }\n    else if (!callback) {\n      if (!message) {\n        // (type)\n        message = {};\n      }\n      // (type, message, cb)\n      callback = transform;\n      transform = null;\n    }\n\n    message.to = this.actor;\n    message.type = type;\n\n    this.client.makeRequest(message, function(resp) {\n      delete resp.from;\n\n      if (resp.error) {\n        var err = new Error(resp.message);\n        err.name = resp.error;\n\n        callback(err);\n        return;\n      }\n\n      if (transform) {\n        resp = transform(resp);\n      }\n\n      if (callback) {\n        callback(null, resp);\n      }\n    });\n  },\n\n  /*\n   * Transform obj response into a JSObject\n   */\n  createJSObject: function(obj) {\n    if (obj == null) {\n      return;\n    }\n    if (!JSObject) {\n      // circular dependencies\n      JSObject = require(\"./jsobject\");\n    }\n    if (obj.type == \"object\") {\n      return new JSObject(this.client, obj);\n    }\n    return obj;\n  },\n\n  /**\n   * Create function that plucks out only one value from an object.\n   * Used as the transform function for some responses.\n   */\n  pluck: function(prop) {\n    return function(obj) {\n      return obj[prop];\n    }\n  }\n})\n\nmodule.exports = ClientMethods;","var net = require(\"net\"),\n    events = require(\"events\"),\n    extend = require(\"./extend\");\n\nvar colors = require(\"colors\");\n\nmodule.exports = Client;\n\n// this is very unfortunate! and temporary. we can't\n// rely on 'type' property to signify an event, and we\n// need to write clients for each actor to handle differences\n// in actor protocols\nvar unsolicitedEvents = {\n  \"tabNavigated\": \"tabNavigated\",\n  \"styleApplied\": \"styleApplied\",\n  \"propertyChange\": \"propertyChange\",\n  \"networkEventUpdate\": \"networkEventUpdate\",\n  \"networkEvent\": \"networkEvent\",\n  \"propertyChange\": \"propertyChange\",\n  \"newMutations\": \"newMutations\",\n  \"appOpen\": \"appOpen\",\n  \"appClose\": \"appClose\",\n  \"appInstall\": \"appInstall\",\n  \"appUninstall\": \"appUninstall\",\n  \"frameUpdate\": \"frameUpdate\",\n  \"tabListChanged\": \"tabListChanged\"\n};\n\n/**\n * a Client object handles connecting with a Firefox remote debugging\n * server instance (e.g. a Firefox instance), plus sending and receiving\n * packets on that conection using the Firefox remote debugging protocol.\n *\n * Important methods:\n * connect - Create the connection to the server.\n * makeRequest - Make a request to the server with a JSON message,\n *   and a callback to call with the response.\n *\n * Important events:\n * 'message' - An unsolicited (e.g. not a response to a prior request)\n *    packet has been received. These packets usually describe events.\n */\nfunction Client(options) {\n  this.options = options || {};\n\n  this.incoming = new Buffer(\"\");\n\n  this._pendingRequests = [];\n  this._activeRequests = {};\n}\n\nClient.prototype = extend(events.EventEmitter.prototype, {\n  connect: function(port, host, cb) {\n    this.client = net.createConnection({\n      port: port,\n      host: host\n    });\n\n    this.client.on(\"connect\", cb);\n    this.client.on(\"data\", this.onData.bind(this));\n    this.client.on(\"error\", this.onError.bind(this));\n    this.client.on(\"end\", this.onEnd.bind(this));\n    this.client.on(\"timeout\", this.onTimeout.bind(this));\n  },\n\n  disconnect: function() {\n    if (this.client) {\n      this.client.end();\n    }\n  },\n\n  /**\n   * Set a request to be sent to an actor on the server. If the actor\n   * is already handling a request, queue this request until the actor\n   * has responded to the previous request.\n   *\n   * @param {object} request\n   *        Message to be JSON-ified and sent to server.\n   * @param {function} callback\n   *        Function that's called with the response from the server.\n   */\n  makeRequest: function(request, callback) {\n    this.log(\"request: \" + JSON.stringify(request).green);\n\n    if (!request.to) {\n      var type = request.type || \"\";\n      throw new Error(type + \" request packet has no destination.\");\n    }\n    this._pendingRequests.push({ to: request.to,\n                                 message: request,\n                                 callback: callback });\n    this._flushRequests();\n  },\n\n  /**\n   * Activate (send) any pending requests to actors that don't have an\n   * active request.\n   */\n  _flushRequests: function() {\n    this._pendingRequests = this._pendingRequests.filter(function(request) {\n      // only one active request per actor at a time\n      if (this._activeRequests[request.to]) {\n        return true;\n      }\n\n      // no active requests for this actor, so activate this one\n      this.sendMessage(request.message);\n      this.expectReply(request.to, request.callback);\n\n      // remove from pending requests\n      return false;\n    }.bind(this));\n  },\n\n  /**\n   * Send a JSON message over the connection to the server.\n   */\n  sendMessage: function(message) {\n    if (!message.to) {\n      throw new Error(\"No actor specified in request\");\n    }\n    if (!this.client) {\n      throw new Error(\"Not connected, connect() before sending requests\");\n    }\n    var str = JSON.stringify(message);\n\n    // message is preceded by byteLength(message):\n    str = (new Buffer(str).length) + \":\" + str;\n\n    this.client.write(str);\n  },\n\n  /**\n   * Arrange to hand the next reply from |actor| to |handler|.\n   */\n  expectReply: function(actor, handler) {\n    if (this._activeRequests[actor]) {\n      throw Error(\"clashing handlers for next reply from \" + uneval(actor));\n    }\n    this._activeRequests[actor] = handler;\n  },\n\n  /**\n   * Handler for a new message coming in. It's either an unsolicited event\n   * from the server, or a response to a previous request from the client.\n   */\n  handleMessage: function(message) {\n    if (!message.from) {\n      if (message.error) {\n        throw new Error(message.message);\n      }\n      throw new Error(\"Server didn't specify an actor: \" + JSON.stringify(message));\n    }\n\n    if (!(message.type in unsolicitedEvents)\n        && this._activeRequests[message.from]) {\n      this.log(\"response: \" + JSON.stringify(message).yellow);\n\n      var callback = this._activeRequests[message.from];\n      delete this._activeRequests[message.from];\n\n      callback(message);\n\n      this._flushRequests();\n    }\n    else if (message.type) {\n      // this is an unsolicited event from the server\n      this.log(\"unsolicited event: \".grey + JSON.stringify(message).grey);\n\n      this.emit('message', message);\n      return;\n    }\n    else {\n      throw new Error(\"Unexpected packet from actor \" +  message.from\n      +  JSON.stringify(message));\n    }\n  },\n\n  /**\n   * Called when a new data chunk is received on the connection.\n   * Parse data into message(s) and call message handler for any full\n   * messages that are read in.\n   */\n  onData: function(data) {\n    this.incoming = Buffer.concat([this.incoming, data]);\n\n    while(this.readMessage()) {};\n  },\n\n  /**\n   * Parse out and process the next message from the data read from\n   * the connection. Returns true if a full meassage was parsed, false\n   * otherwise.\n   */\n  readMessage: function() {\n    var sep = this.incoming.toString().indexOf(':');\n    if (sep < 0) {\n      return false;\n    }\n\n    // beginning of a message is preceded by byteLength(message) + \":\"\n    var count = parseInt(this.incoming.slice(0, sep));\n\n    if (this.incoming.length - (sep + 1) < count) {\n      this.log(\"no complete response yet\".grey);\n      return false;\n    }\n    this.incoming = this.incoming.slice(sep + 1);\n\n    var packet = this.incoming.slice(0, count);\n\n    this.incoming = this.incoming.slice(count);\n\n    var message;\n    try {\n      message = JSON.parse(packet.toString());\n    } catch(e) {\n      throw new Error(\"Couldn't parse packet from server as JSON \" + e\n        + \", message:\\n\" + packet);\n    }\n    this.handleMessage(message);\n\n    return true;\n  },\n\n  onError: function(error) {\n    var code = error.code ? error.code : error;\n    this.log(\"connection error: \".red + code.red);\n    this.emit(\"error\", error);\n  },\n\n  onEnd: function() {\n    this.log(\"connection closed by server\".red);\n    this.emit(\"end\");\n  },\n\n  onTimeout: function() {\n    this.log(\"connection timeout\".red);\n    this.emit(\"timeout\");\n  },\n\n  log: function(str) {\n    if (this.options.log) {\n      console.log(str);\n    }\n  }\n})\n","var select = require(\"js-select\"),\n    extend = require(\"./extend\"),\n    ClientMethods = require(\"./client-methods\"),\n    JSObject = require(\"./jsobject\");\n\nmodule.exports = Console;\n\nfunction Console(client, actor) {\n  this.initialize(client, actor);\n\n  this.on(\"consoleAPICall\", this.onConsoleAPI.bind(this));\n  this.on(\"pageError\", this.onPageError.bind(this));\n}\n\nConsole.prototype = extend(ClientMethods, {\n  types: [\"PageError\", \"ConsoleAPI\"],\n\n  /**\n   * Response object:\n   *   -empty-\n   */\n  startListening: function(cb) {\n    this.request('startListeners', { listeners: this.types }, cb);\n  },\n\n  /**\n   * Response object:\n   *   -empty-\n   */\n  stopListening: function(cb) {\n    this.request('stopListeners', { listeners: this.types }, cb);\n  },\n\n  /**\n   * Event object:\n   *   level - \"log\", etc.\n   *   filename - file with call\n   *   lineNumber - line number of call\n   *   functionName - function log called from\n   *   timeStamp - ms timestamp of call\n   *   arguments - array of the arguments to log call\n   *   private -\n   */\n  onConsoleAPI: function(event) {\n    var message = this.transformConsoleCall(event.message);\n\n    this.emit(\"console-api-call\", message);\n  },\n\n  /**\n   * Event object:\n   *   errorMessage - string error message\n   *   sourceName - file error\n   *   lineText\n   *   lineNumber - line number of error\n   *   columnNumber - column number of error\n   *   category - usually \"content javascript\",\n   *   timeStamp - time in ms of error occurance\n   *   warning - whether it's a warning\n   *   error - whether it's an error\n   *   exception - whether it's an exception\n   *   strict -\n   *   private -\n   */\n  onPageError: function(event) {\n    this.emit(\"page-error\", event.pageError);\n  },\n\n  /**\n   * Response object: array of page error or console call objects.\n   */\n  getCachedLogs: function(cb) {\n    var message = {\n      messageTypes: this.types\n    };\n    this.request('getCachedMessages', message, function(resp) {\n      select(resp, \".messages > *\").update(this.transformConsoleCall.bind(this));\n      return resp.messages;\n    }.bind(this), cb);\n  },\n\n  /**\n   * Response object:\n   *   -empty-\n   */\n  clearCachedLogs: function(cb) {\n    this.request('clearMessagesCache', cb);\n  },\n\n  /**\n   * Response object:\n   *   input - original input\n   *   result - result of the evaluation, a value or JSObject\n   *   timestamp - timestamp in ms of the evaluation\n   *   exception - any exception as a result of the evaluation\n   */\n  evaluateJS: function(text, cb) {\n    this.request('evaluateJS', { text: text }, function(resp) {\n      return select(resp, \".result, .exception\")\n             .update(this.createJSObject.bind(this));\n    }.bind(this), cb)\n  },\n\n  transformConsoleCall: function(message) {\n    return select(message, \".arguments > *\").update(this.createJSObject.bind(this));\n  }\n})\n","var extend = require(\"./extend\"),\n    ClientMethods = require(\"./client-methods\");\n\nmodule.exports = Device;\n\nfunction Device(client, tab) {\n  this.initialize(client, tab.deviceActor);\n}\n\nDevice.prototype = extend(ClientMethods, {\n  getDescription: function(cb) {\n    this.request(\"getDescription\", function(err, resp) {\n      if (err) {\n        return cb(err);\n      }\n\n      cb(null, resp.value);\n    });\n  },\n  getRawPermissionsTable: function(cb) {\n    this.request(\"getRawPermissionsTable\", function(err, resp) {\n      if (err) {\n        return cb(err);\n      }\n\n      cb(null, resp.value.rawPermissionsTable);\n    });\n  }\n})\n","var extend = require(\"./extend\"),\n    ClientMethods = require(\"./client-methods\"),\n    Node = require(\"./domnode\");\n\nmodule.exports = DOM;\n\nfunction DOM(client, actor) {\n  this.initialize(client, actor);\n  this.walker = null;\n}\n\nDOM.prototype = extend(ClientMethods, {\n  document: function(cb) {\n    this.walkerRequest(\"document\", function(err, resp) {\n      if (err) return cb(err);\n\n      var node = new Node(this.client, this.walker, resp.node);\n      cb(null, node);\n    }.bind(this))\n  },\n\n  documentElement: function(cb) {\n    this.walkerRequest(\"documentElement\", function(err, resp) {\n      var node = new Node(this.client, this.walker, resp.node);\n      cb(err, node);\n    }.bind(this))\n  },\n\n  querySelector: function(selector, cb) {\n    this.document(function(err, node) {\n      if (err) return cb(err);\n\n      node.querySelector(selector, cb);\n    })\n  },\n\n  querySelectorAll: function(selector, cb) {\n    this.document(function(err, node) {\n      if (err) return cb(err);\n\n      node.querySelectorAll(selector, cb);\n    })\n  },\n\n  getComputedStyle: function(node, cb) {\n    this.styleRequest(\"getComputed\", { node: node.actor },\n                      this.pluck('computed'), cb);\n  },\n\n  getUsedFontFaces: function(node, options, cb) {\n    var message = {\n      node: node.actor,\n      includePreviews: options.includePreviews,\n      previewText: options.previewText,\n      previewFontSize: options.previewFontSize\n    };\n\n    this.styleRequest(\"getUsedFontFaces\", message,\n                      this.pluck('fontFaces'), cb);\n  },\n\n  getFontPreview: function(node, font, cb) {\n    this.styleRequest(\"getFontPreview\", { node: node.actor, font: font }, cb);\n  },\n\n  walkerRequest: function(type, message, cb) {\n    this.getWalker(function(err, walker) {\n      walker.request(type, message, cb);\n    });\n  },\n\n  getWalker: function(cb) {\n    if (this.walker) {\n      return cb(null, this.walker);\n    }\n    this.request('getWalker', function(err, resp) {\n      this.walker = new Walker(this.client, resp.walker);\n      cb(err, this.walker);\n    }.bind(this))\n  },\n\n  styleRequest: function(type, message, transform, cb) {\n    this.getStyle(function(err, style) {\n      if (err) throw err;\n\n      style.request(type, message, transform, cb);\n    })\n  },\n\n  getStyle: function(cb) {\n    if (this.style) {\n      return cb(null, this.style);\n    }\n    this.request('getPageStyle', function(err, resp) {\n      this.style = new Style(this.client, resp.pageStyle);\n      cb(err, this.style);\n    }.bind(this))\n  }\n})\n\nfunction Walker(client, walker) {\n  this.initialize(client, walker.actor);\n\n  this.root = new Node(client, this, walker.root);\n}\n\nWalker.prototype = extend(ClientMethods, {});\n\nfunction Style(client, style) {\n  this.initialize(client, style.actor);\n}\n\nStyle.prototype = extend(ClientMethods, {});\n","var extend = require(\"./extend\"),\n    ClientMethods = require(\"./client-methods\");\n\nmodule.exports = Node;\n\nfunction Node(client, walker, node) {\n  this.initialize(client, node.actor);\n  this.walker = walker;\n\n  this.getNode = this.getNode.bind(this);\n  this.getNodeArray = this.getNodeArray.bind(this);\n  this.getNodeList = this.getNodeList.bind(this);\n\n  walker.on('newMutations', function(event) {\n    //console.log(\"on new mutations! \", JSON.stringify(event));\n  });\n\n  ['nodeType', 'nodeName', 'namespaceURI', 'attrs']\n  .forEach(function(attr) {\n    this[attr] = node[attr];\n  }.bind(this));\n}\n\nNode.prototype = extend(ClientMethods, {\n  getAttribute: function(name) {\n    for (var i in this.attrs) {\n      var attr = this.attrs[i];\n      if (attr.name == name) {\n        return attr.value;\n      }\n    }\n  },\n\n  setAttribute: function(name, value, cb) {\n    var mods = [{\n      attributeName: name,\n      newValue: value\n    }];\n    this.request('modifyAttributes', { modifications: mods }, cb);\n  },\n\n  parentNode: function(cb) {\n    this.parents(function(err, nodes) {\n      if (err) {\n        return cb(err);\n      }\n      var node = null;\n      if (nodes.length) {\n        node = nodes[0];\n      }\n      cb(null, node);\n    })\n  },\n\n  parents: function(cb) {\n    this.nodeRequest('parents', this.getNodeArray, cb);\n  },\n\n  children: function(cb) {\n    this.nodeRequest('children', this.getNodeArray, cb);\n  },\n\n  siblings: function(cb) {\n    this.nodeRequest('siblings', this.getNodeArray, cb);\n  },\n\n  nextSibling: function(cb) {\n    this.nodeRequest('nextSibling', this.getNode, cb);\n  },\n\n  previousSibling: function(cb) {\n    this.nodeRequest('previousSibling', this.getNode, cb);\n  },\n\n  querySelector: function(selector, cb) {\n    this.nodeRequest('querySelector', { selector: selector },\n                     this.getNode, cb);\n  },\n\n  querySelectorAll: function(selector, cb) {\n    this.nodeRequest('querySelectorAll', { selector: selector },\n                     this.getNodeList, cb);\n  },\n\n  getUniqueSelector: function(cb) {\n    this.request('getUniqueSelector', cb);\n  },\n\n  innerHTML: function(cb) {\n    this.nodeRequest('innerHTML', function(resp) {\n      return resp.value;\n    }, cb)\n  },\n\n  outerHTML: function(cb) {\n    this.nodeRequest('outerHTML', function(resp) {\n      return resp.value;\n    }, cb)\n  },\n\n  remove: function(cb) {\n    this.nodeRequest('removeNode', function(resp) {\n      return new Node(this.client, this.walker, resp.nextSibling);\n    }.bind(this), cb);\n  },\n\n  highlight: function(cb) {\n    this.nodeRequest('highlight', cb);\n  },\n\n  release: function(cb) {\n    this.nodeRequest('releaseNode', cb);\n  },\n\n  getNode: function(resp) {\n    if (resp.node) {\n      return new Node(this.client, this.walker, resp.node);\n    }\n    return null;\n  },\n\n  getNodeArray: function(resp) {\n    return resp.nodes.map(function(form) {\n      return new Node(this.client, this.walker, form);\n    }.bind(this));\n  },\n\n  getNodeList: function(resp) {\n    return new NodeList(this.client, this.walker, resp.list);\n  },\n\n  nodeRequest: function(type, message, transform, cb) {\n    if (!cb) {\n      cb = transform;\n      transform = message;\n      message = {};\n    }\n    message.node = this.actor;\n\n    this.walker.request(type, message, transform, cb);\n  }\n});\n\nfunction NodeList(client, walker, list) {\n  this.client = client;\n  this.walker = walker;\n  this.actor = list.actor;\n\n  this.length = list.length;\n}\n\nNodeList.prototype = extend(ClientMethods, {\n  items: function(start, end, cb) {\n    if (typeof start == \"function\") {\n      cb = start;\n      start = 0;\n      end = this.length;\n    }\n    else if (typeof end == \"function\") {\n      cb = end;\n      end = this.length;\n    }\n    this.request('items', { start: start, end: end },\n      this.getNodeArray.bind(this), cb);\n  },\n\n  // TODO: add this function to ClientMethods\n  getNodeArray: function(resp) {\n    return resp.nodes.map(function(form) {\n      return new Node(this.client, this.walker, form);\n    }.bind(this));\n  }\n});\n","module.exports = function extend(prototype, properties) {\n  return Object.create(prototype, getOwnPropertyDescriptors(properties));\n}\n\nfunction getOwnPropertyDescriptors(object) {\n  var names = Object.getOwnPropertyNames(object);\n\n  return names.reduce(function(descriptor, name) {\n    descriptor[name] = Object.getOwnPropertyDescriptor(object, name);\n    return descriptor;\n  }, {});\n}","var select = require(\"js-select\"),\n    extend = require(\"./extend\"),\n    ClientMethods = require(\"./client-methods\");\n\nmodule.exports = JSObject;\n\nfunction JSObject(client, obj) {\n  this.initialize(client, obj.actor);\n  this.obj = obj;\n}\n\nJSObject.prototype = extend(ClientMethods, {\n  type: \"object\",\n\n  get class() {\n    return this.obj.class;\n  },\n\n  get name() {\n    return this.obj.name;\n  },\n\n  get displayName() {\n    return this.obj.displayName;\n  },\n\n  ownPropertyNames: function(cb) {\n    this.request('ownPropertyNames', function(resp) {\n      return resp.ownPropertyNames;\n    }, cb);\n  },\n\n  ownPropertyDescriptor: function(name, cb) {\n    this.request('property', { name: name }, function(resp) {\n      return this.transformDescriptor(resp.descriptor);\n    }.bind(this), cb);\n  },\n\n  ownProperties: function(cb) {\n    this.request('prototypeAndProperties', function(resp) {\n      return this.transformProperties(resp.ownProperties);\n    }.bind(this), cb);\n  },\n\n  prototype: function(cb) {\n    this.request('prototype', function(resp) {\n      return this.createJSObject(resp.prototype);\n    }.bind(this), cb);\n  },\n\n  ownPropertiesAndPrototype: function(cb) {\n    this.request('prototypeAndProperties', function(resp) {\n      resp.ownProperties = this.transformProperties(resp.ownProperties);\n      resp.safeGetterValues = this.transformGetters(resp.safeGetterValues);\n      resp.prototype = this.createJSObject(resp.prototype);\n\n      return resp;\n    }.bind(this), cb);\n  },\n\n  /* helpers */\n  transformProperties: function(props) {\n    var transformed = {};\n    for (var prop in props) {\n      transformed[prop] = this.transformDescriptor(props[prop]);\n    }\n    return transformed;\n  },\n\n  transformGetters: function(getters) {\n    var transformed = {};\n    for (var prop in getters) {\n      transformed[prop] = this.transformGetter(getters[prop]);\n    }\n    return transformed;\n  },\n\n  transformDescriptor: function(descriptor) {\n    descriptor.value = this.createJSObject(descriptor.value);\n    return descriptor;\n  },\n\n  transformGetter: function(getter) {\n    return {\n      value: this.createJSObject(getter.getterValue),\n      prototypeLevel: getter.getterPrototypeLevel,\n      enumerable: getter.enumerable,\n      writable: getter.writable\n    }\n  }\n})","var extend = require(\"./extend\"),\n    ClientMethods = require(\"./client-methods\");\n\nmodule.exports = Memory;\n\nfunction Memory(client, actor) {\n  this.initialize(client, actor);\n}\n\nMemory.prototype = extend(ClientMethods, {\n  measure: function(cb) {\n    this.request('measure', function (err, resp) {\n      cb(err, resp);\n    });\n  }\n})\n","var extend = require(\"./extend\");\nvar ClientMethods = require(\"./client-methods\");\n\nmodule.exports = Network;\n\nfunction Network(client, actor) {\n  this.initialize(client, actor);\n\n  this.on(\"networkEvent\", this.onNetworkEvent.bind(this));\n}\n\nNetwork.prototype = extend(ClientMethods, {\n  types: [\"NetworkActivity\"],\n\n  startLogging: function(cb) {\n    this.request('startListeners', { listeners: this.types }, cb);\n  },\n\n  stopLogging: function(cb) {\n    this.request('stopListeners', { listeners: this.types }, cb);\n  },\n\n  onNetworkEvent: function(event) {\n    var networkEvent = new NetworkEvent(this.client, event.eventActor);\n\n    this.emit(\"network-event\", networkEvent);\n  },\n\n  sendHTTPRequest: function(request, cb) {\n    this.request('sendHTTPRequest', { request: request }, function(resp) {\n      return new NetworkEvent(this.client, resp.eventActor);\n    }.bind(this), cb);\n  }\n})\n\nfunction NetworkEvent(client, event) {\n  this.initialize(client, event.actor);\n  this.event = event;\n\n  this.on(\"networkEventUpdate\", this.onUpdate.bind(this));\n}\n\nNetworkEvent.prototype = extend(ClientMethods, {\n  get url() {\n   return this.event.url;\n  },\n\n  get method() {\n    return this.event.method;\n  },\n\n  get isXHR() {\n    return this.event.isXHR;\n  },\n\n  getRequestHeaders: function(cb) {\n    this.request('getRequestHeaders', cb);\n  },\n\n  getRequestCookies: function(cb) {\n    this.request('getRequestCookies', this.pluck('cookies'), cb);\n  },\n\n  getRequestPostData: function(cb) {\n    this.request('getRequestPostData', cb);\n  },\n\n  getResponseHeaders: function(cb) {\n    this.request('getResponseHeaders', cb);\n  },\n\n  getResponseCookies: function(cb) {\n    this.request('getResponseCookies', this.pluck('cookies'), cb);\n  },\n\n  getResponseContent: function(cb) {\n    this.request('getResponseContent', cb);\n  },\n\n  getEventTimings: function(cb) {\n    this.request('getEventTimings', cb);\n  },\n\n  onUpdate: function(event) {\n    var types = {\n      \"requestHeaders\": \"request-headers\",\n      \"requestCookies\": \"request-cookies\",\n      \"requestPostData\": \"request-postdata\",\n      \"responseStart\": \"response-start\",\n      \"responseHeaders\": \"response-headers\",\n      \"responseCookies\": \"response-cookies\",\n      \"responseContent\": \"response-content\",\n      \"eventTimings\": \"event-timings\"\n    }\n\n    var type = types[event.updateType];\n    delete event.updateType;\n\n    this.emit(type, event);\n  }\n})\n\n\n\n\n","var extend = require(\"./extend\"),\n    ClientMethods = require(\"./client-methods\"),\n    Tab = require(\"./tab\");\n\nmodule.exports = SimulatorApps;\n\nfunction SimulatorApps(client, actor) {\n  this.initialize(client, actor);\n}\n\nSimulatorApps.prototype = extend(ClientMethods, {\n  listApps: function(cb) {\n    this.request('listApps', function(resp) {\n      var apps = [];\n      for (var url in resp.apps) {\n        var app = resp.apps[url];\n        apps.push(new Tab(this.client, app));\n      }\n      return apps;\n    }.bind(this), cb);\n  }\n})\n","var extend = require(\"./extend\");\nvar ClientMethods = require(\"./client-methods\");\n\nmodule.exports = StyleSheets;\n\nfunction StyleSheets(client, actor) {\n  this.initialize(client, actor);\n}\n\nStyleSheets.prototype = extend(ClientMethods, {\n  getStyleSheets: function(cb) {\n    this.request('getStyleSheets', function(resp) {\n      return resp.styleSheets.map(function(sheet) {\n        return new StyleSheet(this.client, sheet);\n      }.bind(this));\n    }.bind(this), cb);\n  },\n\n  addStyleSheet: function(text, cb) {\n    this.request('addStyleSheet', { text: text }, function(resp) {\n      return new StyleSheet(this.client, resp.styleSheet);\n    }.bind(this), cb);\n  }\n})\n\nfunction StyleSheet(client, sheet) {\n  this.initialize(client, sheet.actor);\n  this.sheet = sheet;\n\n  this.on(\"propertyChange\", this.onPropertyChange.bind(this));\n}\n\nStyleSheet.prototype = extend(ClientMethods, {\n  get href() {\n    return this.sheet.href;\n  },\n\n  get disabled() {\n    return this.sheet.disabled;\n  },\n\n  get ruleCount() {\n    return this.sheet.ruleCount;\n  },\n\n  onPropertyChange: function(event) {\n    this.sheet[event.property] = event.value;\n    this.emit(event.property + \"-changed\", event.value);\n  },\n\n  toggleDisabled: function(cb) {\n    this.request('toggleDisabled', function(err, resp) {\n      if (err) return cb(err);\n\n      this.sheet.disabled = resp.disabled;\n      cb(null, resp.disabled);\n    }.bind(this));\n  },\n\n  getOriginalSources: function(cb) {\n    this.request('getOriginalSources', function(resp) {\n      if (resp.originalSources === null) {\n        return [];\n      }\n      return resp.originalSources.map(function(form) {\n        return new OriginalSource(this.client, form);\n      }.bind(this));\n    }.bind(this), cb);\n  },\n\n  getMediaRules: function(cb) {\n    this.request('getMediaRules', function(resp) {\n      return resp.mediaRules.map(function(form) {\n        return new MediaRule(this.client, form);\n      }.bind(this));\n    }.bind(this), cb);\n  },\n\n  update: function(text, cb) {\n    this.request('update', { text: text, transition: true }, cb);\n  },\n\n  getText: function(cb) {\n    this.request('getText', this.pluck('text'), cb);\n  }\n});\n\nfunction MediaRule(client, rule) {\n  this.initialize(client, rule.actor);\n  this.rule = rule;\n\n  this.on(\"matchesChange\", function(event) {\n    this.emit(\"matches-change\", event.matches);\n  }.bind(this));\n}\nMediaRule.prototype = extend(ClientMethods, {\n  get mediaText() {\n    return this.rule.mediaText;\n  },\n\n  get matches() {\n    return this.rule.matches;\n  }\n})\n\nfunction OriginalSource(client, source) {\n  console.log(\"source\", source);\n  this.initialize(client, source.actor);\n\n  this.source = source;\n}\n\nOriginalSource.prototype = extend(ClientMethods, {\n  get url()  {\n    return this.source.url\n  },\n\n  getText: function(cb) {\n    this.request('getText', this.pluck('text'), cb);\n  }\n});\n","var extend = require(\"./extend\"),\n    ClientMethods = require(\"./client-methods\"),\n    Console = require(\"./console\"),\n    Memory = require(\"./memory\"),\n    DOM = require(\"./dom\"),\n    Network = require(\"./network\"),\n    StyleSheets = require(\"./stylesheets\");\n\nmodule.exports = Tab;\n\nfunction Tab(client, tab) {\n  this.initialize(client, tab.actor);\n\n  this.tab = tab;\n  this.updateInfo(tab);\n\n  this.on(\"tabNavigated\", this.onTabNavigated.bind(this));\n}\n\nTab.prototype = extend(ClientMethods, {\n  updateInfo: function(form) {\n    this.url = form.url;\n    this.title = form.title;\n  },\n\n  get StyleSheets() {\n    if (!this._StyleSheets) {\n      this._StyleSheets = new StyleSheets(this.client, this.tab.styleSheetsActor);\n    }\n    return this._StyleSheets;\n  },\n\n  get DOM() {\n    if (!this._DOM) {\n      this._DOM = new DOM(this.client, this.tab.inspectorActor);\n    }\n    return this._DOM;\n  },\n\n  get Network() {\n    if (!this._Network) {\n      this._Network = new Network(this.client, this.tab.consoleActor);\n    }\n    return this._Network;\n  },\n\n  get Console() {\n    if (!this._Console) {\n      this._Console = new Console(this.client, this.tab.consoleActor);\n    }\n    return this._Console;\n  },\n\n  get Memory() {\n    if (!this._Memory) {\n      this._Memory = new Memory(this.client, this.tab.memoryActor);\n    }\n    return this._Memory;\n  },\n\n  onTabNavigated: function(event) {\n    if (event.state == \"start\") {\n      this.emit(\"before-navigate\", { url: event.url });\n    }\n    else if (event.state == \"stop\") {\n      this.updateInfo(event);\n\n      this.emit(\"navigate\", { url: event.url, title: event.title });\n    }\n  },\n\n  attach: function(cb) {\n    this.request(\"attach\", cb);\n  },\n\n  detach: function(cb) {\n    this.request(\"detach\", cb);\n  },\n\n  reload: function(cb) {\n    this.request(\"reload\", cb);\n  },\n\n  navigateTo: function(url, cb) {\n    this.request(\"navigateTo\", { url: url }, cb);\n  }\n})\n","var extend = require(\"./extend\"),\n    ClientMethods = require(\"./client-methods\"),\n    Tab = require(\"./tab\"),\n    fs = require(\"fs\"),\n    spawn = require(\"child_process\").spawn;\n\nmodule.exports = Webapps;\n\nvar CHUNK_SIZE = 20480;\n\n// Also dispatch appOpen/appClose, appInstall/appUninstall events\nfunction Webapps(client, tab) {\n  this.initialize(client, tab.webappsActor);\n}\n\nWebapps.prototype = extend(ClientMethods, {\n  watchApps: function(cb) {\n    this.request(\"watchApps\", cb);\n  },\n  unwatchApps: function(cb) {\n    this.request(\"unwatchApps\", cb);\n  },\n  launch: function(manifestURL, cb) {\n    this.request(\"launch\", {manifestURL: manifestURL}, cb);\n  },\n  close: function(manifestURL, cb) {\n    this.request(\"close\", {manifestURL: manifestURL}, cb);\n  },\n  getInstalledApps: function(cb) {\n    this.request(\"getAll\", function (err, resp) {\n      if (err) {\n        cb(err);\n        return;\n      }\n      cb(null, resp.apps);\n    });\n  },\n  listRunningApps: function(cb) {\n    this.request(\"listRunningApps\", function (err, resp) {\n      if (err) {\n        cb(err);\n        return;\n      }\n      cb(null, resp.apps);\n    });\n  },\n  getApp: function(manifestURL, cb) {\n    this.request(\"getAppActor\", {manifestURL: manifestURL}, (function (err, resp) {\n      if (err) {\n        cb(err);\n        return;\n      }\n      var actor = new Tab(this.client, resp.actor);\n      cb(null, actor);\n    }).bind(this));\n  },\n  installHosted: function(options, cb) {\n    this.request(\n      \"install\",\n      { appId: options.appId,\n        metadata: options.metadata,\n        manifest: options.manifest },\n      function (err, resp) {\n        if (err || resp.error) {\n          cb(err || resp.error);\n          return;\n        }\n        cb(null, resp.appId);\n      });\n  },\n  _upload: function (path, cb) {\n    // First create an upload actor\n    this.request(\"uploadPackage\", function (err, resp) {\n      var actor = resp.actor;\n      fs.readFile(path, function(err, data) {\n        chunk(actor, data);\n      });\n    });\n    // Send push the file chunk by chunk\n    var self = this;\n    var step = 0;\n    function chunk(actor, data) {\n      var i = step++ * CHUNK_SIZE;\n      var m = Math.min(i + CHUNK_SIZE, data.length);\n      var c = \"\";\n      for(; i < m; i++)\n        c += String.fromCharCode(data[i]);\n      var message = {\n        to: actor,\n        type: \"chunk\",\n        chunk: c\n      };\n      self.client.makeRequest(message, function(resp) {\n        if (resp.error) {\n          cb(resp);\n          return;\n        }\n        if (i < data.length) {\n          setTimeout(chunk, 0, actor, data);\n        } else {\n          done(actor);\n        }\n      });\n    }\n    // Finally close the upload\n    function done(actor) {\n      var message = {\n        to: actor,\n        type: \"done\"\n      };\n      self.client.makeRequest(message, function(resp) {\n        if (resp.error) {\n          cb(resp);\n        } else {\n          cb(null, actor, cleanup.bind(null, actor));\n        }\n      });\n    }\n\n    // Remove the temporary uploaded file from the server:\n    function cleanup(actor) {\n      var message = {\n        to: actor,\n        type: \"remove\"\n      };\n      self.client.makeRequest(message, function () {});\n    }\n  },\n  installPackaged: function(path, appId, cb) {\n    this._upload(path, (function (err, actor, cleanup) {\n      this.request(\"install\", {appId: appId, upload: actor},\n        function (err, resp) {\n          if (err) {\n            cb(err);\n            return;\n          }\n          cb(null, resp.appId);\n          cleanup();\n        });\n    }).bind(this));\n  },\n  installPackagedWithADB: function(path, appId, cb) {\n    var self = this;\n    // First ensure the temporary folder exists\n    function createTemporaryFolder() {\n      var c = spawn(\"adb\", [\"shell\", \"mkdir -p /data/local/tmp/b2g/\" + appId], {stdio:\"inherit\"});\n      c.on(\"close\", uploadPackage);\n    }\n    // then upload the package to the temporary directory\n    function uploadPackage() {\n      var child = spawn(\"adb\", [\"push\", path, \"/data/local/tmp/b2g/\" + appId + \"/application.zip\"], {stdio:\"inherit\"});\n      child.on(\"close\", installApp);\n    }\n    // finally order the webapps actor to install the app\n    function installApp() {\n      self.request(\"install\", {appId: appId},\n        function (err, resp) {\n          if (err) {\n            cb(err);\n            return;\n          }\n          cb(null, resp.appId);\n        });\n    }\n    createTemporaryFolder();\n  },\n  uninstall: function(manifestURL, cb) {\n    this.request(\"uninstall\", {manifestURL: manifestURL}, cb);\n  }\n})\n","'use strict';\n\n// See https://github.com/jshint/jshint/issues/1747 for context\n/* global -Promise */\nvar Promise = require('es6-promise').Promise;\nvar FirefoxClient = require('@cliqz-oss/firefox-client');\n\nmodule.exports = connect;\n\nfunction connect(port) {\n  return new Promise(function(resolve, reject) {\n\n    var client = new FirefoxClient();\n    client.connect(port, function(err) {\n      if (err) {\n        reject(err);\n      }\n      resolve(client);\n    });\n\n    client.on('error', reject);\n    client.on('timeout', reject);\n  });\n}\n","/* @flow */\nimport path from 'path';\nimport {createWriteStream} from 'fs';\n\nimport {fs} from 'mz';\nimport parseJSON from 'parse-json';\nimport stripJsonComments from 'strip-json-comments';\nimport defaultEventToPromise from 'event-to-promise';\n\nimport defaultSourceWatcher from '../watcher';\nimport {zipDir} from '../util/zip-dir';\nimport getValidatedManifest, {getManifestId} from '../util/manifest';\nimport {prepareArtifactsDir} from '../util/artifacts';\nimport {createLogger} from '../util/logger';\nimport {UsageError, isErrorWithCode} from '../errors';\nimport {\n  createFileFilter as defaultFileFilterCreator,\n  FileFilter,\n} from '../util/file-filter';\n// Import flow types.\nimport type {OnSourceChangeFn} from '../watcher';\nimport type {ExtensionManifest} from '../util/manifest';\nimport type {FileFilterCreatorFn} from '../util/file-filter';\n\nconst log = createLogger(__filename);\n\n\nexport function safeFileName(name: string): string {\n  return name.toLowerCase().replace(/[^a-z0-9.-]+/g, '_');\n}\n\n\n// defaultPackageCreator types and implementation.\n\nexport type ExtensionBuildResult = {|\n  extensionPath: string,\n|};\n\nexport type PackageCreatorParams = {|\n  manifestData?: ExtensionManifest,\n  sourceDir: string,\n  fileFilter: FileFilter,\n  artifactsDir: string,\n  overwriteDest: boolean,\n  showReadyMessage: boolean\n|};\n\nexport type LocalizedNameParams = {|\n  messageFile: string,\n  manifestData: ExtensionManifest,\n|}\n\nexport type PackageCreatorOptions = {|\n  eventToPromise: typeof defaultEventToPromise,\n|};\n\n// This defines the _locales/messages.json type. See:\n// https://developer.mozilla.org/en-US/Add-ons/WebExtensions/Internationalization#Providing_localized_strings_in__locales\ntype LocalizedMessageData = {|\n  [messageName: string]: {|\n    description: string,\n    message: string,\n  |},\n|}\n\nexport async function getDefaultLocalizedName(\n  {messageFile, manifestData}: LocalizedNameParams\n): Promise<string> {\n\n  let messageData: LocalizedMessageData;\n  let messageContents: string | Buffer;\n  let extensionName: string = manifestData.name;\n\n  try {\n    messageContents = await fs.readFile(messageFile, {encoding: 'utf-8'});\n  } catch (error) {\n    throw new UsageError(\n      `Error reading messages.json file at ${messageFile}: ${error}`);\n  }\n\n  try {\n    messageData = parseJSON(stripJsonComments(messageContents), messageFile);\n  } catch (error) {\n    throw new UsageError(\n      `Error parsing messages.json ${error}`);\n  }\n\n  extensionName = manifestData.name.replace(\n    /__MSG_([A-Za-z0-9@_]+?)__/g,\n    (match, messageName) => {\n      if (!(messageData[messageName]\n            && messageData[messageName].message)) {\n        const error = new UsageError(\n          `The locale file ${messageFile} ` +\n            `is missing key: ${messageName}`);\n        throw error;\n      } else {\n        return messageData[messageName].message;\n      }\n    });\n  return Promise.resolve(extensionName);\n}\n\nexport type PackageCreatorFn =\n    (params: PackageCreatorParams) => Promise<ExtensionBuildResult>;\n\nexport async function defaultPackageCreator(\n  {\n    manifestData,\n    sourceDir,\n    fileFilter,\n    artifactsDir,\n    overwriteDest,\n    showReadyMessage,\n  }: PackageCreatorParams,\n  {\n    eventToPromise = defaultEventToPromise,\n  }: PackageCreatorOptions = {}\n): Promise<ExtensionBuildResult> {\n  let id;\n  if (manifestData) {\n    id = getManifestId(manifestData);\n    log.debug(`Using manifest id=${id || '[not specified]'}`);\n  } else {\n    manifestData = await getValidatedManifest(sourceDir);\n  }\n\n  const buffer = await zipDir(sourceDir, {\n    filter: (...args) => fileFilter.wantFile(...args),\n  });\n\n  let extensionName: string = manifestData.name;\n\n  if (manifestData.default_locale) {\n    const messageFile = path.join(\n      sourceDir, '_locales',\n      manifestData.default_locale, 'messages.json'\n    );\n    log.debug('Manifest declared default_locale, localizing extension name');\n    extensionName = await getDefaultLocalizedName({\n      messageFile, manifestData,\n    });\n  }\n  const packageName = safeFileName(\n    `${extensionName}-${manifestData.version}.zip`);\n  const extensionPath = path.join(artifactsDir, packageName);\n\n  // Added 'wx' flags to avoid overwriting of existing package.\n  let stream = createWriteStream(extensionPath, {flags: 'wx'});\n\n  stream.write(buffer, () => stream.end());\n\n  try {\n    await eventToPromise(stream, 'close');\n  } catch (error) {\n    if (!isErrorWithCode('EEXIST', error)) {\n      throw error;\n    }\n    if (!overwriteDest) {\n      throw new UsageError(\n        `Extension exists at the destination path: ${extensionPath}\\n` +\n        'Use --overwrite-dest to enable overwriting.');\n    }\n    log.info(`Destination exists, overwriting: ${extensionPath}`);\n    stream = createWriteStream(extensionPath);\n    stream.write(buffer, () => stream.end());\n    await eventToPromise(stream, 'close');\n  }\n\n  if (showReadyMessage) {\n    log.info(`Your web extension is ready: ${extensionPath}`);\n  }\n  return {extensionPath};\n}\n\n\n// Build command types and implementation.\n\nexport type BuildCmdParams = {|\n  sourceDir: string,\n  artifactsDir: string,\n  asNeeded?: boolean,\n  overwriteDest?: boolean,\n  ignoreFiles?: Array<string>,\n|};\n\nexport type BuildCmdOptions = {|\n  manifestData?: ExtensionManifest,\n  fileFilter?: FileFilter,\n  onSourceChange?: OnSourceChangeFn,\n  packageCreator?: PackageCreatorFn,\n  showReadyMessage?: boolean,\n  createFileFilter?: FileFilterCreatorFn,\n  shouldExitProgram?: boolean,\n|};\n\nexport default async function build(\n  {\n    sourceDir,\n    artifactsDir,\n    asNeeded = false,\n    overwriteDest = false,\n    ignoreFiles = [],\n  }: BuildCmdParams,\n  {\n    manifestData,\n    createFileFilter = defaultFileFilterCreator,\n    fileFilter = createFileFilter({\n      sourceDir,\n      artifactsDir,\n      ignoreFiles,\n    }),\n    onSourceChange = defaultSourceWatcher,\n    packageCreator = defaultPackageCreator,\n    showReadyMessage = true,\n  }: BuildCmdOptions = {}\n): Promise<ExtensionBuildResult> {\n\n  const rebuildAsNeeded = asNeeded; // alias for `build --as-needed`\n  log.info(`Building web extension from ${sourceDir}`);\n\n  const createPackage = () => packageCreator({\n    manifestData,\n    sourceDir,\n    fileFilter,\n    artifactsDir,\n    overwriteDest,\n    showReadyMessage,\n  });\n\n  await prepareArtifactsDir(artifactsDir);\n  const result = await createPackage();\n\n  if (rebuildAsNeeded) {\n    log.info('Rebuilding when files change...');\n    onSourceChange({\n      sourceDir,\n      artifactsDir,\n      onChange: () => {\n        return createPackage().catch((error) => {\n          log.error(error.stack);\n          throw error;\n        });\n      },\n      shouldWatchFile: (...args) => fileFilter.wantFile(...args),\n    });\n  }\n\n  return result;\n}\n","/* @flow */\nimport opn from 'opn';\n\nimport {createLogger} from '../util/logger';\n\nconst log = createLogger(__filename);\n\nexport type DocsParams = {\n  noInput?: boolean,\n  shouldExitProgram?: boolean,\n}\n\nexport type DocsOptions = {\n  openUrl?: typeof opn,\n}\n\nexport const url = 'https://developer.mozilla.org/en-US/Add-ons' +\n  '/WebExtensions/Getting_started_with_web-ext';\n\nexport default function docs(\n  params: DocsParams, {openUrl = opn}: DocsOptions = {}\n): Promise<void> {\n  return new Promise((resolve, reject) => {\n    openUrl(url, (error) => {\n      if (error) {\n        log.debug(`Encountered an error while opening URL ${url}`, error);\n        reject(error);\n      } else {\n        resolve();\n      }\n    });\n  });\n}\n","/* @flow */\n\nimport type {\n  BuildCmdParams, BuildCmdOptions, ExtensionBuildResult,\n} from './build';\nimport type {LintCmdParams, LintCmdOptions} from './lint';\nimport type {CmdRunParams, CmdRunOptions} from './run';\nimport type {MultiExtensionRunner} from '../extension-runners';\nimport type {SignParams, SignOptions, SignResult} from './sign';\nimport type {DocsParams, DocsOptions} from './docs';\n\n// This module exports entry points for all supported commands. For performance\n// reasons (faster start-up), the implementations are not statically imported\n// at the top of the file, but lazily loaded in the (exported) functions.\n// The latter would slow down start-up by several seconds, as seen in #1302 .\n\nasync function build(\n  params: BuildCmdParams, options: BuildCmdOptions\n): Promise<ExtensionBuildResult> {\n  // TODO: use async import instead of require - https://github.com/mozilla/web-ext/issues/1306\n  const {default: runCommand} = require('./build');\n  return runCommand(params, options);\n}\n\nasync function lint(\n  params: LintCmdParams, options: LintCmdOptions\n): Promise<void> {\n  // TODO: use async import instead of require - https://github.com/mozilla/web-ext/issues/1306\n  const {default: runCommand} = require('./lint');\n  return runCommand(params, options);\n}\n\nasync function run(\n  params: CmdRunParams, options: CmdRunOptions\n): Promise<MultiExtensionRunner> {\n  // TODO: use async import instead of require - https://github.com/mozilla/web-ext/issues/1306\n  const {default: runCommand} = require('./run');\n  return runCommand(params, options);\n}\n\nasync function sign(\n  params: SignParams, options: SignOptions\n): Promise<SignResult> {\n  // TODO: use async import instead of require - https://github.com/mozilla/web-ext/issues/1306\n  const {default: runCommand} = require('./sign');\n  return runCommand(params, options);\n}\n\nasync function docs(\n  params: DocsParams, options: DocsOptions\n): Promise<void> {\n  // TODO: use async import instead of require - https://github.com/mozilla/web-ext/issues/1306\n  const {default: runCommand} = require('./docs');\n  return runCommand(params, options);\n}\n\nexport default {build, lint, run, sign, docs};\n","/* @flow */\nimport {createInstance as defaultLinterCreator} from 'addons-linter';\n\nimport {createLogger} from '../util/logger';\nimport {\n  createFileFilter as defaultFileFilterCreator,\n} from '../util/file-filter';\n// import flow types\nimport type {FileFilterCreatorFn} from '../util/file-filter';\n\nconst log = createLogger(__filename);\n\n\n// Define the needed 'addons-linter' module flow types.\n\nexport type LinterOutputType = 'text' | 'json';\n\nexport type LinterCreatorParams = {|\n  config: {|\n    logLevel: 'debug' | 'fatal',\n    stack: boolean,\n    pretty?: boolean,\n    warningsAsErrors?: boolean,\n    metadata?: boolean,\n    output?: LinterOutputType,\n    boring?: boolean,\n    selfHosted?: boolean,\n    shouldScanFile: (fileName: string) => boolean,\n    _: Array<string>,\n  |},\n  runAsBinary: boolean,\n|};\n\nexport type Linter = {|\n  run: () => Promise<void>,\n|};\n\nexport type LinterCreatorFn = (params: LinterCreatorParams) => Linter;\n\n\n// Lint command types and implementation.\n\nexport type LintCmdParams = {|\n  artifactsDir?: string,\n  boring?: boolean,\n  ignoreFiles?: Array<string>,\n  metadata?: boolean,\n  output?: LinterOutputType,\n  pretty?: boolean,\n  selfHosted?: boolean,\n  sourceDir: string,\n  verbose?: boolean,\n  warningsAsErrors?: boolean,\n|};\n\nexport type LintCmdOptions = {|\n  createLinter?: LinterCreatorFn,\n  createFileFilter?: FileFilterCreatorFn,\n  shouldExitProgram?: boolean,\n|};\n\nexport default function lint(\n  {\n    artifactsDir,\n    boring,\n    ignoreFiles,\n    metadata,\n    output,\n    pretty,\n    sourceDir,\n    selfHosted,\n    verbose,\n    warningsAsErrors,\n  }: LintCmdParams,\n  {\n    createLinter = defaultLinterCreator,\n    createFileFilter = defaultFileFilterCreator,\n    shouldExitProgram = true,\n  }: LintCmdOptions = {}\n): Promise<void> {\n  const fileFilter = createFileFilter({sourceDir, ignoreFiles, artifactsDir});\n\n  log.debug(`Running addons-linter on ${sourceDir}`);\n  const linter = createLinter({\n    config: {\n      logLevel: verbose ? 'debug' : 'fatal',\n      stack: Boolean(verbose),\n      pretty,\n      warningsAsErrors,\n      metadata,\n      output,\n      boring,\n      selfHosted,\n      shouldScanFile: (fileName) => fileFilter.wantFile(fileName),\n      // This mimics the first command line argument from yargs,\n      // which should be the directory to the extension.\n      _: [sourceDir],\n    },\n    runAsBinary: shouldExitProgram,\n  });\n  return linter.run();\n}\n","/* @flow */\nimport defaultBuildExtension from './build';\nimport {\n  showDesktopNotification as defaultDesktopNotifications,\n} from '../util/desktop-notifier';\nimport * as defaultFirefoxApp from '../firefox';\nimport {\n  connectWithMaxRetries as defaultFirefoxClient,\n} from '../firefox/remote';\nimport {createLogger} from '../util/logger';\nimport defaultGetValidatedManifest from '../util/manifest';\nimport {\n  createExtensionRunner,\n  defaultReloadStrategy,\n  MultiExtensionRunner as DefaultMultiExtensionRunner,\n} from '../extension-runners';\n// Import objects that are only used as Flow types.\nimport type {FirefoxPreferences} from '../firefox/preferences';\n\nconst log = createLogger(__filename);\n\n\n// Run command types and implementation.\n\nexport type CmdRunParams = {|\n  artifactsDir: string,\n  browserConsole: boolean,\n  pref?: FirefoxPreferences,\n  firefox: string,\n  firefoxProfile?: string,\n  firefoxPort?: number,\n  ignoreFiles?: Array<string>,\n  keepProfileChanges: boolean,\n  noInput?: boolean,\n  noReload: boolean,\n  preInstall: boolean,\n  sourceDir: string,\n  startUrl?: Array<string>,\n  target?: Array<string>,\n\n  // Android CLI options.\n  adbBin?: string,\n  adbHost?: string,\n  adbPort?: string,\n  adbDevice?: string,\n  firefoxApk?: string,\n|};\n\nexport type CmdRunOptions = {|\n  buildExtension: typeof defaultBuildExtension,\n  desktopNotifications: typeof defaultDesktopNotifications,\n  firefoxApp: typeof defaultFirefoxApp,\n  firefoxClient: typeof defaultFirefoxClient,\n  reloadStrategy: typeof defaultReloadStrategy,\n  shouldExitProgram?: boolean,\n  MultiExtensionRunner?: typeof DefaultMultiExtensionRunner,\n  getValidatedManifest?: typeof defaultGetValidatedManifest,\n|};\n\nexport default async function run(\n  {\n    artifactsDir,\n    browserConsole = false,\n    pref,\n    firefox,\n    firefoxProfile,\n    firefoxPort,\n    keepProfileChanges = false,\n    ignoreFiles,\n    noInput = false,\n    noReload = false,\n    preInstall = false,\n    sourceDir,\n    startUrl,\n    target,\n    // Android CLI options.\n    adbBin,\n    adbHost,\n    adbPort,\n    adbDevice,\n    firefoxApk,\n  }: CmdRunParams,\n  {\n    buildExtension = defaultBuildExtension,\n    desktopNotifications = defaultDesktopNotifications,\n    firefoxApp = defaultFirefoxApp,\n    firefoxClient = defaultFirefoxClient,\n    reloadStrategy = defaultReloadStrategy,\n    MultiExtensionRunner = DefaultMultiExtensionRunner,\n    getValidatedManifest = defaultGetValidatedManifest,\n  }: CmdRunOptions = {}): Promise<DefaultMultiExtensionRunner> {\n\n  log.info(`Running web extension from ${sourceDir}`);\n  if (preInstall) {\n    log.info('Disabled auto-reloading because it\\'s not possible with ' +\n             '--pre-install');\n    noReload = true;\n  }\n\n  // Create an alias for --pref since it has been transformed into an\n  // object containing one or more preferences.\n  const customPrefs = pref;\n  const manifestData = await getValidatedManifest(sourceDir);\n\n  const runners = [];\n\n  const commonRunnerParams = {\n    // Common options.\n    extensions: [{sourceDir, manifestData}],\n    keepProfileChanges,\n    startUrl,\n    desktopNotifications,\n  };\n\n  if (!target || target.length === 0 || target.includes('firefox-desktop')) {\n    const firefoxDesktopRunnerParams = {\n      ...commonRunnerParams,\n\n      // Firefox specific CLI options.\n      firefoxBinary: firefox,\n      profilePath: firefoxProfile,\n      customPrefs,\n      browserConsole,\n      preInstall,\n      firefoxPort: firefoxPort,\n\n      // Firefox runner injected dependencies.\n      firefoxApp,\n      firefoxClient,\n    };\n\n    const firefoxDesktopRunner = await createExtensionRunner({\n      target: 'firefox-desktop',\n      params: firefoxDesktopRunnerParams,\n    });\n    runners.push(firefoxDesktopRunner);\n  }\n\n  if (target && target.includes('firefox-android')) {\n    const firefoxAndroidRunnerParams = {\n      ...commonRunnerParams,\n\n      // Firefox specific CLI options.\n      profilePath: firefoxProfile,\n      customPrefs,\n      browserConsole,\n      preInstall,\n      firefoxApk,\n      adbDevice,\n      adbHost,\n      adbPort,\n      adbBin,\n\n      // Injected dependencies.\n      firefoxApp,\n      firefoxClient,\n      desktopNotifications: defaultDesktopNotifications,\n      buildSourceDir: (extensionSourceDir: string, tmpArtifactsDir: string) => {\n        return buildExtension({\n          sourceDir: extensionSourceDir,\n          ignoreFiles,\n          asNeeded: false,\n          // Use a separate temporary directory for building the extension zip file\n          // that we are going to upload on the android device.\n          artifactsDir: tmpArtifactsDir,\n        }, {\n          // Suppress the message usually logged by web-ext build.\n          showReadyMessage: false,\n        });\n      },\n    };\n\n    const firefoxAndroidRunner = await createExtensionRunner({\n      target: 'firefox-android',\n      params: firefoxAndroidRunnerParams,\n    });\n    runners.push(firefoxAndroidRunner);\n  }\n\n  const extensionRunner = new MultiExtensionRunner({\n    desktopNotifications,\n    runners,\n  });\n\n  await extensionRunner.run();\n\n  if (noReload) {\n    log.info('Automatic extension reloading has been disabled');\n  } else {\n    log.info('The extension will reload if any source file changes');\n\n    reloadStrategy({\n      extensionRunner,\n      sourceDir,\n      artifactsDir,\n      ignoreFiles,\n      noInput,\n    });\n  }\n\n  return extensionRunner;\n}\n","/* @flow */\nimport path from 'path';\n\nimport {fs} from 'mz';\nimport defaultAddonSigner from 'sign-addon';\n\nimport defaultBuilder from './build';\nimport getValidatedManifest, {getManifestId} from '../util/manifest';\nimport {withTempDir} from '../util/temp-dir';\nimport {isErrorWithCode, UsageError, WebExtError} from '../errors';\nimport {prepareArtifactsDir} from '../util/artifacts';\nimport {createLogger} from '../util/logger';\nimport type {ExtensionManifest} from '../util/manifest';\n\n\nconst log = createLogger(__filename);\n\nconst defaultAsyncFsReadFile = fs.readFile.bind(fs);\n\nexport const extensionIdFile = '.web-extension-id';\n\n// Sign command types and implementation.\n\nexport type SignParams = {|\n  apiKey: string,\n  apiProxy: string,\n  apiSecret: string,\n  apiUrlPrefix: string,\n  artifactsDir: string,\n  id?: string,\n  ignoreFiles?: Array<string>,\n  sourceDir: string,\n  timeout: number,\n  verbose?: boolean,\n  channel?: string,\n|};\n\nexport type SignOptions = {\n  build?: typeof defaultBuilder,\n  signAddon?: typeof defaultAddonSigner,\n  preValidatedManifest?: ExtensionManifest,\n  shouldExitProgram?: boolean,\n};\n\nexport type SignResult = {|\n  success: boolean,\n  id: string,\n  downloadedFiles: Array<string>,\n|};\n\nexport default function sign(\n  {\n    apiKey,\n    apiProxy,\n    apiSecret,\n    apiUrlPrefix,\n    artifactsDir,\n    id,\n    ignoreFiles = [],\n    sourceDir,\n    timeout,\n    verbose,\n    channel,\n  }: SignParams,\n  {\n    build = defaultBuilder,\n    preValidatedManifest,\n    signAddon = defaultAddonSigner,\n  }: SignOptions = {}\n): Promise<SignResult> {\n  return withTempDir(\n    async function(tmpDir) {\n      await prepareArtifactsDir(artifactsDir);\n\n      let manifestData;\n\n      if (preValidatedManifest) {\n        manifestData = preValidatedManifest;\n      } else {\n        manifestData = await getValidatedManifest(sourceDir);\n      }\n\n      const [buildResult, idFromSourceDir] = await Promise.all([\n        build({sourceDir, ignoreFiles, artifactsDir: tmpDir.path()},\n              {manifestData, showReadyMessage: false}),\n        getIdFromSourceDir(sourceDir),\n      ]);\n\n      const manifestId = getManifestId(manifestData);\n\n      if (id && manifestId) {\n        throw new UsageError(\n          `Cannot set custom ID ${id} because manifest.json ` +\n          `declares ID ${manifestId}`);\n      }\n      if (id) {\n        log.debug(`Using custom ID declared as --id=${id}`);\n      }\n\n      if (manifestId) {\n        id = manifestId;\n      }\n\n      if (!id && idFromSourceDir) {\n        log.info(\n          `Using previously auto-generated extension ID: ${idFromSourceDir}`);\n        id = idFromSourceDir;\n      }\n\n      if (!id) {\n        log.warn('No extension ID specified (it will be auto-generated)');\n      }\n\n      const signingResult = await signAddon({\n        apiKey,\n        apiSecret,\n        apiUrlPrefix,\n        apiProxy,\n        timeout,\n        verbose,\n        id,\n        xpiPath: buildResult.extensionPath,\n        version: manifestData.version,\n        downloadDir: artifactsDir,\n        channel,\n      });\n\n      if (signingResult.id) {\n        await saveIdToSourceDir(sourceDir, signingResult.id);\n      }\n\n      // All information about the downloaded files would have\n      // already been logged by signAddon().\n      if (signingResult.success) {\n        log.info(`Extension ID: ${signingResult.id}`);\n        log.info('SUCCESS');\n      } else {\n        log.info('FAIL');\n        throw new WebExtError(\n          'The extension could not be signed');\n      }\n\n      return signingResult;\n    }\n  );\n}\n\n\nexport async function getIdFromSourceDir(\n  sourceDir: string,\n  asyncFsReadFile: typeof defaultAsyncFsReadFile = defaultAsyncFsReadFile,\n): Promise<string | void> {\n  const filePath = path.join(sourceDir, extensionIdFile);\n\n  let content;\n\n  try {\n    content = await asyncFsReadFile(filePath);\n  } catch (error) {\n    if (isErrorWithCode('ENOENT', error)) {\n      log.debug(`No ID file found at: ${filePath}`);\n      return;\n    }\n    throw error;\n  }\n\n  let lines = content.toString().split('\\n');\n  lines = lines.filter((line) => {\n    line = line.trim();\n    if (line && !line.startsWith('#')) {\n      return line;\n    }\n  });\n\n  const id = lines[0];\n  log.debug(`Found extension ID ${id} in ${filePath}`);\n\n  if (!id) {\n    throw new UsageError(`No ID found in extension ID file ${filePath}`);\n  }\n\n  return id;\n}\n\n\nexport async function saveIdToSourceDir(\n  sourceDir: string, id: string\n): Promise<void> {\n  const filePath = path.join(sourceDir, extensionIdFile);\n  await fs.writeFile(filePath, [\n    '# This file was created by https://github.com/mozilla/web-ext',\n    '# Your auto-generated extension ID for addons.mozilla.org is:',\n    id.toString(),\n  ].join('\\n'));\n\n  log.debug(`Saved auto-generated ID ${id} to ${filePath}`);\n}\n","/* @flow */\nimport os from 'os';\nimport path from 'path';\n\nimport requireUncached from 'require-uncached';\nimport camelCase from 'camelcase';\nimport decamelize from 'decamelize';\n\nimport fileExists from './util/file-exists';\nimport {createLogger} from './util/logger';\nimport {UsageError, WebExtError} from './errors';\n\nconst log = createLogger(__filename);\n\ntype ApplyConfigToArgvParams = {|\n  // This is the argv object which will get updated by each\n  // config applied.\n  argv: Object,\n  // This is the argv that only has CLI values applied to it.\n  argvFromCLI: Object,\n  configObject: Object,\n  options: Object,\n  configFileName: string,\n|};\n\nexport function applyConfigToArgv({\n  argv,\n  argvFromCLI,\n  configObject,\n  options,\n  configFileName,\n}: ApplyConfigToArgvParams): Object {\n  let newArgv = {...argv};\n\n  for (const option of Object.keys(configObject)) {\n    if (camelCase(option) !== option) {\n      throw new UsageError(\n        `The config option \"${option}\" must be ` +\n        `specified in camel case: \"${camelCase(option)}\"`);\n    }\n\n    // A config option cannot be a sub-command config\n    // object if it is an array.\n    if (!Array.isArray(configObject[option]) &&\n      typeof options[option] === 'object' &&\n      typeof configObject[option] === 'object') {\n      // Descend into the nested configuration for a sub-command.\n      newArgv = applyConfigToArgv({\n        argv: newArgv,\n        argvFromCLI,\n        configObject: configObject[option],\n        options: options[option],\n        configFileName});\n      continue;\n    }\n\n    const decamelizedOptName = decamelize(option, '-');\n\n    if (typeof options[decamelizedOptName] !== 'object') {\n      throw new UsageError(`The config file at ${configFileName} specified ` +\n        `an unknown option: \"${option}\"`);\n    }\n    if (options[decamelizedOptName].type === undefined) {\n      // This means yargs option type wasn't not defined correctly\n      throw new WebExtError(\n        `Option: ${option} was defined without a type.`);\n    }\n\n    const expectedType = options[decamelizedOptName].type ===\n      'count' ? 'number' : options[decamelizedOptName].type;\n\n    const optionType = (\n      Array.isArray(configObject[option]) ?\n        'array' : typeof configObject[option]\n    );\n\n    if (optionType !== expectedType) {\n      throw new UsageError(`The config file at ${configFileName} specified ` +\n        `the type of \"${option}\" incorrectly as \"${optionType}\"` +\n        ` (expected type \"${expectedType}\")`);\n    }\n\n    let defaultValue;\n    if (options[decamelizedOptName]) {\n      if (options[decamelizedOptName].default !== undefined) {\n        defaultValue = options[decamelizedOptName].default;\n      } else if (expectedType === 'boolean') {\n        defaultValue = false;\n      }\n    }\n\n    // This is our best effort (without patching yargs) to detect\n    // if a value was set on the CLI instead of in the config.\n    // It looks for a default value and if the argv value is\n    // different, it assumes that the value was configured on the CLI.\n\n    const wasValueSetOnCLI =\n      typeof argvFromCLI[option] !== 'undefined' &&\n      argvFromCLI[option] !== defaultValue;\n    if (wasValueSetOnCLI) {\n      log.debug(\n        `Favoring CLI: ${option}=${argvFromCLI[option]} over ` +\n        `configuration: ${option}=${configObject[option]}`);\n      newArgv[option] = argvFromCLI[option];\n      continue;\n    }\n\n    newArgv[option] = configObject[option];\n\n    const coerce = options[decamelizedOptName].coerce;\n    if (coerce) {\n      log.debug(\n        `Calling coerce() on configured value for ${option}`);\n      newArgv[option] = coerce(newArgv[option]);\n    }\n  }\n  return newArgv;\n}\n\nexport function loadJSConfigFile(filePath: string): Object {\n  const resolvedFilePath = path.resolve(filePath);\n  log.debug(\n    `Loading JS config file: \"${filePath}\" ` +\n    `(resolved to \"${resolvedFilePath}\")`);\n  let configObject;\n  try {\n    configObject = requireUncached(resolvedFilePath);\n  } catch (error) {\n    log.debug('Handling error:', error);\n    throw new UsageError(\n      `Cannot read config file: ${resolvedFilePath}\\n` +\n      `Error: ${error.message}`);\n  }\n  if (filePath.endsWith('package.json')) {\n    log.debug('Looking for webExt key inside package.json file');\n    configObject = configObject.webExt || {};\n  }\n  if (Object.keys(configObject).length === 0) {\n    log.debug(`Config file ${resolvedFilePath} did not define any options. ` +\n      'Did you set module.exports = {...}?');\n  }\n  return configObject;\n}\n\ntype DiscoverConfigFilesParams = {|\n  getHomeDir: () => string,\n|};\n\nexport async function discoverConfigFiles(\n  {getHomeDir = os.homedir}: DiscoverConfigFilesParams = {}\n): Promise<Array<string>> {\n  const magicConfigName = 'web-ext-config.js';\n\n  // Config files will be loaded in this order.\n  const possibleConfigs = [\n    // Look for a magic hidden config (preceded by dot) in home dir.\n    path.join(getHomeDir(), `.${magicConfigName}`),\n    // Look for webExt key inside package.json file\n    path.join(process.cwd(), 'package.json'),\n    // Look for a magic config in the current working directory.\n    path.join(process.cwd(), magicConfigName),\n  ];\n\n  const configs = await Promise.all(possibleConfigs.map(\n    async (fileName) => {\n      const resolvedFileName = path.resolve(fileName);\n      if (await fileExists(resolvedFileName)) {\n        return resolvedFileName;\n      } else {\n        log.debug(\n          `Discovered config \"${resolvedFileName}\" does not ` +\n          'exist or is not readable');\n        return undefined;\n      }\n    }\n  ));\n\n  const existingConfigs = [];\n  configs.forEach((f) => {\n    if (typeof f === 'string') {\n      existingConfigs.push(f);\n    }\n  });\n  return existingConfigs;\n}\n","/* @flow */\nimport ExtendableError from 'es6-error';\n\n\n/*\n * Base error for all custom web-ext errors.\n */\nexport class WebExtError extends ExtendableError {\n  constructor(message: string) {\n    super(message);\n  }\n}\n\n\n/*\n * The class for errors that can be fixed by the developer.\n */\nexport class UsageError extends WebExtError {\n  constructor(message: string) {\n    super(message);\n  }\n}\n\n\n/*\n * The manifest for the extension is invalid (or missing).\n */\nexport class InvalidManifest extends UsageError {\n  constructor(message: string) {\n    super(message);\n  }\n}\n\n\n/*\n * The remote Firefox does not support temporary add-on installation.\n */\nexport class RemoteTempInstallNotSupported extends WebExtError {\n  constructor(message: string) {\n    super(message);\n  }\n}\n\n/*\n * The errors collected when reloading all extensions at once\n * (initialized from a map of errors by extensionSourceDir string).\n */\nexport class MultiExtensionsReloadError extends WebExtError {\n  constructor(errorsMap: Map<string, Error>) {\n    let errors = '';\n    for (const [sourceDir, error] of errorsMap) {\n      const msg = String(error);\n      errors += `\\nError on extension loaded from ${sourceDir}: ${msg}\\n`;\n    }\n    const message = `Reload errors: ${errors}`;\n\n    super(message);\n    this.errorsBySourceDir = errorsMap;\n  }\n}\n\n/*\n * Sugar-y way to catch only instances of a certain error.\n *\n * Usage:\n *\n *  Promise.reject(SyntaxError)\n *    .catch(onlyInstancesOf(SyntaxError, (error) => {\n *      // error is guaranteed to be an instance of SyntaxError\n *    }))\n *\n * All other errors will be re-thrown.\n *\n */\nexport function onlyInstancesOf(\n  predicate: Function, errorHandler: Function\n): Function {\n  return (error) => {\n    if (error instanceof predicate) {\n      return errorHandler(error);\n    } else {\n      throw error;\n    }\n  };\n}\n\n\n/*\n * Sugar-y way to catch only errors having certain code(s).\n *\n * Usage:\n *\n *  Promise.resolve()\n *    .catch(onlyErrorsWithCode('ENOENT', (error) => {\n *      // error.code is guaranteed to be ENOENT\n *    }))\n *\n *  or:\n *\n *  Promise.resolve()\n *    .catch(onlyErrorsWithCode(['ENOENT', 'ENOTDIR'], (error) => {\n *      // ...\n *    }))\n *\n * All other errors will be re-thrown.\n *\n */\nexport function onlyErrorsWithCode(\n  codeWanted: (string | number) | Array<string | number>,\n  errorHandler: Function\n): Function {\n  return (error) => {\n    let throwError = true;\n\n    if (Array.isArray(codeWanted)) {\n      if (codeWanted.indexOf(error.code) !== -1 ||\n          codeWanted.indexOf(error.errno) !== -1) {\n        throwError = false;\n      }\n    } else if (error.code === codeWanted || error.errno === codeWanted) {\n      throwError = false;\n    }\n\n    if (throwError) {\n      throw error;\n    }\n\n    return errorHandler(error);\n  };\n}\n\nexport function isErrorWithCode(\n  codeWanted: string | Array<string>,\n  error: Object,\n): boolean {\n  if (Array.isArray(codeWanted) && codeWanted.indexOf(error.code) !== -1) {\n    return true;\n  } else if (error.code === codeWanted) {\n    return true;\n  }\n\n  return false;\n}\n","/* @flow */\n\n/**\n * This module provide an ExtensionRunner subclass that manage an extension executed\n * in a Firefox for Android instance.\n */\n\nimport net from 'net';\nimport path from 'path';\nimport readline from 'readline';\n\nimport {withTempDir} from '../util/temp-dir';\nimport DefaultADBUtils from '../util/adb';\nimport {\n  showDesktopNotification as defaultDesktopNotifications,\n} from '../util/desktop-notifier';\nimport {\n  MultiExtensionsReloadError,\n  UsageError,\n  WebExtError,\n} from '../errors';\nimport * as defaultFirefoxApp from '../firefox';\nimport {\n  connectWithMaxRetries as defaultFirefoxConnector,\n} from '../firefox/remote';\nimport {createLogger} from '../util/logger';\nimport {isTTY, setRawMode} from '../util/stdin';\nimport type {\n  ExtensionRunnerParams,\n  ExtensionRunnerReloadResult,\n} from './base';\nimport type {\n  FirefoxPreferences,\n} from '../firefox/preferences';\nimport type {\n  FirefoxRDPResponseAddon,\n  RemoteFirefox,\n} from '../firefox/remote';\nimport type {\n  ExtensionBuildResult,\n} from '../cmd/build';\n\nconst log = createLogger(__filename);\n\nexport type FirefoxAndroidExtensionRunnerParams = {|\n  ...ExtensionRunnerParams,\n\n  // Firefox specific.\n  customPrefs?: FirefoxPreferences,\n\n  // Not supported (currently ignored with logged warning).\n  preInstall?: boolean,\n  browserConsole?: boolean,\n\n  // Firefox android injected dependencies.\n  adbBin?: string,\n  adbHost?: string,\n  adbPort?: string,\n  adbDevice?: string,\n  firefoxApk?: string,\n  firefoxAndroidTimeout?: number,\n\n  // Injected Dependencies.\n  firefoxApp: typeof defaultFirefoxApp,\n  firefoxClient: typeof defaultFirefoxConnector,\n  ADBUtils?: typeof DefaultADBUtils,\n  buildSourceDir: (string, string) => Promise<ExtensionBuildResult>,\n  desktopNotifications: typeof defaultDesktopNotifications,\n  stdin?: stream$Readable,\n|};\n\n/**\n * Implements an IExtensionRunner which manages a Firefox for Android instance.\n */\nexport class FirefoxAndroidExtensionRunner {\n  // Wait 3s before the next unix socket discovery loop.\n  static unixSocketDiscoveryRetryInterval = 3 * 1000;\n  // Wait for at most 3 minutes before giving up.\n  static unixSocketDiscoveryMaxTime = 3 * 60 * 1000;\n\n  params: FirefoxAndroidExtensionRunnerParams;\n  adbUtils: DefaultADBUtils;\n  exiting: boolean;\n  selectedAdbDevice: string;\n  selectedFirefoxApk: string;\n  selectedArtifactsDir: string;\n  selectedRDPSocketFile: string;\n  selectedTCPPort: number;\n  cleanupCallbacks: Set<Function>;\n  adbExtensionsPathBySourceDir: Map<string, string>;\n  reloadableExtensions: Map<string, string>;\n  remoteFirefox: RemoteFirefox;\n\n  constructor(params: FirefoxAndroidExtensionRunnerParams) {\n    this.params = params;\n    this.cleanupCallbacks = new Set();\n    this.adbExtensionsPathBySourceDir = new Map();\n    this.reloadableExtensions = new Map();\n\n    // Print warning for not currently supported options (e.g. preInstall,\n    // cloned profiles, browser console).\n    this.printIgnoredParamsWarnings();\n  }\n\n  async run(): Promise<void> {\n    const {\n      adbBin,\n      adbHost,\n      adbPort,\n      ADBUtils = DefaultADBUtils,\n    } = this.params;\n\n    this.adbUtils = new ADBUtils({\n      adbBin, adbHost, adbPort,\n    });\n\n    await this.adbDevicesDiscoveryAndSelect();\n    await this.apkPackagesDiscoveryAndSelect();\n    await this.adbCheckRuntimePermissions();\n    await this.adbForceStopSelectedPackage();\n\n    // Create profile prefs (with enabled remote RDP server), prepare the\n    // artifacts and temporary directory on the selected device, and\n    // push the profile preferences to the remote profile dir.\n    await this.adbPrepareProfileDir();\n\n    // NOTE: running Firefox for Android on the Android Emulator can be\n    // pretty slow, we can run the following 3 steps in parallel to speed up\n    // it a bit.\n    await Promise.all([\n      // Start Firefox for Android instance on the created profile.\n      this.adbStartSelectedPackage(),\n\n      // Build and push to devices all the extension xpis\n      // and keep track of the xpi built and uploaded by extension sourceDir.\n      this.buildAndPushExtensions(),\n\n      // Wait for RDP unix socket file created and\n      // Create an ADB forward connection on a free tcp port\n      this.adbDiscoveryAndForwardRDPUnixSocket(),\n    ]);\n\n    // Connect to RDP socket on the local tcp server, install all the pushed extension\n    // and keep track of the built and installed extension by extension sourceDir.\n    await this.rdpInstallExtensions();\n  }\n\n  // Method exported from the IExtensionRunner interface.\n\n  /**\n   * Returns the runner name.\n   */\n  getName() {\n    return 'Firefox Android';\n  }\n\n  /**\n   * Reloads all the extensions, collect any reload error and resolves to\n   * an array composed by a single ExtensionRunnerReloadResult object.\n   */\n  async reloadAllExtensions(): Promise<Array<ExtensionRunnerReloadResult>> {\n    const runnerName = this.getName();\n    const reloadErrors = new Map();\n\n    for (const {sourceDir} of this.params.extensions) {\n      const [res] = await this.reloadExtensionBySourceDir(sourceDir);\n      if (res.reloadError instanceof Error) {\n        reloadErrors.set(sourceDir, res.reloadError);\n      }\n    }\n\n    if (reloadErrors.size > 0) {\n      return [{\n        runnerName,\n        reloadError: new MultiExtensionsReloadError(reloadErrors),\n      }];\n    }\n\n    return [{runnerName}];\n  }\n\n  /**\n   * Reloads a single extension, collect any reload error and resolves to\n   * an array composed by a single ExtensionRunnerReloadResult object.\n   */\n  async reloadExtensionBySourceDir(\n    extensionSourceDir: string\n  ): Promise<Array<ExtensionRunnerReloadResult>> {\n    const runnerName = this.getName();\n    const addonId = this.reloadableExtensions.get(extensionSourceDir);\n\n    if (!addonId) {\n      return [{\n        sourceDir: extensionSourceDir,\n        reloadError: new WebExtError(\n          'Extension not reloadable: ' +\n            `no addonId has been mapped to \"${extensionSourceDir}\"`\n        ),\n        runnerName,\n      }];\n    }\n\n    try {\n      await this.buildAndPushExtension(extensionSourceDir);\n      await this.remoteFirefox.reloadAddon(addonId);\n    } catch (error) {\n      return [{\n        sourceDir: extensionSourceDir,\n        reloadError: error,\n        runnerName,\n      }];\n    }\n\n    return [{runnerName, sourceDir: extensionSourceDir}];\n  }\n\n  /**\n   * Register a callback to be called when the runner has been exited\n   * (e.g. the Firefox instance exits or the user has requested web-ext\n   * to exit).\n   */\n  registerCleanup(fn: Function): void {\n    this.cleanupCallbacks.add(fn);\n  }\n\n  /**\n   * Exits the runner, by closing the managed Firefox instance.\n   */\n  async exit(): Promise<void> {\n    const {\n      adbUtils,\n      selectedAdbDevice,\n      selectedArtifactsDir,\n    } = this;\n\n    this.exiting = true;\n\n    // If a Firefox for Android instance has been started,\n    // we should ensure that it has been stopped when we exit.\n    await this.adbForceStopSelectedPackage();\n\n    if (selectedArtifactsDir) {\n      log.debug('Cleaning up artifacts directory on the Android device...');\n      await adbUtils.clearArtifactsDir(selectedAdbDevice);\n    }\n\n    // Call all the registered cleanup callbacks.\n    for (const fn of this.cleanupCallbacks) {\n      try {\n        fn();\n      } catch (error) {\n        log.error(error);\n      }\n    }\n  }\n\n  // Private helper methods.\n\n  getDeviceProfileDir(): string {\n    return `${this.selectedArtifactsDir}/profile`;\n  }\n\n  printIgnoredParamsWarnings() {\n    if (this.params.profilePath) {\n      log.warn(\n        'Firefox for Android target does not support custom profile paths.'\n      );\n    }\n\n    if (this.params.keepProfileChanges) {\n      log.warn(\n        'Firefox for Android target does not support --keep-profile-changes.'\n      );\n    }\n\n    if (this.params.browserConsole) {\n      log.warn(\n        'Firefox for Android target does not support --browser-console option.'\n      );\n    }\n\n    if (this.params.preInstall) {\n      log.warn(\n        'Firefox for Android target does not support --pre-install option.'\n      );\n    }\n\n    if (this.params.startUrl) {\n      log.warn(\n        'Firefox for Android target does not support --start-url option.'\n      );\n    }\n  }\n\n  async adbDevicesDiscoveryAndSelect() {\n    const {adbUtils} = this;\n    const {adbDevice} = this.params;\n    let devices = [];\n\n    log.debug('Listing android devices');\n    devices = await adbUtils.discoverDevices();\n\n    if (devices.length === 0) {\n      throw new UsageError(\n        'No Android device found through ADB. ' +\n        'Make sure the device is connected and USB debugging is enabled.'\n      );\n    }\n\n    if (!adbDevice) {\n      const devicesMsg = devices.map((dev) => ` - ${dev}`).join('\\n');\n      log.info(`\\nAndroid devices found:\\n${devicesMsg}`);\n      throw new UsageError(\n        'Select an android device using --android-device=<name>');\n    }\n\n    const foundDevices = devices.filter((device) => {\n      return device === adbDevice;\n    });\n\n    if (foundDevices.length === 0) {\n      const devicesMsg = JSON.stringify(devices);\n      throw new UsageError(\n        `Android device ${adbDevice} was not found in list: ${devicesMsg}`);\n    }\n\n    this.selectedAdbDevice = foundDevices[0];\n    log.info(`Selected ADB device: ${this.selectedAdbDevice}`);\n  }\n\n  async apkPackagesDiscoveryAndSelect() {\n    const {\n      adbUtils,\n      selectedAdbDevice,\n      params: {\n        firefoxApk,\n      },\n    } = this;\n    // Discovery and select a Firefox for Android version.\n    const packages = await adbUtils.discoverInstalledFirefoxAPKs(\n      selectedAdbDevice,\n      firefoxApk\n    );\n\n    if (packages.length === 0) {\n      throw new UsageError(\n        'No Firefox packages were found on the selected Android device');\n    }\n\n    const pkgsListMsg = (pkgs) => {\n      return pkgs.map((pkg) => ` - ${ pkg}`).join('\\n');\n    };\n\n    if (!firefoxApk) {\n      log.info(`\\nPackages found:\\n${pkgsListMsg(packages)}`);\n\n      if (packages.length > 1) {\n        throw new UsageError('Select one of the packages using --firefox-apk');\n      }\n\n      // If only one APK has been found, select it even if it has not been\n      // specified explicitly on the comment line.\n      this.selectedFirefoxApk = packages[0];\n      log.info(`Selected Firefox for Android APK: ${this.selectedFirefoxApk}`);\n      return;\n    }\n\n    const filteredPackages = packages.filter((line) => line === firefoxApk);\n\n    if (filteredPackages.length === 0) {\n      const pkgsList = pkgsListMsg(filteredPackages);\n      throw new UsageError(\n        `Package ${firefoxApk} was not found in list: ${pkgsList}`\n      );\n    }\n\n    this.selectedFirefoxApk = filteredPackages[0];\n    log.debug(`Selected Firefox for Android APK: ${this.selectedFirefoxApk}`);\n  }\n\n  async adbForceStopSelectedPackage() {\n    const {\n      adbUtils,\n      selectedAdbDevice,\n      selectedFirefoxApk,\n    } = this;\n\n    log.info(`Stopping existing instances of ${selectedFirefoxApk}...`);\n    await adbUtils.amForceStopAPK(selectedAdbDevice, selectedFirefoxApk);\n  }\n\n  async adbCheckRuntimePermissions() {\n    const {\n      adbUtils,\n      selectedAdbDevice,\n      selectedFirefoxApk,\n    } = this;\n\n    log.debug(`Discovering Android version for ${selectedAdbDevice}...`);\n\n    const androidVersion = await adbUtils.getAndroidVersionNumber(\n      selectedAdbDevice\n    );\n\n    if (typeof androidVersion !== 'number' || Number.isNaN(androidVersion)) {\n      throw new WebExtError(`Invalid Android version: ${androidVersion}`);\n    }\n\n    log.debug(`Detected Android version ${androidVersion}`);\n\n    if (androidVersion < 23) {\n      return;\n    }\n\n    log.debug('Checking read/write permissions needed for web-ext' +\n              `on ${selectedFirefoxApk}...`);\n\n    // Runtime permission needed to be able to run Firefox on a temporarily created profile\n    // on android versions >= 23 (Android Marshmallow, which is the first version where\n    // these permissions are optional and have to be granted explicitly).\n    await adbUtils.ensureRequiredAPKRuntimePermissions(\n      selectedAdbDevice, selectedFirefoxApk, [\n        'android.permission.READ_EXTERNAL_STORAGE',\n        'android.permission.WRITE_EXTERNAL_STORAGE',\n      ]\n    );\n  }\n\n  async adbPrepareProfileDir() {\n    const {\n      adbUtils,\n      selectedAdbDevice,\n      selectedFirefoxApk,\n      params: {\n        firefoxApp,\n      },\n    } = this;\n    // Create the preferences file and the Fennec temporary profile.\n    log.debug(`Preparing a temporary profile for ${selectedFirefoxApk}...`);\n\n    const profile = await firefoxApp.createProfile({app: 'fennec'});\n\n    // Choose a artifacts dir name for the assets pushed to the\n    // Android device.\n    this.selectedArtifactsDir = await adbUtils.getOrCreateArtifactsDir(\n      selectedAdbDevice\n    );\n\n    const deviceProfileDir = this.getDeviceProfileDir();\n\n    await adbUtils.runShellCommand(selectedAdbDevice, [\n      'mkdir', '-p', deviceProfileDir,\n    ]);\n    await adbUtils.pushFile(selectedAdbDevice,\n                            path.join(profile.profileDir, 'user.js'),\n                            `${deviceProfileDir}/user.js`);\n\n    log.debug(`Created temporary profile at ${deviceProfileDir}.`);\n  }\n\n  async adbStartSelectedPackage() {\n    const {\n      adbUtils,\n      selectedFirefoxApk,\n      selectedAdbDevice,\n    } = this;\n\n    const deviceProfileDir = this.getDeviceProfileDir();\n\n    log.info(`Starting ${selectedFirefoxApk}...`);\n\n    log.debug(`Using profile ${deviceProfileDir}`);\n\n    await adbUtils.startFirefoxAPK(\n      selectedAdbDevice, selectedFirefoxApk, deviceProfileDir\n    );\n  }\n\n  async buildAndPushExtension(sourceDir: string) {\n    const {\n      adbUtils,\n      selectedAdbDevice,\n      selectedArtifactsDir,\n      params: {\n        buildSourceDir,\n      },\n    } = this;\n\n    await withTempDir(async (tmpDir) => {\n      const {extensionPath} = await buildSourceDir(sourceDir, tmpDir.path());\n\n      const extFileName = path.basename(extensionPath, '.zip');\n\n      let adbExtensionPath = this.adbExtensionsPathBySourceDir.get(sourceDir);\n\n      if (!adbExtensionPath) {\n        adbExtensionPath = `${selectedArtifactsDir}/${extFileName}.xpi`;\n      }\n\n      log.debug(`Uploading ${extFileName} on the android device`);\n\n      await adbUtils.pushFile(\n        selectedAdbDevice, extensionPath, adbExtensionPath\n      );\n\n      log.debug(`Upload completed: ${adbExtensionPath}`);\n\n      this.adbExtensionsPathBySourceDir.set(sourceDir, adbExtensionPath);\n    });\n  }\n\n  async buildAndPushExtensions() {\n    for (const {sourceDir} of this.params.extensions) {\n      await this.buildAndPushExtension(sourceDir);\n    }\n  }\n\n  async adbDiscoveryAndForwardRDPUnixSocket() {\n    const {\n      adbUtils,\n      selectedAdbDevice,\n      selectedFirefoxApk,\n      params: {\n        firefoxAndroidTimeout,\n      },\n    } = this;\n\n    const stdin = this.params.stdin || process.stdin;\n\n    const {\n      unixSocketDiscoveryRetryInterval,\n    } = FirefoxAndroidExtensionRunner;\n\n    let {\n      unixSocketDiscoveryMaxTime,\n    } = FirefoxAndroidExtensionRunner;\n\n    if (typeof firefoxAndroidTimeout === 'number') {\n      unixSocketDiscoveryMaxTime = firefoxAndroidTimeout;\n    }\n\n    const handleCtrlC = (str, key) => {\n      if (key.ctrl && key.name === 'c') {\n        adbUtils.setUserAbortDiscovery(true);\n      }\n    };\n\n    // TODO: use noInput property to decide if we should\n    // disable direct keypress handling.\n    if (isTTY(stdin)) {\n      readline.emitKeypressEvents(stdin);\n      setRawMode(stdin, true);\n\n      stdin.on('keypress', handleCtrlC);\n    }\n\n    try {\n      // Got a debugger socket file to connect.\n      this.selectedRDPSocketFile = (\n        await adbUtils.discoverRDPUnixSocket(\n          selectedAdbDevice, selectedFirefoxApk, {\n            maxDiscoveryTime: unixSocketDiscoveryMaxTime,\n            retryInterval: unixSocketDiscoveryRetryInterval,\n          }\n        )\n      );\n    } finally {\n      if (isTTY(stdin)) {\n        stdin.removeListener('keypress', handleCtrlC);\n      }\n    }\n\n    log.debug(`RDP Socket File selected: ${this.selectedRDPSocketFile}`);\n\n    const tcpPort = await this.chooseLocalTcpPort();\n\n    // Log the choosen tcp port at info level (useful to the user to be able\n    // to connect the Firefox DevTools to the Firefox for Android instance).\n    log.info(`You can connect to this Android device on TCP port ${tcpPort}`);\n\n    const forwardSocketSpec = this.selectedRDPSocketFile.startsWith('@') ?\n      `localabstract:${this.selectedRDPSocketFile.substr(1)}`\n      : `localfilesystem:${this.selectedRDPSocketFile}`;\n\n    await adbUtils.setupForward(\n      selectedAdbDevice,\n      forwardSocketSpec,\n      `tcp:${tcpPort}`\n    );\n\n    this.selectedTCPPort = tcpPort;\n  }\n\n  chooseLocalTcpPort(): Promise<number> {\n    return new Promise((resolve) => {\n      const srv = net.createServer();\n      // $FLOW_FIXME: flow has his own opinions on this method signature.\n      srv.listen(0, () => {\n        const freeTcpPort = srv.address().port;\n        srv.close();\n        resolve(freeTcpPort);\n      });\n    });\n  }\n\n  async rdpInstallExtensions() {\n    const {\n      selectedTCPPort,\n      params: {\n        extensions,\n        firefoxClient,\n      },\n    } = this;\n\n    const remoteFirefox = this.remoteFirefox = await firefoxClient({\n      port: selectedTCPPort,\n    });\n\n    // Exit and cleanup the extension runner if the connection to the\n    // remote Firefox for Android instance has been closed.\n    remoteFirefox.client.on('end', () => {\n      if (!this.exiting) {\n        log.info('Exiting the device because Firefox for Android disconnected');\n        this.exit();\n      }\n    });\n\n    // Install all the temporary addons.\n    for (const extension of extensions) {\n      const {sourceDir} = extension;\n      const adbExtensionPath = this.adbExtensionsPathBySourceDir.get(\n        sourceDir\n      );\n\n      if (!adbExtensionPath) {\n        throw new WebExtError(\n          `ADB extension path for \"${sourceDir}\" was unexpectedly empty`\n        );\n      }\n\n      const addonId = await (\n        remoteFirefox.installTemporaryAddon(adbExtensionPath)\n          .then((installResult: FirefoxRDPResponseAddon) => {\n            return installResult.addon.id;\n          })\n      );\n\n      if (!addonId) {\n        throw new WebExtError(\n          'Received an empty addonId from ' +\n          `remoteFirefox.installTemporaryAddon(\"${adbExtensionPath}\")`\n        );\n      }\n\n      this.reloadableExtensions.set(extension.sourceDir, addonId);\n    }\n  }\n}\n","/* @flow */\n\n/**\n * This module provide an ExtensionRunner subclass that manage an extension executed\n * in a Firefox for Desktop instance.\n */\n\n// Import flow types from npm dependencies.\nimport type FirefoxProfile from 'firefox-profile';\n\nimport {\n  MultiExtensionsReloadError,\n  RemoteTempInstallNotSupported,\n  WebExtError,\n} from '../errors';\nimport * as defaultFirefoxApp from '../firefox';\nimport {\n  connectWithMaxRetries as defaultFirefoxConnector,\n} from '../firefox/remote';\nimport {createLogger} from '../util/logger';\n// Import flow types from project files.\nimport type {\n  FirefoxRDPResponseAddon,\n  RemoteFirefox,\n} from '../firefox/remote';\nimport type {\n  ExtensionRunnerParams,\n  ExtensionRunnerReloadResult,\n} from './base';\nimport type {FirefoxPreferences} from '../firefox/preferences';\nimport type {FirefoxInfo} from '../firefox/index';\nimport EventEmitter from \"events\"; // eslint-disable-line import/named\n\ntype FirefoxDesktopSpecificRunnerParams = {|\n  customPrefs?: FirefoxPreferences,\n  browserConsole: boolean,\n  firefoxBinary: string,\n  firefoxPort: number,\n  preInstall: boolean,\n\n  // Firefox desktop injected dependencies.\n  firefoxApp: typeof defaultFirefoxApp,\n  firefoxClient: typeof defaultFirefoxConnector,\n|};\n\nexport type FirefoxDesktopExtensionRunnerParams = {|\n  ...ExtensionRunnerParams,\n  // Firefox desktop CLI params.\n  ...FirefoxDesktopSpecificRunnerParams,\n|};\n\nconst log = createLogger(__filename);\n\n/**\n * Implements an IExtensionRunner which manages a Firefox Desktop instance.\n */\nexport class FirefoxDesktopExtensionRunner {\n  cleanupCallbacks: Set<Function>;\n  params: FirefoxDesktopExtensionRunnerParams;\n  profile: FirefoxProfile;\n  // Map extensions sourceDir to their related addon ids.\n  reloadableExtensions: Map<string, string>;\n  remoteFirefox: RemoteFirefox;\n  runningInfo: FirefoxInfo;\n\n  constructor(params: FirefoxDesktopExtensionRunnerParams) {\n    this.params = params;\n\n    this.reloadableExtensions = new Map();\n    this.cleanupCallbacks = new Set();\n  }\n\n  // Method exported from the IExtensionRunner interface.\n\n  /**\n   * Returns the runner name.\n   */\n  getName() {\n    return 'Firefox Desktop';\n  }\n\n  /**\n   * Setup the Firefox Profile and run a Firefox Desktop instance.\n   */\n  async run(): Promise<void> {\n    const {\n      firefoxPort,\n    } = this.params;\n\n    if (!firefoxPort) {\n        // (unless connecting to an existing instance)\n        // Get a firefox profile with the custom Prefs set (a new or a cloned one).\n        // Pre-install extensions as proxy if needed (and disable auto-reload if you do)\n        await this.setupProfileDir();\n    }\n\n    // (if reload is enabled):\n    // - Connect to the firefox instance on RDP\n    // - Install any extension if needed (if not installed as proxy)\n    // - Keep track of the extension id assigned in a map with the sourceDir as a key\n    await this.startFirefoxInstance();\n  }\n\n  /**\n   * Reloads all the extensions, collect any reload error and resolves to\n   * an array composed by a single ExtensionRunnerReloadResult object.\n   */\n  async reloadAllExtensions(): Promise<Array<ExtensionRunnerReloadResult>> {\n    const runnerName = this.getName();\n    const reloadErrors = new Map();\n    for (const {sourceDir} of this.params.extensions) {\n      const [res] = await this.reloadExtensionBySourceDir(sourceDir);\n      if (res.reloadError instanceof Error) {\n        reloadErrors.set(sourceDir, res.reloadError);\n      }\n    }\n\n    if (reloadErrors.size > 0) {\n      return [{\n        runnerName,\n        reloadError: new MultiExtensionsReloadError(reloadErrors),\n      }];\n    }\n\n    return [{runnerName}];\n  }\n\n  /**\n   * Reloads a single extension, collect any reload error and resolves to\n   * an array composed by a single ExtensionRunnerReloadResult object.\n   */\n  async reloadExtensionBySourceDir(\n    extensionSourceDir: string\n  ): Promise<Array<ExtensionRunnerReloadResult>> {\n    const runnerName = this.getName();\n    const addonId = this.reloadableExtensions.get(extensionSourceDir);\n\n    if (!addonId) {\n      return [{\n        sourceDir: extensionSourceDir,\n        reloadError: new WebExtError(\n          'Extension not reloadable: ' +\n          `no addonId has been mapped to \"${extensionSourceDir}\"`\n        ),\n        runnerName,\n      }];\n    }\n\n    try {\n      await this.remoteFirefox.reloadAddon(addonId);\n    } catch (error) {\n      return [{\n        sourceDir: extensionSourceDir,\n        reloadError: error,\n        runnerName,\n      }];\n    }\n\n    return [{runnerName, sourceDir: extensionSourceDir}];\n  }\n\n  /**\n   * Register a callback to be called when the runner has been exited\n   * (e.g. the Firefox instance exits or the user has requested web-ext\n   * to exit).\n   */\n  registerCleanup(fn: Function): void {\n    this.cleanupCallbacks.add(fn);\n  }\n\n  /**\n   * Exits the runner, by closing the managed Firefox instance.\n   */\n  async exit(): Promise<void> {\n    if (!this.runningInfo || !this.runningInfo.firefox) {\n      throw new WebExtError('No firefox instance is currently running');\n    }\n\n    this.runningInfo.firefox.kill();\n  }\n\n  // Private helper methods.\n\n  async setupProfileDir() {\n    const {\n      customPrefs,\n      extensions,\n      keepProfileChanges,\n      preInstall,\n      profilePath,\n      firefoxApp,\n      firefoxPort,\n    } = this.params;\n\n    if (profilePath) {\n      if (keepProfileChanges) {\n        log.debug(`Using Firefox profile from ${profilePath}`);\n        this.profile = await firefoxApp.useProfile(profilePath, {customPrefs});\n      } else {\n        log.debug(`Copying Firefox profile from ${profilePath}`);\n        this.profile = await firefoxApp.copyProfile(profilePath, {customPrefs});\n      }\n    } else {\n      log.debug('Creating new Firefox profile');\n      this.profile = await firefoxApp.createProfile({customPrefs});\n    }\n\n    // preInstall the extensions if needed.\n    if (preInstall) {\n      for (const extension of extensions) {\n        await firefoxApp.installExtension({\n          asProxy: true,\n          extensionPath: extension.sourceDir,\n          manifestData: extension.manifestData,\n          profile: this.profile,\n        });\n      }\n    }\n  }\n\n  runCleanup() {\n    for (const cleanupCb of this.cleanupCallbacks) {\n      try {\n        cleanupCb();\n      } catch (error) {\n        log.error(`Exception on executing cleanup callback: ${error}`);\n      }\n    }\n  }\n\n  async startFirefoxInstance() {\n    const {\n      browserConsole,\n      extensions,\n      firefoxBinary,\n      firefoxPort,\n      preInstall,\n      startUrl,\n      firefoxApp,\n      firefoxClient,\n    } = this.params;\n\n\n    if (firefoxPort) {\n        // Connect to an already running Firefox\n        let cleanupCallbacks = this.cleanupCallbacks;\n        let runCleanup = this.runCleanup.bind(this);\n\n        // TODO mock running info. Turn into something real or allow\n        // FirefoxProcess to be null\n        this.runningInfo = {\n          debuggerPort: firefoxPort,\n          firefox: {\n            kill: runCleanup,\n            stderr: new EventEmitter(),\n            stdout: new EventEmitter(),\n          }\n        };\n    } else {\n        const binaryArgs = [];\n\n        if (browserConsole) {\n          binaryArgs.push('-jsconsole');\n        }\n        if (startUrl) {\n          const urls = Array.isArray(startUrl) ? startUrl : [startUrl];\n          for (const url of urls) {\n            binaryArgs.push('--url', url);\n          }\n        }\n\n        this.runningInfo = await firefoxApp.run(this.profile, {\n          firefoxBinary, binaryArgs,\n        });\n\n        this.runningInfo.firefox.on('close', () => {\n          this.runCleanup()\n        });\n    }\n\n    if (!preInstall) {\n      const remoteFirefox = this.remoteFirefox = await firefoxClient({\n        port: this.runningInfo.debuggerPort,\n      });\n\n      // Install all the temporary addons.\n      for (const extension of extensions) {\n        try {\n          const addonId = await (\n            remoteFirefox.installTemporaryAddon(extension.sourceDir)\n              .then((installResult: FirefoxRDPResponseAddon) => {\n                return installResult.addon.id;\n              })\n          );\n\n          if (!addonId) {\n            throw new WebExtError(\n              'Unexpected missing addonId in the installAsTemporaryAddon result'\n            );\n          }\n\n          this.reloadableExtensions.set(extension.sourceDir, addonId);\n        } catch (error) {\n          if (error instanceof RemoteTempInstallNotSupported) {\n            log.debug(`Caught: ${error}`);\n            throw new WebExtError(\n              'Temporary add-on installation is not supported in this version' +\n              ' of Firefox (you need Firefox 49 or higher). For older Firefox' +\n              ' versions, use --pre-install'\n            );\n          } else {\n            throw error;\n          }\n        }\n      }\n    }\n  }\n}\n","/* @flow */\n\nimport readline from 'readline';\n\nimport type Watchpack from 'watchpack';\n\nimport type {\n  IExtensionRunner, // eslint-disable-line import/named\n  ExtensionRunnerReloadResult,\n} from './base';\nimport {WebExtError} from '../errors';\nimport {\n  showDesktopNotification as defaultDesktopNotifications,\n} from '../util/desktop-notifier';\nimport type {FirefoxAndroidExtensionRunnerParams} from './firefox-android';\nimport type {FirefoxDesktopExtensionRunnerParams} from './firefox-desktop';\nimport {createLogger} from '../util/logger';\nimport type {FileFilterCreatorFn} from '../util/file-filter';\nimport {\n  createFileFilter as defaultFileFilterCreator,\n} from '../util/file-filter';\nimport {\n  isTTY, setRawMode,\n} from '../util/stdin';\nimport defaultSourceWatcher from '../watcher';\nimport type {OnSourceChangeFn} from '../watcher';\n\n\nconst log = createLogger(__filename);\n\nexport type ExtensionRunnerConfig = {|\n  target: 'firefox-desktop',\n  params: FirefoxDesktopExtensionRunnerParams,\n|} | {|\n  target: 'firefox-android',\n  params: FirefoxAndroidExtensionRunnerParams,\n|};\n\nexport type MultiExtensionRunnerParams = {|\n  runners: Array<IExtensionRunner>,\n  desktopNotifications: typeof defaultDesktopNotifications,\n|};\n\nexport async function createExtensionRunner(config: ExtensionRunnerConfig) {\n  switch (config.target) {\n    case 'firefox-desktop': {\n      // TODO: use async import instead of require - https://github.com/mozilla/web-ext/issues/1306\n      const {FirefoxDesktopExtensionRunner} = require('./firefox-desktop');\n      return new FirefoxDesktopExtensionRunner(config.params);\n    }\n    case 'firefox-android': {\n      // TODO: use async import instead of require - https://github.com/mozilla/web-ext/issues/1306\n      const {FirefoxAndroidExtensionRunner} = require('./firefox-android');\n      return new FirefoxAndroidExtensionRunner(config.params);\n    }\n    default:\n      throw new WebExtError(`Unknown target: \"${config.target}\"`);\n  }\n}\n\n/**\n * Implements an IExtensionRunner which allow the caller to\n * manage multiple extension runners at the same time (e.g. by running\n * a Firefox Desktop instance alongside to a Firefox for Android instance).\n */\nexport class MultiExtensionRunner {\n  extensionRunners: Array<IExtensionRunner>;\n  desktopNotifications: typeof defaultDesktopNotifications;\n\n  constructor(params: MultiExtensionRunnerParams) {\n    this.extensionRunners = params.runners;\n    this.desktopNotifications = params.desktopNotifications;\n  }\n\n  // Method exported from the IExtensionRunner interface.\n\n  /**\n   * Returns the runner name.\n   */\n  getName() {\n    return 'Multi Extension Runner';\n  }\n\n  /**\n   * Call the `run` method on all the managed extension runners,\n   * and awaits that all the runners has been successfully started.\n   */\n  async run(): Promise<void> {\n    const promises = [];\n    for (const runner of this.extensionRunners) {\n      promises.push(runner.run());\n    }\n\n    await Promise.all(promises);\n  }\n\n  /**\n   * Reloads all the extensions on all the managed extension runners,\n   * collect any reload error, and resolves to an array composed by\n   * a ExtensionRunnerReloadResult object per managed runner.\n   *\n   * Any detected reload error is also logged on the terminal and shows as a\n   * desktop notification.\n   */\n  async reloadAllExtensions(): Promise<Array<ExtensionRunnerReloadResult>> {\n    log.debug('Reloading all reloadable add-ons');\n\n    const promises = [];\n    for (const runner of this.extensionRunners) {\n      const reloadPromise = runner.reloadAllExtensions().then(\n        () => {\n          return {runnerName: runner.getName()};\n        },\n        (error) => {\n          return {\n            runnerName: runner.getName(),\n            reloadError: error,\n          };\n        }\n      );\n\n      promises.push(reloadPromise);\n    }\n\n    return await Promise.all(promises).then((results) => {\n      this.handleReloadResults(results);\n      return results;\n    });\n  }\n\n  /**\n   * Reloads a single extension on all the managed extension runners,\n   * collect any reload error and resolves to an array composed by\n   * a ExtensionRunnerReloadResult object per managed runner.\n   *\n   * Any detected reload error is also logged on the terminal and shows as a\n   * desktop notification.\n   */\n  async reloadExtensionBySourceDir(\n    sourceDir: string\n  ): Promise<Array<ExtensionRunnerReloadResult>> {\n    log.debug(`Reloading add-on at ${sourceDir}`);\n\n    const promises = [];\n    for (const runner of this.extensionRunners) {\n      const reloadPromise = runner.reloadExtensionBySourceDir(sourceDir).then(\n        () => {\n          return {runnerName: runner.getName(), sourceDir};\n        },\n        (error) => {\n          return {\n            runnerName: runner.getName(),\n            reloadError: error,\n            sourceDir,\n          };\n        }\n      );\n\n      promises.push(reloadPromise);\n    }\n\n    // $FLOW_FIXME: When upgrading to Flow 0.61.0, it could not follow the type of sourceDir in the array of promises.\n    return await Promise.all(promises).then((results) => {\n      this.handleReloadResults(results);\n      return results;\n    });\n  }\n\n  /**\n   * Register a callback to be called when all the managed runners has been exited.\n   */\n  registerCleanup(cleanupCallback: Function): void {\n    const promises = [];\n\n    // Create a promise for every extension runner managed by this instance,\n    // the promise will be resolved when the particular runner calls its\n    // registered cleanup callbacks.\n    for (const runner of this.extensionRunners) {\n      promises.push(new Promise((resolve) => {\n        runner.registerCleanup(resolve);\n      }));\n    }\n\n    // Wait for all the created promises to be resolved or rejected\n    // (once each one of the runners has cleaned up) and then call\n    // the cleanup callback registered to this runner.\n    Promise.all(promises).then(cleanupCallback, cleanupCallback);\n  }\n\n  /**\n   * Exits all the managed runner has been exited.\n   */\n  async exit(): Promise<void> {\n    const promises = [];\n    for (const runner of this.extensionRunners) {\n      promises.push(runner.exit());\n    }\n\n    await Promise.all(promises);\n  }\n\n  // Private helper methods.\n\n  handleReloadResults(results: Array<ExtensionRunnerReloadResult>): void {\n    for (const {runnerName, reloadError, sourceDir} of results) {\n      if (reloadError instanceof Error) {\n        let message = 'Error occurred while reloading';\n        if (sourceDir) {\n          message += ` \"${sourceDir}\" `;\n        }\n\n        message += `on \"${runnerName}\" - ${reloadError.message}`;\n\n        log.error(`\\n${message}`);\n        log.debug(reloadError.stack);\n\n        this.desktopNotifications({\n          title: 'web-ext run: extension reload error',\n          message,\n        });\n      }\n    }\n  }\n}\n\n// defaultWatcherCreator types and implementation.\n\nexport type WatcherCreatorParams = {|\n  reloadExtension: (string) => void,\n  sourceDir: string,\n  artifactsDir: string,\n  onSourceChange?: OnSourceChangeFn,\n  ignoreFiles?: Array<string>,\n  createFileFilter?: FileFilterCreatorFn,\n|};\n\nexport type WatcherCreatorFn = (params: WatcherCreatorParams) => Watchpack;\n\nexport function defaultWatcherCreator(\n  {\n    reloadExtension, sourceDir, artifactsDir, ignoreFiles,\n    onSourceChange = defaultSourceWatcher,\n    createFileFilter = defaultFileFilterCreator,\n  }: WatcherCreatorParams\n): Watchpack {\n  const fileFilter = createFileFilter(\n    {sourceDir, artifactsDir, ignoreFiles}\n  );\n  return onSourceChange({\n    sourceDir,\n    artifactsDir,\n    onChange: () => reloadExtension(sourceDir),\n    shouldWatchFile: (file) => fileFilter.wantFile(file),\n  });\n}\n\n\n// defaultReloadStrategy types and implementation.\n\nexport type ReloadStrategyParams = {|\n  extensionRunner: IExtensionRunner,\n  sourceDir: string,\n  artifactsDir: string,\n  ignoreFiles?: Array<string>,\n  noInput?: boolean,\n|};\n\nexport type ReloadStrategyOptions = {|\n  createWatcher?: WatcherCreatorFn,\n  stdin?: stream$Readable,\n  kill?: typeof process.kill,\n|};\n\nexport function defaultReloadStrategy(\n  {\n    artifactsDir,\n    extensionRunner,\n    ignoreFiles,\n    noInput = false,\n    sourceDir,\n  }: ReloadStrategyParams,\n  {\n    createWatcher = defaultWatcherCreator,\n    stdin = process.stdin,\n    kill = process.kill,\n  }: ReloadStrategyOptions = {}\n): void {\n  const allowInput = !noInput;\n  if (!allowInput) {\n    log.debug('Input has been disabled because of noInput==true');\n  }\n\n  const watcher: Watchpack = createWatcher({\n    reloadExtension: (watchedSourceDir) => {\n      extensionRunner.reloadExtensionBySourceDir(watchedSourceDir);\n    },\n    sourceDir,\n    artifactsDir,\n    ignoreFiles,\n  });\n\n  extensionRunner.registerCleanup(() => {\n    watcher.close();\n    if (allowInput) {\n      stdin.pause();\n    }\n  });\n\n  if (allowInput && isTTY(stdin)) {\n    readline.emitKeypressEvents(stdin);\n    setRawMode(stdin, true);\n\n    const keypressUsageInfo = 'Press R to reload (and Ctrl-C to quit)';\n\n    // NOTE: this `Promise.resolve().then(...)` is basically used to spawn a \"co-routine\"\n    // that is executed before the callback attached to the Promise returned by this function\n    // (and it allows the `run` function to not be stuck in the while loop).\n    Promise.resolve().then(async function() {\n      log.info(keypressUsageInfo);\n\n      let userExit = false;\n\n      while (!userExit) {\n        const keyPressed = await new Promise((resolve) => {\n          stdin.once('keypress', (str, key) => resolve(key));\n        });\n\n        if (keyPressed.ctrl && keyPressed.name === 'c') {\n          userExit = true;\n        } else if (keyPressed.name === 'z') {\n          // Prepare to suspend.\n\n          // NOTE: Switch the raw mode off before suspending (needed to make the keypress event\n          // to work correctly when the nodejs process is resumed).\n          setRawMode(stdin, false);\n\n          log.info('\\nweb-ext has been suspended on user request');\n          kill(process.pid, 'SIGTSTP');\n\n          // Prepare to resume.\n\n          log.info(`\\nweb-ext has been resumed. ${keypressUsageInfo}`);\n\n          // Switch the raw mode on on resume.\n          setRawMode(stdin, true);\n        } else if (keyPressed.name === 'r') {\n          log.debug('Reloading installed extensions on user request');\n          extensionRunner.reloadAllExtensions();\n        }\n      }\n\n      log.info('\\nExiting web-ext on user request');\n      extensionRunner.exit();\n    });\n  }\n}\n","/* @flow */\nimport nodeFs from 'fs';\nimport path from 'path';\n\nimport {default as defaultFxRunner} from 'fx-runner';\nimport FirefoxProfile, {copyFromUserProfile as defaultUserProfileCopier}\n  from 'firefox-profile';\nimport {fs} from 'mz';\nimport promisify from 'es6-promisify';\nimport eventToPromise from 'event-to-promise';\n\nimport isDirectory from '../util/is-directory';\nimport {isErrorWithCode, UsageError, WebExtError} from '../errors';\nimport {getPrefs as defaultPrefGetter} from './preferences';\nimport {getManifestId} from '../util/manifest';\nimport {createLogger} from '../util/logger';\nimport {connect as defaultFirefoxConnector, REMOTE_PORT} from './remote';\n// Import flow types\nimport type {FirefoxConnectorFn} from './remote';\nimport type {\n  PreferencesAppName,\n  PreferencesGetterFn,\n  FirefoxPreferences,\n} from './preferences';\nimport type {ExtensionManifest} from '../util/manifest';\n\n\nconst log = createLogger(__filename);\n\nconst defaultAsyncFsStat = fs.stat.bind(fs);\n\nexport const defaultFirefoxEnv = {\n  XPCOM_DEBUG_BREAK: 'stack',\n  NS_TRACE_MALLOC_DISABLE_STACKS: '1',\n};\n\n// defaultRemotePortFinder types and implementation.\n\nexport type RemotePortFinderParams = {|\n  portToTry?: number,\n  retriesLeft?: number,\n  connectToFirefox?: FirefoxConnectorFn,\n|};\n\nexport type RemotePortFinderFn =\n  (params?: RemotePortFinderParams) => Promise<number>;\n\nexport async function defaultRemotePortFinder(\n  {\n    portToTry = REMOTE_PORT,\n    retriesLeft = 10,\n    connectToFirefox = defaultFirefoxConnector,\n  }: RemotePortFinderParams = {}\n): Promise<number> {\n  log.debug(`Checking if remote Firefox port ${portToTry} is available`);\n\n  let client;\n\n  while (retriesLeft >= 0) {\n    try {\n      client = await connectToFirefox(portToTry);\n      log.debug(`Remote Firefox port ${portToTry} is in use ` +\n                `(retries remaining: ${retriesLeft})`);\n    } catch (error) {\n      if (isErrorWithCode('ECONNREFUSED', error)) {\n        // The connection was refused so this port is good to use.\n        return portToTry;\n      }\n\n      throw error;\n    }\n\n    client.disconnect();\n    portToTry++;\n    retriesLeft--;\n  }\n\n  throw new WebExtError('Too many retries on port search');\n}\n\n\n// Declare the needed 'fx-runner' module flow types.\n\nexport type FirefoxRunnerParams = {|\n  binary: ?string,\n  profile?: string,\n  'new-instance'?: boolean,\n  'no-remote'?: boolean,\n  'foreground'?: boolean,\n  'listen': number,\n  'binary-args'?: Array<string> | string,\n  'env'?: {\n    [key: string]: string\n  },\n  'verbose'?: boolean,\n|};\n\nexport interface FirefoxProcess extends events$EventEmitter {\n  stderr: events$EventEmitter;\n  stdout: events$EventEmitter;\n  kill: Function;\n}\n\nexport type FirefoxRunnerResults = {|\n  process: FirefoxProcess,\n  binary: string,\n  args: Array<string>,\n|}\n\nexport type FirefoxRunnerFn =\n  (params: FirefoxRunnerParams) => Promise<FirefoxRunnerResults>;\n\n\nexport type FirefoxInfo = {|\n  firefox: FirefoxProcess,\n  debuggerPort: number,\n|}\n\n// Run command types and implementaion.\n\nexport type FirefoxRunOptions = {|\n  fxRunner?: FirefoxRunnerFn,\n  findRemotePort?: RemotePortFinderFn,\n  firefoxBinary?: string,\n  binaryArgs?: Array<string>,\n  args?: Array<any>,\n|};\n\n/*\n * Runs Firefox with the given profile object and resolves a promise on exit.\n */\nexport async function run(\n  profile: FirefoxProfile,\n  {\n    fxRunner = defaultFxRunner,\n    findRemotePort = defaultRemotePortFinder,\n    firefoxBinary, binaryArgs,\n  }: FirefoxRunOptions = {}\n): Promise<FirefoxInfo> {\n\n  log.debug(`Running Firefox with profile at ${profile.path()}`);\n\n  const remotePort = await findRemotePort();\n\n  const results = await fxRunner({\n    // if this is falsey, fxRunner tries to find the default one.\n    'binary': firefoxBinary,\n    'binary-args': binaryArgs,\n    // This ensures a new instance of Firefox is created. It has nothing\n    // to do with the devtools remote debugger.\n    'no-remote': true,\n    'listen': remotePort,\n    'foreground': true,\n    'profile': profile.path(),\n    'env': {\n      ...process.env,\n      ...defaultFirefoxEnv,\n    },\n    'verbose': true,\n  });\n\n  const firefox = results.process;\n\n  log.debug(`Executing Firefox binary: ${results.binary}`);\n  log.debug(`Firefox args: ${results.args.join(' ')}`);\n\n  firefox.on('error', (error) => {\n    // TODO: show a nice error when it can't find Firefox.\n    // if (/No such file/.test(err) || err.code === 'ENOENT') {\n    log.error(`Firefox error: ${error}`);\n    throw error;\n  });\n\n  log.info(\n    'Use --verbose or open Tools > Web Developer > Browser Console ' +\n    'to see logging');\n\n  firefox.stderr.on('data', (data) => {\n    log.debug(`Firefox stderr: ${data.toString().trim()}`);\n  });\n\n  firefox.stdout.on('data', (data) => {\n    log.debug(`Firefox stdout: ${data.toString().trim()}`);\n  });\n\n  firefox.on('close', () => {\n    log.debug('Firefox closed');\n  });\n\n  return { firefox, debuggerPort: remotePort };\n}\n\n\n// isDefaultProfile types and implementation.\n\nconst DEFAULT_PROFILES_NAMES = [\n  'default',\n  'dev-edition-default',\n];\n\nexport type IsDefaultProfileFn = (\n  profilePathOrName: string,\n  ProfileFinder?: typeof FirefoxProfile.Finder,\n  fsStat?: typeof fs.stat,\n) => Promise<boolean>;\n\n/*\n * Tests if a profile is a default Firefox profile (both as a profile name or\n * profile path).\n *\n * Returns a promise that resolves to true if the profile is one of default Firefox profile.\n */\nexport async function isDefaultProfile(\n  profilePathOrName: string,\n  ProfileFinder?: typeof FirefoxProfile.Finder = FirefoxProfile.Finder,\n  fsStat?: typeof fs.stat = fs.stat,\n): Promise<boolean> {\n  if (DEFAULT_PROFILES_NAMES.includes(profilePathOrName)) {\n    return true;\n  }\n\n  const baseProfileDir = ProfileFinder.locateUserDirectory();\n  const profilesIniPath = path.join(baseProfileDir, 'profiles.ini');\n  try {\n    await fsStat(profilesIniPath);\n  } catch (error) {\n    if (isErrorWithCode('ENOENT', error)) {\n      log.debug(`profiles.ini not found: ${error}`);\n\n      // No profiles exist yet, default to false (the default profile name contains a\n      // random generated component).\n      return false;\n    }\n\n    // Re-throw any unexpected exception.\n    throw error;\n  }\n\n  // Check for profile dir path.\n  const finder = new ProfileFinder(baseProfileDir);\n  const readProfiles = promisify(finder.readProfiles, finder);\n\n  await readProfiles();\n\n  const normalizedProfileDirPath = path.normalize(\n    path.join(path.resolve(profilePathOrName), path.sep)\n  );\n\n  for (const profile of finder.profiles) {\n    // Check if the profile dir path or name is one of the default profiles\n    // defined in the profiles.ini file.\n    if (DEFAULT_PROFILES_NAMES.includes(profile.Name) ||\n        profile.Default === '1') {\n      let profileFullPath;\n\n      // Check for profile name.\n      if (profile.Name === profilePathOrName) {\n        return true;\n      }\n\n      // Check for profile path.\n      if (profile.IsRelative === '1') {\n        profileFullPath = path.join(baseProfileDir, profile.Path, path.sep);\n      } else {\n        profileFullPath = path.join(profile.Path, path.sep);\n      }\n\n      if (path.normalize(profileFullPath) === normalizedProfileDirPath) {\n        return true;\n      }\n    }\n  }\n\n  // Profile directory not found.\n  return false;\n}\n\n// configureProfile types and implementation.\n\nexport type ConfigureProfileOptions = {|\n  app?: PreferencesAppName,\n  getPrefs?: PreferencesGetterFn,\n  customPrefs?: FirefoxPreferences,\n|};\n\nexport type ConfigureProfileFn = (\n  profile: FirefoxProfile,\n  options?: ConfigureProfileOptions\n) => Promise<FirefoxProfile>;\n\n/*\n * Configures a profile with common preferences that are required to\n * activate extension development.\n *\n * Returns a promise that resolves with the original profile object.\n */\nexport function configureProfile(\n  profile: FirefoxProfile,\n  {\n    app = 'firefox',\n    getPrefs = defaultPrefGetter,\n    customPrefs = {},\n  }: ConfigureProfileOptions = {},\n): Promise<FirefoxProfile> {\n  // Set default preferences. Some of these are required for the add-on to\n  // operate, such as disabling signatures.\n  const prefs = getPrefs(app);\n  Object.keys(prefs).forEach((pref) => {\n    profile.setPreference(pref, prefs[pref]);\n  });\n  if (Object.keys(customPrefs).length > 0) {\n    const customPrefsStr = JSON.stringify(customPrefs, null, 2);\n    log.info(`Setting custom Firefox preferences: ${customPrefsStr}`);\n    Object.keys(customPrefs).forEach((custom) => {\n      profile.setPreference(custom, customPrefs[custom]);\n    });\n  }\n  profile.updatePreferences();\n  return Promise.resolve(profile);\n}\n\nexport type getProfileFn = (profileName: string) => Promise<string | void>;\n\nexport type CreateProfileFinderParams = {|\n  userDirectoryPath?: string,\n  FxProfile?: typeof FirefoxProfile\n|}\n\nexport function defaultCreateProfileFinder(\n  {\n    userDirectoryPath,\n    FxProfile = FirefoxProfile,\n  }: CreateProfileFinderParams = {}\n): getProfileFn {\n  const finder = new FxProfile.Finder(userDirectoryPath);\n  const readProfiles = promisify(finder.readProfiles, finder);\n  const getPath = promisify(finder.getPath, finder);\n  return async (profileName: string): Promise<string | void> => {\n    try {\n      await readProfiles();\n      const hasProfileName = finder.profiles.filter(\n        (profileDef) => profileDef.Name === profileName).length !== 0;\n      if (hasProfileName) {\n        return await getPath(profileName);\n      }\n    } catch (error) {\n      if (!isErrorWithCode('ENOENT', error)) {\n        throw error;\n      }\n      log.warn('Unable to find Firefox profiles.ini');\n    }\n  };\n}\n\n// useProfile types and implementation.\n\nexport type UseProfileParams = {\n  app?: PreferencesAppName,\n  configureThisProfile?: ConfigureProfileFn,\n  isFirefoxDefaultProfile?: IsDefaultProfileFn,\n  customPrefs?: FirefoxPreferences,\n  createProfileFinder?: typeof defaultCreateProfileFinder,\n};\n\n// Use the target path as a Firefox profile without cloning it\n\nexport async function useProfile(\n  profilePath: string,\n  {\n    app,\n    configureThisProfile = configureProfile,\n    isFirefoxDefaultProfile = isDefaultProfile,\n    customPrefs = {},\n    createProfileFinder = defaultCreateProfileFinder,\n  }: UseProfileParams = {},\n): Promise<FirefoxProfile> {\n  const isForbiddenProfile = await isFirefoxDefaultProfile(profilePath);\n  if (isForbiddenProfile) {\n    throw new UsageError(\n      'Cannot use --keep-profile-changes on a default profile' +\n      ` (\"${profilePath}\")` +\n      ' because web-ext will make it insecure and unsuitable for daily use.' +\n      '\\nSee https://github.com/mozilla/web-ext/issues/1005'\n    );\n  }\n\n  let destinationDirectory;\n  const getProfilePath = createProfileFinder();\n\n  const profileIsDirPath = await isDirectory(profilePath);\n  if (profileIsDirPath) {\n    log.debug(`Using profile directory \"${profilePath}\"`);\n    destinationDirectory = profilePath;\n  } else {\n    log.debug(`Assuming ${profilePath} is a named profile`);\n    destinationDirectory = await getProfilePath(profilePath);\n    if (!destinationDirectory) {\n      throw new UsageError(\n        `The request \"${profilePath}\" profile name ` +\n        'cannot be resolved to a profile path'\n      );\n    }\n  }\n\n  const profile = new FirefoxProfile({destinationDirectory});\n  return await configureThisProfile(profile, {app, customPrefs});\n}\n\n\n// createProfile types and implementation.\n\nexport type CreateProfileParams = {\n  app?: PreferencesAppName,\n  configureThisProfile?: ConfigureProfileFn,\n  customPrefs?: FirefoxPreferences,\n};\n\n/*\n * Creates a new temporary profile and resolves with the profile object.\n *\n * The profile will be deleted when the system process exits.\n */\nexport async function createProfile(\n  {\n    app,\n    configureThisProfile = configureProfile,\n    customPrefs = {},\n  }: CreateProfileParams = {},\n): Promise<FirefoxProfile> {\n  const profile = new FirefoxProfile();\n  return await configureThisProfile(profile, {app, customPrefs});\n}\n\n\n// copyProfile types and implementation.\n\nexport type CopyProfileOptions = {|\n  app?: PreferencesAppName,\n  configureThisProfile?: ConfigureProfileFn,\n  copyFromUserProfile?: Function,\n  customPrefs?: FirefoxPreferences,\n|};\n\n/*\n * Copies an existing Firefox profile and creates a new temporary profile.\n * The new profile will be configured with some preferences required to\n * activate extension development.\n *\n * It resolves with the new profile object.\n *\n * The temporary profile will be deleted when the system process exits.\n *\n * The existing profile can be specified as a directory path or a name of\n * one that exists in the current user's Firefox directory.\n */\nexport async function copyProfile(\n  profileDirectory: string,\n  {\n    app,\n    configureThisProfile = configureProfile,\n    copyFromUserProfile = defaultUserProfileCopier,\n    customPrefs = {},\n  }: CopyProfileOptions = {},\n): Promise<FirefoxProfile> {\n\n  const copy = promisify(FirefoxProfile.copy);\n  const copyByName = promisify(copyFromUserProfile);\n\n  try {\n    const dirExists = await isDirectory(profileDirectory);\n\n    let profile;\n\n    if (dirExists) {\n      log.debug(`Copying profile directory from \"${profileDirectory}\"`);\n      profile = await copy({profileDirectory});\n    } else {\n      log.debug(`Assuming ${profileDirectory} is a named profile`);\n      profile = await copyByName({name: profileDirectory});\n    }\n\n    return configureThisProfile(profile, {app, customPrefs});\n  } catch (error) {\n    throw new WebExtError(\n      `Could not copy Firefox profile from ${profileDirectory}: ${error}`);\n  }\n}\n\n\n// installExtension types and implementation.\n\nexport type InstallExtensionParams = {|\n  asProxy?: boolean,\n  manifestData: ExtensionManifest,\n  profile: FirefoxProfile,\n  extensionPath: string,\n  asyncFsStat?: typeof defaultAsyncFsStat,\n|};\n\n/*\n * Installs an extension into the given Firefox profile object.\n * Resolves when complete.\n *\n * The extension is copied into a special location and you need to turn\n * on some preferences to allow this. See extensions.autoDisableScopes in\n * ./preferences.js.\n *\n * When asProxy is true, a special proxy file will be installed. This is a\n * text file that contains the path to the extension source.\n */\nexport async function installExtension(\n  {\n    asProxy = false,\n    manifestData,\n    profile,\n    extensionPath,\n    asyncFsStat = defaultAsyncFsStat,\n  }: InstallExtensionParams): Promise<any> {\n  // This more or less follows\n  // https://github.com/saadtazi/firefox-profile-js/blob/master/lib/firefox_profile.js#L531\n  // (which is broken for web extensions).\n  // TODO: maybe uplift a patch that supports web extensions instead?\n\n  if (!profile.extensionsDir) {\n    throw new WebExtError('profile.extensionsDir was unexpectedly empty');\n  }\n\n  try {\n    await asyncFsStat(profile.extensionsDir);\n  } catch (error) {\n    if (isErrorWithCode('ENOENT', error)) {\n      log.debug(`Creating extensions directory: ${profile.extensionsDir}`);\n      await fs.mkdir(profile.extensionsDir);\n    } else {\n      throw error;\n    }\n  }\n\n  const id = getManifestId(manifestData);\n  if (!id) {\n    throw new UsageError(\n      'An explicit extension ID is required when installing to ' +\n      'a profile (applications.gecko.id not found in manifest.json)');\n  }\n\n  if (asProxy) {\n    log.debug(`Installing as an extension proxy; source: ${extensionPath}`);\n\n    const isDir = await isDirectory(extensionPath);\n    if (!isDir) {\n      throw new WebExtError(\n        'proxy install: extensionPath must be the extension source ' +\n        `directory; got: ${extensionPath}`);\n    }\n\n    // Write a special extension proxy file containing the source\n    // directory. See:\n    // https://developer.mozilla.org/en-US/Add-ons/Setting_up_extension_development_environment#Firefox_extension_proxy_file\n    const destPath = path.join(profile.extensionsDir, `${id}`);\n    const writeStream = nodeFs.createWriteStream(destPath);\n    writeStream.write(extensionPath);\n    writeStream.end();\n    return await eventToPromise(writeStream, 'close');\n  } else {\n    // Write the XPI file to the profile.\n    const readStream = nodeFs.createReadStream(extensionPath);\n    const destPath = path.join(profile.extensionsDir, `${id}.xpi`);\n    const writeStream = nodeFs.createWriteStream(destPath);\n\n    log.debug(`Installing extension from ${extensionPath} to ${destPath}`);\n    readStream.pipe(writeStream);\n\n    return await Promise.all([\n      eventToPromise(readStream, 'close'),\n      eventToPromise(writeStream, 'close'),\n    ]);\n  }\n}\n","/* @flow */\nimport {WebExtError, UsageError} from '../errors';\nimport {createLogger} from '../util/logger';\n\nconst log = createLogger(__filename);\nexport const nonOverridablePreferences = [\n  'devtools.debugger.remote-enabled', 'devtools.debugger.prompt-connection',\n  'xpinstall.signatures.required',\n];\n\n// Flow Types\n\nexport type FirefoxPreferences = {\n  [key: string]: boolean | string | number,\n};\n\nexport type PreferencesAppName = 'firefox' | 'fennec';\n\n\n// Preferences Maps\n\nconst prefsCommon: FirefoxPreferences = {\n  // Allow debug output via dump to be printed to the system console\n  'browser.dom.window.dump.enabled': true,\n\n  // Allow remote connections to the debugger.\n  'devtools.debugger.remote-enabled': true,\n  // Disable the prompt for allowing connections.\n  'devtools.debugger.prompt-connection': false,\n\n  // Turn off platform logging because it is a lot of info.\n  'extensions.logging.enabled': false,\n\n  // Disable extension updates and notifications.\n  'extensions.checkCompatibility.nightly': false,\n  'extensions.update.enabled': false,\n  'extensions.update.notifyUser': false,\n\n  // From:\n  // http://hg.mozilla.org/mozilla-central/file/1dd81c324ac7/build/automation.py.in//l372\n  // Only load extensions from the application and user profile.\n  // AddonManager.SCOPE_PROFILE + AddonManager.SCOPE_APPLICATION\n  'extensions.enabledScopes': 5,\n  // Disable metadata caching for installed add-ons by default.\n  'extensions.getAddons.cache.enabled': false,\n  // Disable intalling any distribution add-ons.\n  'extensions.installDistroAddons': false,\n  // Allow installing extensions dropped into the profile folder.\n  'extensions.autoDisableScopes': 10,\n\n  // Disable app update.\n  'app.update.enabled': false,\n\n  // Allow unsigned add-ons.\n  'xpinstall.signatures.required': false,\n};\n\n// Prefs specific to Firefox for Android.\nconst prefsFennec: FirefoxPreferences = {\n  'browser.console.showInPanel': true,\n  'browser.firstrun.show.uidiscovery': false,\n  'devtools.remote.usb.enabled': true,\n};\n\n// Prefs specific to Firefox for desktop.\nconst prefsFirefox: FirefoxPreferences = {\n  'browser.startup.homepage': 'about:blank',\n  'startup.homepage_welcome_url': 'about:blank',\n  'startup.homepage_welcome_url.additional': '',\n  'devtools.errorconsole.enabled': true,\n  'devtools.chrome.enabled': true,\n\n  // From:\n  // http://hg.mozilla.org/mozilla-central/file/1dd81c324ac7/build/automation.py.in//l388\n  // Make url-classifier updates so rare that they won't affect tests.\n  'urlclassifier.updateinterval': 172800,\n  // Point the url-classifier to a nonexistent local URL for fast failures.\n  'browser.safebrowsing.provider.0.gethashURL':\n    'http://localhost/safebrowsing-dummy/gethash',\n  'browser.safebrowsing.provider.0.keyURL':\n    'http://localhost/safebrowsing-dummy/newkey',\n  'browser.safebrowsing.provider.0.updateURL':\n    'http://localhost/safebrowsing-dummy/update',\n\n  // Disable self repair/SHIELD\n  'browser.selfsupport.url': 'https://localhost/selfrepair',\n  // Disable Reader Mode UI tour\n  'browser.reader.detectedFirstArticle': true,\n\n  // Set the policy firstURL to an empty string to prevent\n  // the privacy info page to be opened on every \"web-ext run\".\n  // (See #1114 for rationale)\n  'datareporting.policy.firstRunURL': '',\n};\n\nconst prefs = {\n  common: prefsCommon,\n  fennec: prefsFennec,\n  firefox: prefsFirefox,\n};\n\n\n// Module exports\n\nexport type PreferencesGetterFn =\n  (appName: PreferencesAppName) => FirefoxPreferences;\n\nexport function getPrefs(\n  app: PreferencesAppName = 'firefox'\n): FirefoxPreferences {\n  const appPrefs = prefs[app];\n  if (!appPrefs) {\n    throw new WebExtError(`Unsupported application: ${app}`);\n  }\n  return {\n    ...prefsCommon,\n    ...appPrefs,\n  };\n}\n\nexport function coerceCLICustomPreference(\n  cliPrefs: Array<string>\n): FirefoxPreferences {\n  const customPrefs = {};\n\n  for (const pref of cliPrefs) {\n    const prefsAry = pref.split('=');\n\n    if (prefsAry.length < 2) {\n      throw new UsageError(\n        `Incomplete custom preference: \"${pref}\". ` +\n        'Syntax expected: \"prefname=prefvalue\".'\n      );\n    }\n\n    const key = prefsAry[0];\n    let value = prefsAry.slice(1).join('=');\n\n    if (/[^\\w{@}.-]/.test(key)) {\n      throw new UsageError(`Invalid custom preference name: ${key}`);\n    }\n\n    if (value === `${parseInt(value)}`) {\n      value = parseInt(value, 10);\n    } else if (value === 'true' || value === 'false') {\n      value = (value === 'true');\n    }\n\n    if (nonOverridablePreferences.includes(key)) {\n      log.warn(`'${key}' preference cannot be customized.`);\n      continue;\n    }\n    customPrefs[`${key}`] = value;\n  }\n\n  return customPrefs;\n}\n","/* @flow */\nimport defaultFirefoxConnector from '@cliqz-oss/node-firefox-connect';\n// RemoteFirefox types and implementation\nimport type FirefoxClient from '@cliqz-oss/firefox-client';\n\nimport {createLogger} from '../util/logger';\nimport {\n  isErrorWithCode,\n  RemoteTempInstallNotSupported,\n  UsageError,\n  WebExtError,\n} from '../errors';\n\nconst log = createLogger(__filename);\n\n// The default port that Firefox's remote debugger will listen on and the\n// client will connect to.\nexport const REMOTE_PORT = 6005;\n\nexport type FirefoxConnectorFn =\n  (port?: number) => Promise<FirefoxClient>;\n\nexport type FirefoxRDPAddonActor = {|\n  id: string,\n  actor: string,\n|};\n\nexport type FirefoxRDPResponseError = {|\n  error: {\n    message: string,\n  },\n|};\n\nexport type FirefoxRDPResponseAddon = {|\n  addon: FirefoxRDPAddonActor,\n|};\n\nexport type FirefoxRDPResponseRequestTypes = {|\n  requestTypes: Array<string>,\n|};\n\n// NOTE: this type aliases Object to catch any other possible response.\nexport type FirefoxRDPResponseAny = Object;\n\nexport type FirefoxRDPResponseMaybe =\n  FirefoxRDPResponseRequestTypes | FirefoxRDPResponseAny;\n\nexport class RemoteFirefox {\n  client: Object;\n  checkedForAddonReloading: boolean;\n\n  constructor(client: FirefoxClient) {\n    this.client = client;\n    this.checkedForAddonReloading = false;\n\n    client.client.on('disconnect', () => {\n      log.debug('Received \"disconnect\" from Firefox client');\n    });\n    client.client.on('end', () => {\n      log.debug('Received \"end\" from Firefox client');\n    });\n    client.client.on('message', (info) => {\n      // These are arbitrary messages that the client library ignores.\n      log.debug(`Received message from client: ${JSON.stringify(info)}`);\n    });\n  }\n\n  disconnect() {\n    this.client.disconnect();\n  }\n\n  addonRequest(\n    addon: FirefoxRDPAddonActor,\n    request: string\n  ): Promise<FirefoxRDPResponseMaybe> {\n    return new Promise((resolve, reject) => {\n      this.client.client.makeRequest(\n        {to: addon.actor, type: request}, (response) => {\n          if (response.error) {\n            const error = `${response.error}: ${response.message}`;\n            log.debug(\n              `Client responded to '${request}' request with error:`, error);\n            reject(new WebExtError(error));\n          } else {\n            resolve(response);\n          }\n        });\n    });\n  }\n\n  installTemporaryAddon(\n    addonPath: string\n  ): Promise<FirefoxRDPResponseAddon> {\n    return new Promise((resolve, reject) => {\n      this.client.request('listTabs', (error, tabsResponse) => {\n        if (error) {\n          return reject(new WebExtError(\n            `Remote Firefox: listTabs() error: ${error}`));\n        }\n        if (!tabsResponse.addonsActor) {\n          log.debug(\n            'listTabs returned a falsey addonsActor: ' +\n            `${tabsResponse.addonsActor}`);\n          return reject(new RemoteTempInstallNotSupported(\n            'This is an older version of Firefox that does not provide an ' +\n            'add-ons actor for remote installation. Try Firefox 49 or ' +\n            'higher.'));\n        }\n\n        this.client.client.makeRequest({\n          to: tabsResponse.addonsActor,\n          type: 'installTemporaryAddon',\n          addonPath,\n        }, (installResponse) => {\n          if (installResponse.error) {\n            return reject(new WebExtError(\n              'installTemporaryAddon: Error: ' +\n              `${installResponse.error}: ${installResponse.message}`));\n          }\n          log.debug(\n            `installTemporaryAddon: ${JSON.stringify(installResponse)}`);\n          log.info(`Installed ${addonPath} as a temporary add-on`);\n          resolve(installResponse);\n        });\n      });\n    });\n  }\n\n  getInstalledAddon(addonId: string): Promise<FirefoxRDPAddonActor> {\n    return new Promise(\n      (resolve, reject) => {\n        this.client.request('listAddons', (error, response) => {\n          if (error) {\n            reject(new WebExtError(\n              `Remote Firefox: listAddons() error: ${error}`));\n          } else {\n            resolve(response.addons);\n          }\n        });\n      })\n      .then((addons) => {\n        for (const addon of addons) {\n          if (addon.id === addonId) {\n            return addon;\n          }\n        }\n        log.debug(\n          `Remote Firefox has these addons: ${addons.map((a) => a.id)}`);\n        throw new WebExtError(\n          'The remote Firefox does not have your extension installed');\n      });\n  }\n\n  async checkForAddonReloading(\n    addon: FirefoxRDPAddonActor\n  ): Promise<FirefoxRDPAddonActor> {\n    if (this.checkedForAddonReloading) {\n      // We only need to check once if reload() is supported.\n      return addon;\n    } else {\n      const response = await this.addonRequest(addon, 'requestTypes');\n\n      if (response.requestTypes.indexOf('reload') === -1) {\n        const supportedRequestTypes = JSON.stringify(response.requestTypes);\n        log.debug(\n          `Remote Firefox only supports: ${supportedRequestTypes}`);\n        throw new UsageError(\n          'This Firefox version does not support add-on reloading. ' +\n          'Re-run with --no-reload');\n      } else {\n        this.checkedForAddonReloading = true;\n        return addon;\n      }\n    }\n  }\n\n  async reloadAddon(addonId: string): Promise<void> {\n    const addon = await this.getInstalledAddon(addonId);\n    await this.checkForAddonReloading(addon);\n    await this.addonRequest(addon, 'reload');\n    process.stdout.write(\n      `\\rLast extension reload: ${(new Date()).toTimeString()}`);\n    log.debug('\\n');\n  }\n}\n\n\n// Connect types and implementation\n\nexport type ConnectOptions = {|\n  connectToFirefox: FirefoxConnectorFn,\n|};\n\nexport async function connect(\n  port: number = REMOTE_PORT,\n  {connectToFirefox = defaultFirefoxConnector}: ConnectOptions = {}\n): Promise<RemoteFirefox> {\n  log.debug(`Connecting to Firefox on port ${port}`);\n  const client = await connectToFirefox(port);\n  log.debug(`Connected to the remote Firefox debugger on port ${port}`);\n  return new RemoteFirefox(client);\n}\n\n\n// ConnectWithMaxRetries types and implementation\n\nexport type ConnectWithMaxRetriesParams = {|\n  maxRetries?: number,\n  retryInterval?: number,\n  port: number,\n|};\n\nexport type ConnectWithMaxRetriesDeps = {|\n  connectToFirefox: typeof connect,\n|};\n\nexport async function connectWithMaxRetries(\n  // A max of 250 will try connecting for 30 seconds.\n  {maxRetries = 250, retryInterval = 120, port}: ConnectWithMaxRetriesParams,\n  {connectToFirefox = connect}: ConnectWithMaxRetriesDeps = {}\n): Promise<RemoteFirefox> {\n  async function establishConnection() {\n    var lastError;\n\n    for (let retries = 0; retries <= maxRetries; retries++) {\n      try {\n        return await connectToFirefox(port);\n      } catch (error) {\n        if (isErrorWithCode('ECONNREFUSED', error)) {\n          // Wait for `retryInterval` ms.\n          await new Promise((resolve) => {\n            setTimeout(resolve, retryInterval);\n          });\n\n          lastError = error;\n          log.debug(\n            `Retrying Firefox (${retries}); connection error: ${error}`);\n        } else {\n          log.error(error.stack);\n          throw error;\n        }\n      }\n    }\n\n    log.debug('Connect to Firefox debugger: too many retries');\n    throw lastError;\n  }\n\n  log.debug('Connecting to the remote Firefox debugger');\n  return establishConnection();\n}\n","/* @flow */\nimport {main} from './program';\nimport cmd from './cmd';\nimport * as logger from './util/logger';\n\n// This only exposes util/logger so far.\n// Do we need anything else?\nconst util = {logger};\n\nexport default {main, cmd, util};\n","/* @flow */\nimport os from 'os';\nimport path from 'path';\nimport {readFileSync} from 'fs';\n\nimport camelCase from 'camelcase';\nimport git from 'git-rev-sync';\nimport yargs from 'yargs';\n\nimport defaultCommands from './cmd';\nimport {UsageError} from './errors';\nimport {createLogger, consoleStream as defaultLogStream} from './util/logger';\nimport {coerceCLICustomPreference} from './firefox/preferences';\nimport {checkForUpdates as defaultUpdateChecker} from './util/updates';\nimport {\n  discoverConfigFiles as defaultConfigDiscovery,\n  loadJSConfigFile as defaultLoadJSConfigFile,\n  applyConfigToArgv as defaultApplyConfigToArgv,\n} from './config';\n\nconst log = createLogger(__filename);\nconst envPrefix = 'WEB_EXT';\n\n\ntype ProgramOptions = {|\n  absolutePackageDir?: string,\n|}\n\nexport type VersionGetterFn = (absolutePackageDir: string) => string;\n\n// TODO: add pipes to Flow type after https://github.com/facebook/flow/issues/2405 is fixed\n\ntype ExecuteOptions = {\n  checkForUpdates?: Function,\n  systemProcess?: typeof process,\n  logStream?: typeof defaultLogStream,\n  getVersion?: VersionGetterFn,\n  applyConfigToArgv?: typeof defaultApplyConfigToArgv,\n  discoverConfigFiles?: typeof defaultConfigDiscovery,\n  loadJSConfigFile?: typeof defaultLoadJSConfigFile,\n  shouldExitProgram?: boolean,\n  globalEnv?: string,\n}\n\n\n/*\n * The command line program.\n */\nexport class Program {\n  absolutePackageDir: string;\n  yargs: any;\n  commands: { [key: string]: Function };\n  shouldExitProgram: boolean;\n  verboseEnabled: boolean;\n  options: Object;\n\n  constructor(\n    argv: ?Array<string>,\n    {\n      absolutePackageDir = process.cwd(),\n    }: ProgramOptions = {}\n  ) {\n    // This allows us to override the process argv which is useful for\n    // testing.\n    // NOTE: process.argv.slice(2) removes the path to node and web-ext\n    // executables from the process.argv array.\n    argv = argv || process.argv.slice(2);\n\n    // NOTE: always initialize yargs explicitly with the package dir\n    // to avoid side-effects due to yargs looking for its configuration\n    // section from a package.json file stored in an arbitrary directory\n    // (e.g. in tests yargs would end up loading yargs config from the\n    // mocha package.json). web-ext package.json doesn't contain any yargs\n    // section as it is deprecated and we configure yargs using\n    // yargs.parserConfiguration. See web-ext#469 for rationale.\n    const yargsInstance = yargs(argv, absolutePackageDir);\n\n    this.absolutePackageDir = absolutePackageDir;\n    this.verboseEnabled = false;\n    this.shouldExitProgram = true;\n    this.yargs = yargsInstance;\n\n    // The following yargs configuration option is needed to fix #304.\n    this.yargs.parserConfiguration({\n      'boolean-negation': false,\n    });\n\n    this.yargs.strict();\n\n    this.commands = {};\n    this.options = {};\n  }\n\n  command(\n    name: string, description: string, executor: Function,\n    commandOptions: Object = {}\n  ): Program {\n    this.options[camelCase(name)] = commandOptions;\n\n    this.yargs.command(name, description, (yargsForCmd) => {\n      if (!commandOptions) {\n        return;\n      }\n      return yargsForCmd\n        // Make sure the user does not add any extra commands. For example,\n        // this would be a mistake because lint does not accept arguments:\n        // web-ext lint ./src/path/to/file.js\n        .demandCommand(0, 0, undefined,\n                       'This command does not take any arguments')\n        .strict()\n        .exitProcess(this.shouldExitProgram)\n        // Calling env() will be unnecessary after\n        // https://github.com/yargs/yargs/issues/486 is fixed\n        .env(envPrefix)\n        .options(commandOptions);\n    });\n    this.commands[name] = executor;\n    return this;\n  }\n\n  setGlobalOptions(options: Object): Program {\n    // This is a convenience for setting global options.\n    // An option is only global (i.e. available to all sub commands)\n    // with the `global` flag so this makes sure every option has it.\n    this.options = {...this.options, ...options};\n    Object.keys(options).forEach((key) => {\n      options[key].global = true;\n      if (options[key].demandOption === undefined) {\n        // By default, all options should be \"demanded\" otherwise\n        // yargs.strict() will think they are missing when declared.\n        options[key].demandOption = true;\n      }\n    });\n    this.yargs.options(options);\n    return this;\n  }\n\n  enableVerboseMode(\n    logStream: typeof defaultLogStream,\n    version: string\n  ): void {\n    if (this.verboseEnabled) {\n      return;\n    }\n\n    logStream.makeVerbose();\n    log.info('Version:', version);\n    this.verboseEnabled = true;\n  }\n\n  async execute(\n    {\n      checkForUpdates = defaultUpdateChecker,\n      systemProcess = process,\n      logStream = defaultLogStream,\n      getVersion = defaultVersionGetter,\n      applyConfigToArgv = defaultApplyConfigToArgv,\n      discoverConfigFiles = defaultConfigDiscovery,\n      loadJSConfigFile = defaultLoadJSConfigFile,\n      shouldExitProgram = true,\n      globalEnv = WEBEXT_BUILD_ENV,\n    }: ExecuteOptions = {}\n  ): Promise<void> {\n    this.shouldExitProgram = shouldExitProgram;\n    this.yargs.exitProcess(this.shouldExitProgram);\n\n    const argv = this.yargs.argv;\n\n    const cmd = argv._[0];\n\n    const version = getVersion(this.absolutePackageDir);\n    const runCommand = this.commands[cmd];\n\n    if (argv.verbose) {\n      this.enableVerboseMode(logStream, version);\n    }\n\n    let adjustedArgv = {...argv};\n\n    try {\n      if (cmd === undefined) {\n        throw new UsageError('No sub-command was specified in the args');\n      }\n      if (!runCommand) {\n        throw new UsageError(`Unknown command: ${cmd}`);\n      }\n      if (globalEnv === 'production') {\n        checkForUpdates({version});\n      }\n\n      const configFiles = [];\n\n      // Because of an issue with yargs special handling for '--no-' option prefix (See #306)\n      // we need to look explicitly for the options  --config-discovery and --no-config-discovery\n      // (See #1307).\n      if (argv.configDiscovery && !argv.noConfigDiscovery) {\n        log.debug(\n          'Discovering config files. ' +\n          'Set --no-config-discovery to disable');\n        const discoveredConfigs = await discoverConfigFiles();\n        configFiles.push(...discoveredConfigs);\n      } else {\n        log.debug('Not discovering config files');\n      }\n\n      if (argv.config) {\n        configFiles.push(path.resolve(argv.config));\n      }\n\n      if (configFiles.length) {\n        const niceFileList = configFiles\n          .map((f) => f.replace(process.cwd(), '.'))\n          .map((f) => f.replace(os.homedir(), '~'))\n          .join(', ');\n        log.info(\n          'Applying config file' +\n          `${configFiles.length !== 1 ? 's' : ''}: ` +\n          `${niceFileList}`);\n      }\n\n      configFiles.forEach((configFileName) => {\n        const configObject = loadJSConfigFile(configFileName);\n        adjustedArgv = applyConfigToArgv({\n          argv: adjustedArgv,\n          argvFromCLI: argv,\n          configFileName,\n          configObject,\n          options: this.options,\n        });\n      });\n\n      if (adjustedArgv.verbose) {\n        // Ensure that the verbose is enabled when specified in a config file.\n        this.enableVerboseMode(logStream, version);\n      }\n\n      await runCommand(adjustedArgv, {shouldExitProgram});\n\n    } catch (error) {\n      if (!(error instanceof UsageError) || adjustedArgv.verbose) {\n        log.error(`\\n${error.stack}\\n`);\n      } else {\n        log.error(`\\n${error}\\n`);\n      }\n      if (error.code) {\n        log.error(`Error code: ${error.code}\\n`);\n      }\n\n      log.debug(`Command executed: ${cmd}`);\n\n      if (this.shouldExitProgram) {\n        systemProcess.exit(1);\n      } else {\n        throw error;\n      }\n    }\n  }\n}\n\n// A global variable generated by DefinePlugin, generated in webpack.config.js\ndeclare var WEBEXT_BUILD_ENV: string;\n\n//A defintion of type of argument for defaultVersionGetter\ntype VersionGetterOptions = {\n  globalEnv?: string,\n};\n\nexport function defaultVersionGetter(\n  absolutePackageDir: string,\n  {globalEnv = WEBEXT_BUILD_ENV}: VersionGetterOptions = {}\n): string {\n  if (globalEnv === 'production') {\n    log.debug('Getting the version from package.json');\n    const packageData: any = readFileSync(\n      path.join(absolutePackageDir, 'package.json'));\n    return JSON.parse(packageData).version;\n  } else {\n    log.debug('Getting version from the git revision');\n    return `${git.branch(absolutePackageDir)}-${git.long(absolutePackageDir)}`;\n  }\n}\n\n// TODO: add pipes to Flow type after https://github.com/facebook/flow/issues/2405 is fixed\n\ntype MainParams = {\n  getVersion?: VersionGetterFn,\n  commands?: Object,\n  argv: Array<any>,\n  runOptions?: Object,\n}\n\nexport function main(\n  absolutePackageDir: string,\n  {\n    getVersion = defaultVersionGetter, commands = defaultCommands, argv,\n    runOptions = {},\n  }: MainParams = {}\n): Promise<any> {\n  const program = new Program(argv, {absolutePackageDir});\n  const version = getVersion(absolutePackageDir);\n\n  // yargs uses magic camel case expansion to expose options on the\n  // final argv object. For example, the 'artifacts-dir' option is alternatively\n  // available as argv.artifactsDir.\n  program.yargs\n    .usage(`Usage: $0 [options] command\n\nOption values can also be set by declaring an environment variable prefixed\nwith $${envPrefix}_. For example: $${envPrefix}_SOURCE_DIR=/path is the same as\n--source-dir=/path.\n\nTo view specific help for any given command, add the command name.\nExample: $0 --help run.\n`)\n    .help('help')\n    .alias('h', 'help')\n    .env(envPrefix)\n    .version(version)\n    .demandCommand(1, 'You must specify a command')\n    .strict();\n\n  program.setGlobalOptions({\n    'source-dir': {\n      alias: 's',\n      describe: 'Web extension source directory.',\n      default: process.cwd(),\n      requiresArg: true,\n      type: 'string',\n      coerce: path.resolve,\n    },\n    'artifacts-dir': {\n      alias: 'a',\n      describe: 'Directory where artifacts will be saved.',\n      default: path.join(process.cwd(), 'web-ext-artifacts'),\n      normalize: true,\n      requiresArg: true,\n      type: 'string',\n    },\n    'verbose': {\n      alias: 'v',\n      describe: 'Show verbose output',\n      type: 'boolean',\n      demandOption: false,\n    },\n    'ignore-files': {\n      alias: 'i',\n      describe: 'A list of glob patterns to define which files should be ' +\n                'ignored. (Example: --ignore-files=path/to/first.js ' +\n                'path/to/second.js \"**/*.log\")',\n      demandOption: false,\n      requiresArg: true,\n      type: 'array',\n    },\n    'no-input': {\n      describe: 'Disable all features that require standard input',\n      type: 'boolean',\n      demandOption: false,\n    },\n    'config': {\n      alias: 'c',\n      describe: 'Path to a CommonJS config file to set ' +\n        'option defaults',\n      default: undefined,\n      demandOption: false,\n      requiresArg: true,\n      type: 'string',\n    },\n    'config-discovery': {\n      describe: 'Discover config files in home directory and ' +\n        'working directory. Disable with --no-config-discovery.',\n      demandOption: false,\n      default: true,\n      type: 'boolean',\n    },\n  });\n\n  program\n    .command(\n      'build',\n      'Create an extension package from source',\n      commands.build, {\n        'as-needed': {\n          describe: 'Watch for file changes and re-build as needed',\n          type: 'boolean',\n        },\n        'overwrite-dest': {\n          alias: 'o',\n          describe: 'Overwrite destination package if it exists.',\n          type: 'boolean',\n        },\n      })\n    .command(\n      'sign',\n      'Sign the extension so it can be installed in Firefox',\n      commands.sign, {\n        'api-key': {\n          describe: 'API key (JWT issuer) from addons.mozilla.org',\n          demandOption: true,\n          type: 'string',\n        },\n        'api-secret': {\n          describe: 'API secret (JWT secret) from addons.mozilla.org',\n          demandOption: true,\n          type: 'string',\n        },\n        'api-url-prefix': {\n          describe: 'Signing API URL prefix',\n          default: 'https://addons.mozilla.org/api/v3',\n          demandOption: true,\n          type: 'string',\n        },\n        'api-proxy': {\n          describe:\n            'Use a proxy to access the signing API. ' +\n            'Example: https://yourproxy:6000 ',\n          demandOption: false,\n          type: 'string',\n        },\n        'id': {\n          describe:\n            'A custom ID for the extension. This has no effect if the ' +\n            'extension already declares an explicit ID in its manifest.',\n          demandOption: false,\n          type: 'string',\n        },\n        'timeout': {\n          describe: 'Number of milliseconds to wait before giving up',\n          type: 'number',\n        },\n        'channel': {\n          describe: 'The channel for which to sign the addon. Either ' +\n          '\\'listed\\' or \\'unlisted\\'',\n          type: 'string',\n        },\n      })\n    .command('run', 'Run the extension', commands.run, {\n      'target': {\n        alias: 't',\n        describe: 'The extensions runners to enable (e.g. firefox-desktop, ' +\n                  'firefox-android). Specify this option multiple times to ' +\n                  'run against multiple targets.',\n        default: 'firefox-desktop',\n        demandOption: false,\n        type: 'array',\n      },\n      'firefox': {\n        alias: ['f', 'firefox-binary'],\n        describe: 'Path or alias to a Firefox executable such as firefox-bin ' +\n                  'or firefox.exe. ' +\n                  'If not specified, the default Firefox will be used. ' +\n                  'You can specify the following aliases in lieu of a path: ' +\n                  'firefox, beta, nightly, firefoxdeveloperedition.',\n        demandOption: false,\n        type: 'string',\n      },\n      'firefox-profile': {\n        alias: 'p',\n        describe: 'Run Firefox using a copy of this profile. The profile ' +\n                  'can be specified as a directory or a name, such as one ' +\n                  'you would see in the Profile Manager. If not specified, ' +\n                  'a new temporary profile will be created.',\n        demandOption: false,\n        type: 'string',\n      },\n      'firefox-port': {\n        alias: 'P',\n        describe: 'Attach to a running Firefox on this developer tools ' +\n                  'port. To do so, open the developer toolbar and enter ' +\n                  'e.g. `listen 6060`. This flag usually does not need to ' +\n                  'be set and is only for advanced use.',\n        demand: false,\n        type: 'number'\n      },\n      'keep-profile-changes': {\n        describe: 'Run Firefox directly in custom profile. Any changes to ' +\n                  'the profile will be saved.',\n        demandOption: false,\n        type: 'boolean',\n      },\n      'no-reload': {\n        describe: 'Do not reload the extension when source files change',\n        demandOption: false,\n        type: 'boolean',\n      },\n      'pre-install': {\n        describe: 'Pre-install the extension into the profile before ' +\n                  'startup. This is only needed to support older versions ' +\n                  'of Firefox.',\n        demandOption: false,\n        type: 'boolean',\n      },\n      'pref': {\n        describe: 'Launch firefox with a custom preference ' +\n                  '(example: --pref=general.useragent.locale=fr-FR). ' +\n                  'You can repeat this option to set more than one ' +\n                  'preference.',\n        demandOption: false,\n        requiresArg: true,\n        type: 'array',\n        coerce: coerceCLICustomPreference,\n      },\n      'start-url': {\n        alias: ['u', 'url'],\n        describe: 'Launch firefox at specified page',\n        demandOption: false,\n        requiresArg: true,\n        type: 'array',\n      },\n      'browser-console': {\n        alias: ['bc'],\n        describe: 'Open the DevTools Browser Console.',\n        demandOption: false,\n        type: 'boolean',\n      },\n      // Firefox for Android CLI options.\n      'adb-bin': {\n        describe: 'Specify a custom path to the adb binary',\n        demandOption: false,\n        type: 'string',\n        requiresArg: true,\n      },\n      'adb-host': {\n        describe: 'Connect to adb on the specified host',\n        demandOption: false,\n        type: 'string',\n        requiresArg: true,\n      },\n      'adb-port': {\n        describe: 'Connect to adb on the specified port',\n        demandOption: false,\n        type: 'string',\n        requiresArg: true,\n      },\n      'adb-device': {\n        alias: ['android-device'],\n        describe: 'Connect to the specified adb device name',\n        demandOption: false,\n        type: 'string',\n        requiresArg: true,\n      },\n      'firefox-apk': {\n        describe: (\n          'Run a specific Firefox for Android APK. ' +\n          'Example: org.mozilla.fennec_aurora'\n        ),\n        demandOption: false,\n        type: 'string',\n        requiresArg: true,\n      },\n    })\n    .command('lint', 'Validate the extension source', commands.lint, {\n      'output': {\n        alias: 'o',\n        describe: 'The type of output to generate',\n        type: 'string',\n        default: 'text',\n        choices: ['json', 'text'],\n      },\n      'metadata': {\n        describe: 'Output only metadata as JSON',\n        type: 'boolean',\n        default: false,\n      },\n      'warnings-as-errors': {\n        describe: 'Treat warnings as errors by exiting non-zero for warnings',\n        alias: 'w',\n        type: 'boolean',\n        default: false,\n      },\n      'pretty': {\n        describe: 'Prettify JSON output',\n        type: 'boolean',\n        default: false,\n      },\n      'self-hosted': {\n        describe:\n          'Your extension will be self-hosted. This disables messages ' +\n          'related to hosting on addons.mozilla.org.',\n        type: 'boolean',\n        default: false,\n      },\n      'boring': {\n        describe: 'Disables colorful shell output',\n        type: 'boolean',\n        default: false,\n      },\n    })\n    .command('docs', 'Open the web-ext documentation in a browser',\n             commands.docs, {});\n\n  return program.execute({getVersion, ...runOptions});\n}\n","/* @flow */\nimport defaultADB from 'adbkit';\n\nimport {\n  isErrorWithCode,\n  UsageError,\n  WebExtError,\n} from '../errors';\nimport {createLogger} from '../util/logger';\n\nconst log = createLogger(__filename);\n\nexport type ADBUtilsParams = {|\n  adb?: typeof defaultADB,\n  // ADB configs.\n  adbBin?: string,\n  adbHost?: string,\n  adbPort?: string,\n  adbDevice?: string,\n|};\n\nexport type DiscoveryParams = {|\n  maxDiscoveryTime: number,\n  retryInterval: number,\n|};\n\n// Helper function used to raise an UsageError when the adb binary has not been found.\nasync function wrapADBCall(asyncFn: (...any) => Promise<any>): Promise<any> {\n  try {\n    return await asyncFn();\n  } catch (error) {\n    if (isErrorWithCode('ENOENT', error) &&\n        error.message.includes('spawn adb')) {\n      throw new UsageError(\n        'No adb executable has been found. ' +\n          'You can Use --adb-bin, --adb-host/--adb-port ' +\n          'to configure it manually if needed.');\n    }\n\n    throw error;\n  }\n}\n\nexport default class ADBUtils {\n  params: ADBUtilsParams;\n  adb: typeof defaultADB;\n  adbClient: any; // TODO: better flow typing here.\n\n  // Map<deviceId -> artifactsDir>\n  artifactsDirMap: Map<string, string>;\n  // Toggled when the user wants to abort the RDP Unix Socket discovery loop\n  // while it is still executing.\n  userAbortDiscovery: boolean;\n\n  constructor(params: ADBUtilsParams) {\n    this.params = params;\n\n    const {\n      adb,\n      adbBin,\n      adbHost,\n      adbPort,\n    } = params;\n\n    this.adb = adb || defaultADB;\n\n    this.adbClient = this.adb.createClient({\n      bin: adbBin,\n      host: adbHost,\n      port: adbPort,\n    });\n\n    this.artifactsDirMap = new Map();\n\n    this.userAbortDiscovery = false;\n  }\n\n  runShellCommand(\n    deviceId: string, cmd: string | Array<string>\n  ): Promise<string> {\n    const {adb, adbClient} = this;\n\n    log.debug(`Run adb shell command on ${deviceId}: ${JSON.stringify(cmd)}`);\n\n    return wrapADBCall(async () => {\n      return await adbClient.shell(deviceId, cmd).then(adb.util.readAll);\n    }).then((res) => res.toString());\n  }\n\n  async discoverDevices(): Promise<Array<string>> {\n    const {adbClient} = this;\n\n    let devices = [];\n\n    log.debug('Listing android devices');\n    devices = await wrapADBCall(async () => adbClient.listDevices());\n\n    return devices.map((dev) => dev.id);\n  }\n\n  async discoverInstalledFirefoxAPKs(\n    deviceId: string,\n    firefoxApk?: string\n  ): Promise<Array<string>> {\n    log.debug(`Listing installed Firefox APKs on ${deviceId}`);\n\n    const pmList = await this.runShellCommand(deviceId, [\n      'pm', 'list', 'packages',\n    ]);\n\n    return pmList.split('\\n')\n      .map((line) => line.replace('package:', '').trim())\n      .filter((line) => {\n        // Look for an exact match if firefoxApk is defined.\n        if (firefoxApk) {\n          return line === firefoxApk;\n        }\n        // Match any package name that starts with the package name of a Firefox for Android browser.\n        return (\n          line.startsWith('org.mozilla.fennec') ||\n            line.startsWith('org.mozilla.firefox')\n        );\n      });\n  }\n\n  async getAndroidVersionNumber(deviceId: string): Promise<number> {\n    const androidVersion = (await this.runShellCommand(deviceId, [\n      'getprop', 'ro.build.version.sdk',\n    ])).trim();\n\n    const androidVersionNumber = parseInt(androidVersion);\n\n    // No need to check the granted runtime permissions on Android versions < Lollypop.\n    if (isNaN(androidVersionNumber)) {\n      throw new WebExtError(\n        'Unable to discovery android version on ' +\n        `${deviceId}: ${androidVersion}`\n      );\n    }\n\n    return androidVersionNumber;\n  }\n\n  // Raise an UsageError when the given APK does not have the required runtime permissions.\n  async ensureRequiredAPKRuntimePermissions(\n    deviceId: string, apk: string, permissions: Array<string>\n  ): Promise<void> {\n    const permissionsMap = {};\n\n    // Initialize every permission to false in the permissions map.\n    for (const perm of permissions) {\n      permissionsMap[perm] = false;\n    }\n\n    // Retrieve the permissions information for the given apk.\n    const pmDumpLogs = (await this.runShellCommand(deviceId, [\n      'pm', 'dump', apk,\n    ])).split('\\n');\n\n    // Set to true the required permissions that have been granted.\n    for (const line of pmDumpLogs) {\n      for (const perm of permissions) {\n        if (line.includes(`${perm}: granted=true`)) {\n          permissionsMap[perm] = true;\n        }\n      }\n    }\n\n    for (const perm of permissions) {\n      if (!permissionsMap[perm]) {\n        throw new UsageError(\n          `Required ${perm} has not be granted for ${apk}. ` +\n          'Please grant them using the Android Settings ' +\n          'or using the following adb command:\\n' +\n          `\\t adb shell pm grant ${apk} ${perm}\\n`\n        );\n      }\n    }\n  }\n\n  async amForceStopAPK(deviceId: string, apk: string): Promise<void> {\n    await this.runShellCommand(deviceId, [\n      'am', 'force-stop', apk,\n    ]);\n  }\n\n  async getOrCreateArtifactsDir(deviceId: string): Promise<string> {\n    let artifactsDir = this.artifactsDirMap.get(deviceId);\n\n    if (artifactsDir) {\n      return artifactsDir;\n    }\n\n    artifactsDir = `/sdcard/web-ext-artifacts-${Date.now()}`;\n\n    const testDirOut = (await this.runShellCommand(\n      deviceId, `test -d ${artifactsDir} ; echo $?`\n    )).trim();\n\n    if (testDirOut !== '1') {\n      throw new WebExtError(\n        `Cannot create artifacts directory ${artifactsDir} ` +\n        `because it exists on ${deviceId}.`\n      );\n    }\n\n    await this.runShellCommand(deviceId, ['mkdir', '-p', artifactsDir]);\n\n    this.artifactsDirMap.set(deviceId, artifactsDir);\n\n    return artifactsDir;\n  }\n\n  async clearArtifactsDir(deviceId: string): Promise<void> {\n    const artifactsDir = this.artifactsDirMap.get(deviceId);\n\n    if (!artifactsDir) {\n      // nothing to do here.\n      return;\n    }\n\n    this.artifactsDirMap.delete(deviceId);\n\n    log.debug(\n      `Removing ${artifactsDir} artifacts directory on ${deviceId} device`\n    );\n\n    await this.runShellCommand(deviceId, [\n      'rm', '-rf', artifactsDir,\n    ]);\n  }\n\n  async pushFile(\n    deviceId: string, localPath: string, devicePath: string\n  ): Promise<void> {\n    const {adbClient} = this;\n\n    log.debug(`Pushing ${localPath} to ${devicePath} on ${deviceId}`);\n\n    await wrapADBCall(async () => {\n      await adbClient.push(deviceId, localPath, devicePath)\n        .then(function(transfer) {\n          return new Promise((resolve) => {\n            transfer.on('end', resolve);\n          });\n        });\n    });\n  }\n\n  async startFirefoxAPK(\n    deviceId: string, apk: string, deviceProfileDir: string\n  ): Promise<void> {\n    const {adbClient} = this;\n\n    log.debug(\n      `Starting ${apk} with profile ${deviceProfileDir} on ${deviceId}`\n    );\n\n    await wrapADBCall(async () => {\n      await adbClient.startActivity(deviceId, {\n        wait: true,\n        action: 'android.activity.MAIN',\n        component: `${apk}/.App`,\n        extras: [\n          {\n            key: 'args',\n            value: `-profile ${deviceProfileDir}`,\n          },\n        ],\n      });\n    });\n  }\n\n  setUserAbortDiscovery(value: boolean) {\n    this.userAbortDiscovery = value;\n  }\n\n  async discoverRDPUnixSocket(\n    deviceId: string, apk: string,\n    {maxDiscoveryTime, retryInterval}: DiscoveryParams = {}\n  ): Promise<string> {\n    let rdpUnixSockets = [];\n\n    const discoveryStartedAt = Date.now();\n\n    while (rdpUnixSockets.length === 0) {\n      if (this.userAbortDiscovery) {\n        throw new UsageError(\n          'Exiting Firefox Remote Debugging socket discovery on user request'\n        );\n      }\n\n      if (Date.now() - discoveryStartedAt > maxDiscoveryTime) {\n        throw new WebExtError(\n          'Timeout while waiting for the Android Firefox Debugger Socket'\n        );\n      }\n\n      rdpUnixSockets = (await this.runShellCommand(deviceId, [\n        'cat', '/proc/net/unix',\n      ])).split('\\n').filter((line) => {\n        // The RDP unix socket is expected to be a path in the form:\n        //   /data/data/org.mozilla.fennec_rpl/firefox-debugger-socket\n        return line.trim().endsWith(`${apk}/firefox-debugger-socket`);\n      });\n\n      if (rdpUnixSockets.length === 0) {\n        await new Promise((resolve) => setTimeout(resolve, retryInterval));\n      }\n    }\n\n    // Convert into an array of unix socket filenames.\n    rdpUnixSockets = rdpUnixSockets.map((line) => {\n      return line.trim().split(/\\s/).pop();\n    });\n\n    if (rdpUnixSockets.length > 1) {\n      throw new WebExtError(\n        'Unexpected multiple RDP sockets: ' +\n        `${JSON.stringify(rdpUnixSockets)}`\n      );\n    }\n\n    return rdpUnixSockets[0];\n  }\n\n  async setupForward(deviceId: string, remote: string, local: string) {\n    const {adbClient} = this;\n\n    // TODO(rpl): we should use adb.listForwards and reuse the existing one if any (especially\n    // because adbkit doesn't seem to support `adb forward --remote` yet).\n    log.debug(`Configuring ADB forward for ${deviceId}: ${remote} -> ${local}`);\n\n    await wrapADBCall(async () => {\n      await adbClient.forward(deviceId, local, remote);\n    });\n  }\n}\n","/* @flow */\nimport {fs} from 'mz';\nimport mkdirp from 'mkdirp';\nimport promisify from 'es6-promisify';\n\nimport {UsageError, isErrorWithCode} from '../errors';\nimport {createLogger} from './logger';\n\nconst log = createLogger(__filename);\n\nconst defaultAsyncMkdirp = promisify(mkdirp);\nconst defaultAsyncFsAccess = fs.access.bind(fs);\n\ntype PrepareArtifactsDirOptions = {\n  asyncMkdirp?: typeof defaultAsyncMkdirp,\n  asyncFsAccess?: typeof defaultAsyncFsAccess,\n}\n\nexport async function prepareArtifactsDir(\n  artifactsDir: string,\n  {\n    asyncMkdirp = defaultAsyncMkdirp,\n    asyncFsAccess = defaultAsyncFsAccess,\n  }: PrepareArtifactsDirOptions = {},\n): Promise<string> {\n  try {\n    const stats = await fs.stat(artifactsDir);\n    if (!stats.isDirectory()) {\n      throw new UsageError(\n        `--artifacts-dir=\"${artifactsDir}\" exists but it is not a directory.`);\n    }\n    // If the artifactsDir already exists, check that we have the write permissions on it.\n    try {\n      await asyncFsAccess(artifactsDir, fs.W_OK);\n    } catch (accessErr) {\n      if (isErrorWithCode('EACCES', accessErr)) {\n        throw new UsageError(\n          `--artifacts-dir=\"${artifactsDir}\" exists but the user lacks ` +\n          'permissions on it.');\n      } else {\n        throw accessErr;\n      }\n    }\n  } catch (error) {\n    if (isErrorWithCode('EACCES', error)) {\n      // Handle errors when the artifactsDir cannot be accessed.\n      throw new UsageError(\n        `Cannot access --artifacts-dir=\"${artifactsDir}\" because the user ` +\n        `lacks permissions: ${error}`);\n    } else if (isErrorWithCode('ENOENT', error)) {\n      // Create the artifact dir if it doesn't exist yet.\n      try {\n        log.debug(`Creating artifacts directory: ${artifactsDir}`);\n        await asyncMkdirp(artifactsDir);\n      } catch (mkdirErr) {\n        if (isErrorWithCode('EACCES', mkdirErr)) {\n          // Handle errors when the artifactsDir cannot be created for lack of permissions.\n          throw new UsageError(\n            `Cannot create --artifacts-dir=\"${artifactsDir}\" because the ` +\n            `user lacks permissions: ${mkdirErr}`);\n        } else {\n          throw mkdirErr;\n        }\n      }\n    } else {\n      throw error;\n    }\n  }\n\n  return artifactsDir;\n}\n","/* @flow */\nimport defaultNotifier from 'node-notifier';\n\nimport {createLogger} from './logger';\nimport type {Logger} from './logger';\n\nconst defaultLog = createLogger(__filename);\n\nexport type DesktopNotificationsParams = {|\n  title: string,\n  message: string,\n  icon?: string,\n|};\n\nexport type DesktopNotificationsOptions = {|\n  notifier?: typeof defaultNotifier,\n  log?: Logger,\n|};\n\nexport function showDesktopNotification(\n  {\n    title, message, icon,\n  }: DesktopNotificationsParams,\n  {\n    notifier = defaultNotifier,\n    log = defaultLog,\n  }: DesktopNotificationsOptions = {}\n): Promise<void> {\n\n  return new Promise((resolve, reject) => {\n    notifier.notify({title, message, icon}, (err, res) => {\n      if (err) {\n        log.debug(`Desktop notifier error: ${err.message},` +\n                 ` response: ${res}`);\n        reject(err);\n      } else {\n        resolve();\n      }\n    });\n  });\n}\n","/* @flow */\nimport {fs} from 'mz';\n\nimport {isErrorWithCode} from '../errors';\n\ntype FileExistsOptions = {|\n  fileIsReadable: (filePath: string) => Promise<boolean>,\n|};\n\n/*\n * Resolves true if the path is a readable file.\n *\n * Usage:\n *\n * const exists = await fileExists(filePath);\n * if (exists) {\n *   // ...\n * }\n *\n * */\nexport default async function fileExists(\n  path: string,\n  {\n    fileIsReadable = (f) => fs.access(f, fs.constants.R_OK),\n  }: FileExistsOptions = {}\n): Promise<boolean> {\n  try {\n    await fileIsReadable(path);\n    const stat = await fs.stat(path);\n    return stat.isFile();\n  } catch (error) {\n    if (isErrorWithCode(['EACCES', 'ENOENT'], error)) {\n      return false;\n    }\n    throw error;\n  }\n}\n","/* @flow */\nimport path from 'path';\n\nimport multimatch from 'multimatch';\n\nimport {createLogger} from './logger';\n\nconst log = createLogger(__filename);\n\n// check if target is a sub directory of src\nexport const isSubPath = (src: string, target: string): boolean => {\n  const relate = path.relative(src, target);\n  // same dir\n  if (!relate) {\n    return false;\n  }\n  if (relate === '..') {\n    return false;\n  }\n  return !relate.startsWith(`..${path.sep}`);\n};\n\n// FileFilter types and implementation.\n\nexport type FileFilterOptions = {|\n  baseIgnoredPatterns?: Array<string>,\n  ignoreFiles?: Array<string>,\n  sourceDir: string,\n  artifactsDir?: string,\n|};\n\n/*\n * Allows or ignores files.\n */\nexport class FileFilter {\n  filesToIgnore: Array<string>;\n  sourceDir: string;\n\n  constructor({\n    baseIgnoredPatterns = [\n      '**/*.xpi',\n      '**/*.zip',\n      '**/.*', // any hidden file and folder\n      '**/.*/**/*', // and the content inside hidden folder\n      '**/node_modules',\n      '**/node_modules/**/*',\n    ],\n    ignoreFiles = [],\n    sourceDir,\n    artifactsDir,\n  }: FileFilterOptions = {}) {\n    sourceDir = path.resolve(sourceDir);\n\n    this.filesToIgnore = [];\n    this.sourceDir = sourceDir;\n\n    this.addToIgnoreList(baseIgnoredPatterns);\n    if (ignoreFiles) {\n      this.addToIgnoreList(ignoreFiles);\n    }\n    if (artifactsDir && isSubPath(sourceDir, artifactsDir)) {\n      artifactsDir = path.resolve(artifactsDir);\n      log.debug(\n        `Ignoring artifacts directory \"${artifactsDir}\" ` +\n        'and all its subdirectories'\n      );\n      this.addToIgnoreList([\n        artifactsDir,\n        path.join(artifactsDir, '**', '*'),\n      ]);\n    }\n  }\n\n  /**\n   *  Resolve relative path to absolute path with sourceDir.\n   */\n  resolveWithSourceDir(file: string): string {\n    const resolvedPath = path.resolve(this.sourceDir, file);\n    log.debug(\n      `Resolved path ${file} with sourceDir ${this.sourceDir} ` +\n      `to ${resolvedPath}`\n    );\n    return resolvedPath;\n  }\n\n  /**\n   *  Insert more files into filesToIgnore array.\n   */\n  addToIgnoreList(files: Array<string>) {\n    for (const file of files) {\n      if (file.charAt(0) === '!') {\n        const resolvedFile = this.resolveWithSourceDir(file.substr(1));\n        this.filesToIgnore.push(`!${resolvedFile}`);\n      } else {\n        this.filesToIgnore.push(this.resolveWithSourceDir(file));\n      }\n    }\n  }\n\n  /*\n   * Returns true if the file is wanted.\n   *\n   * If filePath does not start with a slash, it will be treated as a path\n   * relative to sourceDir when matching it against all configured\n   * ignore-patterns.\n   *\n   * Example: this is called by zipdir as wantFile(filePath) for each\n   * file in the folder that is being archived.\n   */\n  wantFile(filePath: string): boolean {\n    const resolvedPath = this.resolveWithSourceDir(filePath);\n    const matches = multimatch(resolvedPath, this.filesToIgnore);\n    if (matches.length > 0) {\n      log.debug(`FileFilter: ignoring file ${resolvedPath}`);\n      return false;\n    }\n    return true;\n  }\n}\n\n// a helper function to make mocking easier\n\nexport const createFileFilter = (\n  (params: FileFilterOptions): FileFilter => new FileFilter(params)\n);\n\nexport type FileFilterCreatorFn = typeof createFileFilter;\n","/* @flow */\nimport {fs} from 'mz';\n\nimport {onlyErrorsWithCode} from '../errors';\n\n/*\n * Resolves true if the path is a readable directory.\n *\n * Usage:\n *\n * isDirectory('/some/path')\n *  .then((dirExists) => {\n *    // dirExists will be true or false.\n *  });\n *\n * */\nexport default function isDirectory(path: string): Promise<boolean> {\n  return fs.stat(path)\n    .then((stats) => stats.isDirectory())\n    .catch(onlyErrorsWithCode(['ENOENT', 'ENOTDIR'], () => {\n      return false;\n    }));\n}\n","/* @flow */\nimport bunyan, {nameFromLevel, createLogger as defaultLogCreator}\n  from 'bunyan';\n\n\n// Bunyan-related Flow types\n\nexport type TRACE = 10;\nexport type DEBUG = 20;\nexport type INFO = 30;\nexport type WARN = 40;\nexport type ERROR = 50;\nexport type FATAL = 60;\n\nexport type BunyanLogLevel =\n  TRACE | DEBUG | INFO | WARN | ERROR | FATAL;\n\nexport type BunyanLogEntry = {|\n  name: string,\n  msg: string,\n  level: BunyanLogLevel,\n|};\n\nexport type Logger = {\n  debug: (msg: string, ...args: any) => void,\n  error: (msg: string, ...args: any) => void,\n  info: (msg: string, ...args: any) => void,\n  warn: (msg: string, ...args: any) => void,\n};\n\n\n// ConsoleStream types and implementation.\n\nexport type ConsoleStreamParams = {|\n  verbose?: boolean,\n|};\n\nexport type ConsoleOptions = {|\n  localProcess?: typeof process,\n|};\n\nexport class ConsoleStream {\n  verbose: boolean;\n  isCapturing: boolean;\n  capturedMessages: Array<string>;\n\n  constructor({verbose = false}: ConsoleStreamParams = {}) {\n    this.verbose = verbose;\n    this.isCapturing = false;\n    this.capturedMessages = [];\n  }\n\n  format({name, msg, level}: BunyanLogEntry): string {\n    const prefix = this.verbose ? `[${name}][${nameFromLevel[level]}] ` : '';\n    return `${prefix}${msg}\\n`;\n  }\n\n  makeVerbose() {\n    this.verbose = true;\n  }\n\n  write(\n    packet: BunyanLogEntry,\n    {localProcess = process}: ConsoleOptions = {}\n  ): void {\n    const thisLevel: BunyanLogLevel = this.verbose ? bunyan.TRACE : bunyan.INFO;\n    if (packet.level >= thisLevel) {\n      const msg = this.format(packet);\n      if (this.isCapturing) {\n        this.capturedMessages.push(msg);\n      } else {\n        localProcess.stdout.write(msg);\n      }\n    }\n  }\n\n  startCapturing() {\n    this.isCapturing = true;\n  }\n\n  stopCapturing() {\n    this.isCapturing = false;\n    this.capturedMessages = [];\n  }\n\n  flushCapturedLogs({localProcess = process}: ConsoleOptions = {}) {\n    for (const msg of this.capturedMessages) {\n      localProcess.stdout.write(msg);\n    }\n    this.capturedMessages = [];\n  }\n}\n\nexport const consoleStream = new ConsoleStream();\n\n\n// createLogger types and implementation.\n\nexport type BunyanStreamConfig = {|\n  type: string,\n  stream: ConsoleStream,\n|};\n\nexport type CreateBunyanLogParams = {|\n  name: string,\n  level: BunyanLogLevel,\n  streams: Array<BunyanStreamConfig>,\n|};\n\nexport type CreateBunyanLogFn = (params: CreateBunyanLogParams) => Logger;\n\nexport type CreateLoggerOptions = {|\n  createBunyanLog: CreateBunyanLogFn,\n|};\n\nexport function createLogger(\n  filename: string,\n  {createBunyanLog = defaultLogCreator}: CreateLoggerOptions = {}\n): Logger {\n  return createBunyanLog({\n    // Strip the leading src/ from file names (which is in all file names) to\n    // make the name less redundant.\n    name: filename.replace(/^src\\//, ''),\n    // Capture all log levels and let the stream filter them.\n    level: bunyan.TRACE,\n    streams: [{\n      type: 'raw',\n      stream: consoleStream,\n    }],\n  });\n}\n","/* @flow */\nimport path from 'path';\n\nimport {fs} from 'mz';\nimport parseJSON from 'parse-json';\nimport stripJsonComments from 'strip-json-comments';\n\nimport {InvalidManifest} from '../errors';\nimport {createLogger} from './logger';\n\nconst log = createLogger(__filename);\n\n\n// getValidatedManifest helper types and implementation\n\nexport type ExtensionManifestApplications = {|\n  gecko: {|\n    id?: string,\n    strict_min_version?: string,\n    strict_max_version?: string,\n    update_url?: string,\n  |},\n|};\n\nexport type ExtensionManifest = {|\n  name: string,\n  version: string,\n  default_locale?: string,\n  applications?: ExtensionManifestApplications,\n|};\n\nexport default async function getValidatedManifest(\n  sourceDir: string\n): Promise<ExtensionManifest> {\n  const manifestFile = path.join(sourceDir, 'manifest.json');\n  log.debug(`Validating manifest at ${manifestFile}`);\n\n  let manifestContents;\n\n  try {\n    manifestContents = await fs.readFile(manifestFile, {encoding: 'utf-8'});\n  } catch (error) {\n    throw new InvalidManifest(\n      `Could not read manifest.json file at ${manifestFile}: ${error}`);\n  }\n\n  let manifestData;\n\n  try {\n    manifestData = parseJSON(stripJsonComments(manifestContents), manifestFile);\n  } catch (error) {\n    throw new InvalidManifest(\n      `Error parsing manifest.json at ${manifestFile}: ${error}`);\n  }\n\n  const errors = [];\n  // This is just some basic validation of what web-ext needs, not\n  // what Firefox will need to run the extension.\n  // TODO: integrate with the addons-linter for actual validation.\n  if (!manifestData.name) {\n    errors.push('missing \"name\" property');\n  }\n  if (!manifestData.version) {\n    errors.push('missing \"version\" property');\n  }\n\n  if (manifestData.applications && !manifestData.applications.gecko) {\n    // Since the applications property only applies to gecko, make\n    // sure 'gecko' exists when 'applications' is defined. This should\n    // make introspection of gecko properties easier.\n    errors.push('missing \"applications.gecko\" property');\n  }\n\n  if (errors.length) {\n    throw new InvalidManifest(\n      `Manifest at ${manifestFile} is invalid: ${errors.join('; ')}`);\n  }\n\n  return manifestData;\n}\n\n\nexport function getManifestId(manifestData: ExtensionManifest): string | void {\n  return manifestData.applications ?\n    manifestData.applications.gecko.id : undefined;\n}\n","/* @flow */\n\nimport type {Readable} from 'stream';\n\nexport function isTTY(stream: Readable): boolean {\n  // $FLOW_FIXME: flow complains that stream may not provide isTTY as a property.\n  return stream.isTTY;\n}\n\nexport function setRawMode(stream: Readable, rawMode: boolean) {\n  // $FLOW_FIXME: flow complains that stdin may not provide setRawMode.\n  stream.setRawMode(rawMode);\n}\n","/* @flow */\nimport tmp from 'tmp';\nimport promisify from 'es6-promisify';\n\nimport {createLogger} from './logger';\n\nconst log = createLogger(__filename);\n\nexport type MakePromiseCallback = (tmpDir: TempDir) => any;\n\n\n/*\n * Work with a self-destructing temporary directory in a promise chain.\n *\n * The directory will be destroyed when the promise chain is finished\n * (whether there was an error or not).\n *\n * Usage:\n *\n * withTempDir(\n *   (tmpDir) =>\n *     doSomething(tmpDir.path())\n *     .then(...)\n * );\n *\n */\nexport function withTempDir(makePromise: MakePromiseCallback): Promise<any> {\n  const tmpDir = new TempDir();\n  return tmpDir.create()\n    .then(() => {\n      return makePromise(tmpDir);\n    })\n    .catch(tmpDir.errorHandler())\n    .then(tmpDir.successHandler());\n}\n\n/*\n * Work with a self-destructing temporary directory object.\n *\n * It is safer to use withTempDir() instead but if you know\n * what you're doing you can use it directly like:\n *\n * let tmpDir = new TempDir();\n * tmpDir.create()\n *   .then(() => {\n *     // work with tmpDir.path()\n *   })\n *   .catch(tmpDir.errorHandler())\n *   .then(tmpDir.successHandler());\n *\n */\nexport class TempDir {\n  _path: string | void;\n  _removeTempDir: Function | void;\n\n  constructor() {\n    this._path = undefined;\n    this._removeTempDir = undefined;\n  }\n\n  /*\n   * Returns a promise that is fulfilled when the temp directory has\n   * been created.\n   */\n  create(): Promise<TempDir> {\n    const createTempDir = promisify(tmp.dir, {multiArgs: true});\n    return createTempDir(\n      {\n        prefix: 'tmp-web-ext-',\n        // This allows us to remove a non-empty tmp dir.\n        unsafeCleanup: true,\n      })\n      .then((args) => {\n        const [tmpPath, removeTempDir] = args;\n        this._path = tmpPath;\n        this._removeTempDir = removeTempDir;\n        log.debug(`Created temporary directory: ${this.path()}`);\n        return this;\n      });\n  }\n\n  /*\n   * Get the absolute path of the temp directory.\n   */\n  path(): string {\n    if (!this._path) {\n      throw new Error('You cannot access path() before calling create()');\n    }\n    return this._path;\n  }\n\n  /*\n   * Returns a callback that will catch an error, remove\n   * the temporary directory, and throw the error.\n   *\n   * This is intended for use in a promise like\n   * Promise().catch(tmp.errorHandler())\n   */\n  errorHandler(): Function {\n    return (error) => {\n      this.remove();\n      throw error;\n    };\n  }\n\n  /*\n   * Returns a callback that will remove the temporary direcotry.\n   *\n   * This is intended for use in a promise like\n   * Promise().then(tmp.successHandler())\n   */\n  successHandler(): Function {\n    return (promiseResult) => {\n      this.remove();\n      return promiseResult;\n    };\n  }\n\n  /*\n   * Remove the temp directory.\n   */\n  remove() {\n    if (!this._removeTempDir) {\n      return;\n    }\n    log.debug(`Removing temporary directory: ${this.path()}`);\n    this._removeTempDir && this._removeTempDir();\n  }\n\n}\n","/* @flow */\nimport defaultUpdateNotifier from 'update-notifier';\n\ntype CheckForUpdatesParams = {|\n  version: string,\n  updateNotifier?: typeof defaultUpdateNotifier,\n|};\n\nexport function checkForUpdates(\n  {\n    version,\n    updateNotifier = defaultUpdateNotifier,\n  }: CheckForUpdatesParams\n) {\n  const pkg = {name: 'web-ext', version};\n\n  updateNotifier({\n    pkg,\n    updateCheckInterval: 1000 * 60 * 60 * 24 * 3, // 3 days,\n  }).notify();\n}\n","/* @flow */\nimport zipDirModule from 'zip-dir';\nimport promisify from 'es6-promisify';\n\nexport const zipDir = promisify(zipDirModule);\n","/* @flow */\nimport Watchpack from 'watchpack';\nimport debounce from 'debounce';\n\nimport {createLogger} from './util/logger';\n\n\nconst log = createLogger(__filename);\n\n\n// onSourceChange types and implementation\n\nexport type ShouldWatchFn = (filePath: string) => boolean;\n\nexport type OnChangeFn = () => any;\n\nexport type OnSourceChangeParams = {|\n  sourceDir: string,\n  artifactsDir: string,\n  onChange: OnChangeFn,\n  shouldWatchFile: ShouldWatchFn,\n|};\n\n// NOTE: this fix an issue with flow and default exports (which currently\n// lose their type signatures) by explicitly declare the default export\n// signature. Reference: https://github.com/facebook/flow/issues/449\n// eslint-disable-next-line no-shadow\ndeclare function exports(params: OnSourceChangeParams): Watchpack;\n\nexport type OnSourceChangeFn = (params: OnSourceChangeParams) => Watchpack;\n\nexport default function onSourceChange(\n  {sourceDir, artifactsDir, onChange, shouldWatchFile}: OnSourceChangeParams\n): Watchpack {\n  // TODO: For network disks, we would need to add {poll: true}.\n  const watcher = new Watchpack();\n\n  const executeImmediately = true;\n  onChange = debounce(onChange, 1000, executeImmediately);\n\n  watcher.on('change', (filePath) => {\n    proxyFileChanges({artifactsDir, onChange, filePath, shouldWatchFile});\n  });\n\n  log.debug(`Watching for file changes in ${sourceDir}`);\n  watcher.watch([], [sourceDir], Date.now());\n\n  // TODO: support interrupting the watcher on Windows.\n  // https://github.com/mozilla/web-ext/issues/225\n  process.on('SIGINT', () => watcher.close());\n  return watcher;\n}\n\n\n// proxyFileChanges types and implementation.\n\nexport type ProxyFileChangesParams = {|\n  artifactsDir: string,\n  onChange: OnChangeFn,\n  filePath: string,\n  shouldWatchFile: ShouldWatchFn,\n|};\n\nexport function proxyFileChanges(\n  {artifactsDir, onChange, filePath, shouldWatchFile}: ProxyFileChangesParams\n): void {\n  if (filePath.indexOf(artifactsDir) === 0 || !shouldWatchFile(filePath)) {\n    log.debug(`Ignoring change to: ${filePath}`);\n  } else {\n    log.debug(`Changed: ${filePath}`);\n    log.debug(`Last change detection: ${(new Date()).toTimeString()}`);\n    onChange();\n  }\n}\n","module.exports = require(\"adbkit\");","module.exports = require(\"addons-linter\");","module.exports = require(\"bunyan\");","module.exports = require(\"camelcase\");","module.exports = require(\"child_process\");","module.exports = require(\"colors\");","module.exports = require(\"debounce\");","module.exports = require(\"decamelize\");","module.exports = require(\"es6-error\");","module.exports = require(\"es6-promise\");","module.exports = require(\"es6-promisify\");","module.exports = require(\"event-to-promise\");","module.exports = require(\"events\");","module.exports = require(\"firefox-profile\");","module.exports = require(\"fs\");","module.exports = require(\"fx-runner\");","module.exports = require(\"git-rev-sync\");","module.exports = require(\"js-select\");","module.exports = require(\"mkdirp\");","module.exports = require(\"multimatch\");","module.exports = require(\"mz\");","module.exports = require(\"net\");","module.exports = require(\"node-notifier\");","module.exports = require(\"opn\");","module.exports = require(\"os\");","module.exports = require(\"parse-json\");","module.exports = require(\"path\");","module.exports = require(\"readline\");","module.exports = require(\"require-uncached\");","module.exports = require(\"sign-addon\");","module.exports = require(\"strip-json-comments\");","module.exports = require(\"tmp\");","module.exports = require(\"update-notifier\");","module.exports = require(\"watchpack\");","module.exports = require(\"yargs\");","module.exports = require(\"zip-dir\");"],"sourceRoot":""}